<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAT Onboard</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    .animate-bounce-dot { animation: bounce 1.4s ease-in-out infinite; }
    .prose strong { font-weight: 600; }
    .prose blockquote { border-left: 3px solid #3b82f6; padding-left: 1rem; margin: 0.5rem 0; background: #eff6ff; padding: 0.75rem 1rem; border-radius: 0.5rem; }
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
    .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
    .prose li { margin: 0.25rem 0; }
    .prose p { margin: 0.5rem 0; }
    .prose code { background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; }
    .prose pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.75rem 0; white-space: pre-wrap; word-break: break-word; }
    .prose pre code { background: transparent; padding: 0; color: inherit; font-size: 0.8125rem; }
    .prose { overflow-wrap: break-word; word-break: break-word; }
    .prose h1 { font-size: 1.5rem; font-weight: 700; margin: 1.5rem 0 0.75rem; color: #1e293b; }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin: 1.25rem 0 0.5rem; color: #334155; }
    .prose h3 { font-size: 1.1rem; font-weight: 600; margin: 1rem 0 0.5rem; color: #475569; }
    .prose table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; font-size: 0.875rem; }
    .prose thead th { background: #f8fafc; text-align: left; padding: 0.625rem 0.75rem; border: 1px solid #e2e8f0; font-weight: 600; color: #475569; }
    .prose tbody td { padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; }
    .prose tbody tr:hover { background: #f8fafc; }
    .prose hr { border: none; border-top: 1px solid #e2e8f0; margin: 1.25rem 0; }
    .prose a { color: #2563eb; text-decoration: underline; }
    .prose a:hover { color: #1d4ed8; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    @keyframes slideOutRight {
      from { transform: translateX(0); }
      to { transform: translateX(100%); }
    }
    .slide-in-right { animation: slideInRight 0.3s ease-out forwards; }
    .slide-out-right { animation: slideOutRight 0.3s ease-in forwards; }
    /* Glossary term auto-highlight */
    .glossary-term {
      color: #2563eb;
      border-bottom: 1px dotted #93c5fd;
      cursor: help;
      display: inline;
    }
    /* Singleton tooltip portal */
    #glossary-tooltip-portal {
      display: none;
      position: fixed;
      background: #1e293b;
      color: #f1f5f9;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.8125rem;
      line-height: 1.5;
      width: max-content;
      max-width: 300px;
      z-index: 9999;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    #glossary-tooltip-portal .gt-arrow {
      position: absolute;
      border: 5px solid transparent;
    }
    #glossary-tooltip-portal .gt-arrow.arrow-down {
      top: 100%;
      border-top-color: #1e293b;
    }
    #glossary-tooltip-portal .gt-arrow.arrow-up {
      bottom: 100%;
      border-bottom-color: #1e293b;
    }
    /* === UI Redesign: Login + Sidebar === */
    @keyframes loginEnter {
      from { opacity: 0; transform: translateY(24px) scale(0.97); }
      to   { opacity: 1; transform: translateY(0)    scale(1);    }
    }
    .login-card-animate { animation: loginEnter 0.55s cubic-bezier(0.34, 1.15, 0.64, 1) both; }
    @keyframes floatGlow {
      0%, 100% { transform: translateY(0px)   scale(1);    opacity: 0.13; }
      50%       { transform: translateY(-30px) scale(1.07); opacity: 0.21; }
    }
    .login-orb-1 { animation: floatGlow  9s ease-in-out infinite; }
    .login-orb-2 { animation: floatGlow 13s ease-in-out infinite 2.5s reverse; }
    /* Dark sidebar nav buttons */
    .sidebar-nav-btn {
      color: rgba(255,255,255,0.48);
      transition: color 0.18s ease, background-color 0.18s ease, box-shadow 0.18s ease;
    }
    .sidebar-nav-btn:hover:not(.sidebar-active) {
      color: rgba(255,255,255,0.82);
      background-color: rgba(255,255,255,0.07);
    }
    .sidebar-nav-btn.sidebar-active {
      color: #ffffff;
      background-color: rgba(0,102,204,0.72);
      box-shadow: 0 2px 12px rgba(0,102,204,0.38);
    }
    .sidebar-logout-btn {
      color: rgba(255,255,255,0.35);
      transition: color 0.18s ease, background-color 0.18s ease;
    }
    .sidebar-logout-btn:hover {
      color: #fc8181;
      background-color: rgba(239,68,68,0.11);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback, useMemo } = React;

    // ============================================================
    // CONFIGURATION
    // ============================================================

    const CONFIG = {
      firebase: {
        apiKey: "AIzaSyDZkoA8LLA6bWBOqEWjtlhiwI-YEUTkzkM",
        authDomain: "catsop-4000.firebaseapp.com",
        projectId: "catsop-4000",
        storageBucket: "catsop-4000.firebasestorage.app",
        messagingSenderId: "108408950707",
        appId: "1:108408950707:web:71cca3e44baa224dbc85c6",
        measurementId: "G-JXD8E32TZJ"
      }
    };

    // ============================================================
    // FIREBASE INITIALIZATION
    // ============================================================

    let db = null;
    let auth = null;
    try {
      if (CONFIG.firebase.apiKey && CONFIG.firebase.apiKey !== "YOUR_API_KEY") {
        const app = firebase.initializeApp(CONFIG.firebase);
        db = firebase.firestore();
        auth = firebase.auth();
      }
    } catch (e) {
      console.warn('Firebase not initialized — using placeholder config.', e);
    }

    // ============================================================
    // FIRESTORE CRUD HELPERS
    // ============================================================

    const FirestoreService = {
      _ensureDb() {
        if (!db) throw new Error('Database not available. Please refresh the page.');
      },

      // -- Helper: convert Firestore Timestamps to ISO strings --
      _convertTimestamps(data) {
        const result = { ...data };
        if (result.createdAt?.toDate) result.createdAt = result.createdAt.toDate().toISOString();
        if (result.updatedAt?.toDate) result.updatedAt = result.updatedAt.toDate().toISOString();
        return result;
      },

      // -- Generic CRUD --
      async getAll(collectionName) {
        this._ensureDb();
        const snapshot = await db.collection(collectionName).get();
        return snapshot.docs.map(doc => ({
          id: doc.id,
          ...this._convertTimestamps(doc.data())
        }));
      },

      async add(collectionName, data) {
        this._ensureDb();
        const { id, ...cleanData } = data;
        const docRef = await db.collection(collectionName).add({
          ...cleanData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        return docRef.id;
      },

      async update(collectionName, id, data) {
        this._ensureDb();
        const { id: _id, ...cleanData } = data;
        await db.collection(collectionName).doc(id).update({
          ...cleanData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      },

      async remove(collectionName, id) {
        this._ensureDb();
        await db.collection(collectionName).doc(id).delete();
      },

      // -- Clear: delete all documents in a collection --
      async clearCollection(collectionName) {
        this._ensureDb();
        const snapshot = await db.collection(collectionName).get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      },

      // -- Seed: write default data with specific doc IDs --
      async seedCollection(collectionName, items) {
        this._ensureDb();
        const batch = db.batch();
        items.forEach(item => {
          const { id, ...data } = item;
          const ref = db.collection(collectionName).doc(id);
          batch.set(ref, {
            ...data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
      },

      // -- SOP-specific --
      async getSOPs() { return this.getAll('sops'); },
      async saveSOP(data) { return this.add('sops', data); },
      async updateSOP(id, data) { return this.update('sops', id, data); },
      async deleteSOP(id) { return this.remove('sops', id); },

      // -- Glossary-specific --
      async getGlossary() { return this.getAll('glossary'); },
      async saveGlossaryEntry(data) { return this.add('glossary', data); },
      async updateGlossaryEntry(id, data) { return this.update('glossary', id, data); },
      async deleteGlossaryEntry(id) { return this.remove('glossary', id); },

      // -- Contacts-specific --
      async getContacts() { return this.getAll('contacts'); },
      async saveContact(data) { return this.add('contacts', data); },
      async updateContact(id, data) { return this.update('contacts', id, data); },
      async deleteContact(id) { return this.remove('contacts', id); },

      // -- Daily Tasks-specific --
      async getDailyTasks() { return this.getAll('dailyTasks'); },
      async saveDailyTask(data) { return this.add('dailyTasks', data); },
      async updateDailyTask(id, data) { return this.update('dailyTasks', id, data); },
      async deleteDailyTask(id) { return this.remove('dailyTasks', id); },

      // -- Knowledge Base-specific --
      async getKnowledgeBase() { return this.getAll('knowledgeBase'); },
      async saveKBArticle(data) { return this.add('knowledgeBase', data); },
      async updateKBArticle(id, data) { return this.update('knowledgeBase', id, data); },
      async deleteKBArticle(id) { return this.remove('knowledgeBase', id); },

      // -- Pricing-specific --
      async getPricing() { return this.getAll('pricing'); },
      async savePricingEntity(data) { return this.add('pricing', data); },
      async updatePricingEntity(id, data) { return this.update('pricing', id, data); },
      async deletePricingEntity(id) { return this.remove('pricing', id); },

      // -- Part Locations-specific --
      async getPartLocations() { return this.getAll('partLocations'); },
      async savePartLocation(data) { return this.add('partLocations', data); },
      async updatePartLocation(id, data) { return this.update('partLocations', id, data); },
      async deletePartLocation(id) { return this.remove('partLocations', id); },

      // -- Users --
      async upsertUser(uid, email) {
        this._ensureDb();
        const ADMIN_EMAIL = 'sep@aircat.dk';
        const ref = db.collection('users').doc(uid);
        const snap = await ref.get();
        if (!snap.exists) {
          await ref.set({
            email,
            role: email === ADMIN_EMAIL ? 'admin' : 'user',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } else {
          await ref.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
        }
        const updated = await ref.get();
        const data = updated.data();
        return { id: uid, ...data };
      },

      async getUsers() {
        this._ensureDb();
        const snapshot = await db.collection('users').orderBy('email').get();
        return snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            lastLogin: data.lastLogin?.toDate ? data.lastLogin.toDate().toISOString() : null,
            createdAt: data.createdAt?.toDate ? data.createdAt.toDate().toISOString() : null,
          };
        });
      },
    };

    // ============================================================
    // HELPER: RELATIVE TIME
    // ============================================================

    function timeAgo(dateString) {
      if (!dateString) return '';
      try {
        const date = typeof dateString === 'string' ? new Date(dateString) : dateString;
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;
        const diffDays = Math.floor(diffHours / 24);
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 30) return `${diffDays} days ago`;
        const diffMonths = Math.floor(diffDays / 30);
        return `${diffMonths} month${diffMonths > 1 ? 's' : ''} ago`;
      } catch { return ''; }
    }

    const formatSopNumber = (num) => `SOP-${String(num).padStart(3, '0')}`;
    const formatDtNumber = (num) => `DT-${String(num).padStart(3, '0')}`;
    const formatKbNumber = (num) => `KB-${String(num).padStart(3, '0')}`;

    // Process [[SOP-001]], [[DT-001]], [[KB-001]] cross-links in rendered HTML
    const processContentLinks = (html) => {
      return html.replace(/\[\[(SOP|DT|KB)-(\d{1,3})\]\]/g, (match, type, numStr) => {
        const num = parseInt(numStr);
        const label = `${type}-${String(num).padStart(3, '0')}`;
        return `<a href="#" data-crosslink-type="${type}" data-crosslink-number="${num}" class="inline-flex items-center gap-1 px-1.5 py-0.5 bg-blue-50 text-blue-600 font-mono text-sm font-semibold rounded hover:bg-blue-100 no-underline transition-colors cursor-pointer">${label}</a>`;
      });
    };

    // Escape HTML special characters for safe insertion into tooltips
    const escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

    // Auto-detect glossary terms in rendered HTML and wrap with hover tooltips
    const processGlossaryTerms = (html, glossaryItems) => {
      if (!glossaryItems || glossaryItems.length === 0) return html;

      // Sort by name length descending so longer terms match first (e.g. "U/S tag" before "U/S")
      const sorted = [...glossaryItems].sort((a, b) => b.name.length - a.name.length);

      // Track matched terms (first occurrence only)
      const matched = new Set();

      // Process a text node — find and wrap glossary matches
      // Uses segments to protect inserted HTML from being matched by subsequent terms
      const processTextNode = (text) => {
        let segments = [{ t: text, p: false }]; // t=text, p=protected
        for (const item of sorted) {
          if (matched.has(item.id)) continue;

          const escapedName = item.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const flags = item.type === 'abbreviation' ? '' : 'i';
          const regex = new RegExp(`\\b${escapedName}\\b`, flags);

          let found = false;
          const next = [];
          for (const seg of segments) {
            if (seg.p || found) { next.push(seg); continue; }
            const m = seg.t.match(regex);
            if (m) {
              found = true;
              matched.add(item.id);
              const matchedText = m[0];
              const idx = m.index;
              const attrs = ` data-g-name="${escapeHtml(item.name)}" data-g-meaning="${escapeHtml(item.meaning)}"${item.context ? ` data-g-context="${escapeHtml(item.context)}"` : ''}`;
              const replacement = `<span class="glossary-term"${attrs}>${matchedText}</span>`;
              if (idx > 0) next.push({ t: seg.t.substring(0, idx), p: false });
              next.push({ t: replacement, p: true });
              const after = idx + matchedText.length;
              if (after < seg.t.length) next.push({ t: seg.t.substring(after), p: false });
            } else {
              next.push(seg);
            }
          }
          segments = next;
        }
        return segments.map(s => s.t).join('');
      };

      // Split HTML into tags and text segments, only process text outside skip-tags
      const parts = html.split(/(<[^>]+>)/);
      const skipTags = ['code', 'pre', 'a'];
      let skipDepth = 0;

      const processed = parts.map(part => {
        if (part.startsWith('<')) {
          for (const tag of skipTags) {
            if (new RegExp(`^<${tag}[\\s>]`, 'i').test(part)) skipDepth++;
            else if (new RegExp(`^</${tag}>`, 'i').test(part)) skipDepth = Math.max(0, skipDepth - 1);
          }
          return part;
        }
        if (skipDepth > 0) return part;
        return processTextNode(part);
      });

      return processed.join('');
    };

    // ============================================================
    // SHARED UI HELPERS
    // ============================================================

    // Parse Markdown to HTML with sanitization (shared by chat, wizard, and content viewers)
    const renderMarkdown = (md) => {
      try { return DOMPurify.sanitize(marked.parse(md)); }
      catch { return md; }
    };

    // Render Markdown content with cross-links and glossary highlights
    const renderRichContent = (content, glossary, onClickHandler) => {
      try {
        const html = processGlossaryTerms(processContentLinks(marked.parse(content)), glossary);
        return <div className="prose" dangerouslySetInnerHTML={{ __html: html }} onClick={onClickHandler} />;
      } catch {
        return <div className="whitespace-pre-wrap text-gray-700">{content}</div>;
      }
    };

    // Cross-link click handler factory for content pages (SOP, DT, KB)
    const createCrossLinkHandler = (ownType, findByNumber, selectItem, onCrossLink) => {
      return (e) => {
        const link = e.target.closest('[data-crosslink-type]');
        if (link) {
          e.preventDefault();
          const type = link.getAttribute('data-crosslink-type');
          const number = parseInt(link.getAttribute('data-crosslink-number'));
          if (type === ownType) {
            const target = findByNumber(number);
            if (target) selectItem(target);
          } else if (onCrossLink) {
            onCrossLink(type, number);
          }
        }
      };
    };

    // Expand/Collapse toggle button (shared by SOP, DT, KB, and Ask CAT pages)
    function ExpandToggleButton({ isExpanded, onToggle }) {
      return (
        <button
          onClick={onToggle}
          className="flex items-center gap-2 px-3.5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors"
        >
          {isExpanded ? (
            <React.Fragment>
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" /></svg>
              Collapse view
            </React.Fragment>
          ) : (
            <React.Fragment>
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
              Expand view
            </React.Fragment>
          )}
        </button>
      );
    }

    // Reusable SVG icon components for common actions
    function SearchIcon({ className = "w-4 h-4" }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>;
    }
    function EditIcon({ className = "w-4 h-4" }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>;
    }
    function DeleteIcon({ className = "w-4 h-4" }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
    }
    function CloseIcon({ className = "w-5 h-5" }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
    }
    function EmptyStateIcon({ className = "w-10 h-10" }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
    }

    // Hook: close modal on Escape key
    function useEscapeKey(onClose) {
      useEffect(() => {
        const handler = (e) => { if (e.key === 'Escape') onClose(); };
        document.addEventListener('keydown', handler);
        return () => document.removeEventListener('keydown', handler);
      }, [onClose]);
    }

    // ============================================================
    // DEFAULT SOP DATA
    // ============================================================

    const DEFAULT_SOPS = [
      {
        id: 'sop-sharepoint',
        sopNumber: 1,
        title: 'Using SharePoint',
        category: 'Systems',
        updatedAt: new Date().toISOString(),
        content: `Using SharePoint

SharePoint is our hub for shared data and information. SharePoint can be accessed via this link: https://aircat1.sharepoint.com/sites/TekniskAfdeling

1. Navigation:
On the top of the SharePoint site are all the menu points you need to know. On the front page you will see the CAT Bulletin, which is where we post internal news.

Tip: If you need to extend a sub-menu (indicated by an arrow symbol), hover the mouse over the arrow symbol to reveal the sub-menus. Don't click on the arrow symbol, as this will lead you to the parent directory instead.

2. Departments Menu:
This is the file browser which allows you to look through our internal files. The view is access based, so in case you can't see specific folders or directories, it is because you don't have the sufficient permissions on the platform.

It is not preferred to use this function for browsing files, as we have access to the same directory directly from our PC's file browser.

3. Tool/Material Request Menu:
This is where anyone can request to order non-aircraft related things. This can be tools, work wear, facility materials or something else entirely.

We ask that all purchasing requests go through this channel to avoid Post-it notes and verbal agreements, which is impossible to follow up on for anyone not involved.

To submit a request: click the Send New Request menu point. A new window with a simple formula will open. Enter all the data for the purchase you want to request, and then click submit.

When you submit the request, a notification is sent to the logistics team who will then pick it up from there.

To see the status of your request: click the See Request Status menu point. This will show you a list of all Active Requests. To see completed requests, you can click the Completed Requests tab on the right.

A request is only completed once the ordered item has been physically received.

When logistics has acknowledged and ordered your requested item, the leftmost Status column will be updated from Not Ordered to Ordered. Any additional comments will be displayed in the Comment column.

Purchasing and updating: We must strive to only order these items from our list of approved suppliers. Often the mechanics will find specific products online and insert a link. If our approved suppliers don't have the specifically requested product, you will have to liaise with the person who made the request and find a product or other solution from our approved suppliers.

We mainly use DMT Værktøj, Würth, Biltema, Stark and Lomax for procuring non-aircraft items, as we have VAT-exempt purchasing accounts with these suppliers.

Once you have actioned a request, you have to update the ordered-status of the request, and write a small comment with the current status. This is done by double clicking on a request in the list, and you can then scroll down to the Comment field and add your initials and a comment. Example: "SEP: Ordered from Würth on 01/01/2026".

Remember to update the requests Received status from No to Yes once received.

4. Links:
This is where we have a collection of links that can be useful for the entire department.

5. Information Hub:
The Information Hub has 4 sub menus:

Aeroshell Product List: This is a simple look-up table where we have listed all our internal part numbers for all Aeroshell products. This is useful if you are having trouble identifying a part number for a specific Aeroshell product in a specific quantity or packaging.

Passwords: This is our master list of passwords for all websites where we have a login. This list is strictly used by CAT employees and should never be shared. If you update login credentials to a specific website, remember to update this sheet.

Safety Data Sheets: This shows the login credentials and access link to our Material Safety Data Sheets database.

Service Supplier List: This list is used as an index of all external service suppliers. This pertains to everything not directly aircraft related, e.g. facility maintenance, tool rent and maintenance or service vehicle maintenance. Remember to update this list if you start work with a new supplier.`
      },
      {
        id: 'sop-goods-receiving',
        sopNumber: 2,
        title: 'Goods Receiving',
        category: 'Logistics',
        updatedAt: new Date().toISOString(),
        content: `Goods Receiving

The below SOP pertains to importing goods into the AMS system if they are ordered and received from within the EU. If you are receiving a shipment from a non-EU country, please read the SOP for "Import and End-Use Certification".

1. Physical inspection:
Do a quick visual check for damages to the shipping box. If no major or noteworthy exterior damage to the shipping box is noted, you can proceed with opening the box.

Remove the part(s) and paperwork. If you have purchased multiple items, it's a good idea to do a little sorting by bundling the items and paperwork together. This makes it easier for you in the system receiving phase.

If you have ordered a serialized item, you need to do a visual check on the physical part to confirm that the PN and SN are the same as stated on the included paperwork.

Check the included paperwork (for each item), and ensure that the part was delivered with the required paperwork (Certificate of Compliance, or EASA Form 1 / FAA 8130-3) and that the specific item is listed on the paperwork.

If all the above things are good, you can proceed to step 2.

2. Receiving in the system:
Start by picking an item you want to receive. Then scan the paperwork related to the item. The scanned document in the scan folder then needs to be renamed to the cert type and ID (e.g. EASA 123-ABC.pdf).

Open AMS, click on P.O. Manager > Purchase Order Receiving. You will now see a window listing all purchase orders with at least 1 item not received in the system. So if an order was placed for 100 items but only 99 has been received, they will appear in this window. As soon as all open items has successfully been received, they will disappear from this view.

Use the search function to find the relevant order, and then double-click on the order on the top window. This will open a view of the specific order which allows you to receive individual items with outstanding balances.

Locate the item line for the item you want to receive, then double click on the line.

You will be prompted with 2 pop-up windows for each item line:

2A. The first pop-up:
This pop-up asks that you enter how many units you are receiving, and if the part number is the same as what you ordered.

First you must enter the quantity you are receiving. The "Ordered quantity" line shows you how many total of that item line was ordered, and you then have to enter the quantity you are currently receiving in. In case of partial deliveries, you just enter the lower quantity than what was actually ordered, and the balance quantity will be pending until received.

It is sometimes necessary to receive an ordered part under an alternative part number, so in these cases it's important that you check off "Equivalent" and enter the alternative part number in the "Part number:" field. Always double check that the received part number is 100% correct, whether it's the original ordered PN or an alternative PN.

If you received the same PN as you ordered, you just enter the quantity that you are receiving and click "Save".

2B. The second pop-up:
This pop-up asks for import/customs related information. As mentioned in the beginning of this SOP, this pertains only to shipments from within the EU.

If you are receiving a part from a non-EU country, please read the SOP for "Import and End-Use Certification" before proceeding.

You are initially asked to enter a Release Note Number:

For EU shipments: Enter the certificate reference, which will be the same as you named the scanned PDF document (e.g. EASA 123-ABC or COC ABC-123).

Click OK to close this window and then click next.

For non-EU shipments: Ensure that you followed the import SOP, and then enter the customs case ID number (e.g. 2026142273756).

Click OK to close this window, and then navigate to the lower of the two windows (the one saying Waybill number).

We use this field to state whether the item was imported and released on either our End-Use license or the Airworthiness Release certificate. Click on "Add Waybill No" and you are prompted with another pop-up.

Here you must enter one of the two values with the exact same formatting as below:
- Parts released on End-Use certificate: END-USE
- Parts released on the airworthiness release: CERT

Click OK to close this pop-up, and the previous view should now show the values you entered; the release reference on the top and the waybill reference on the bottom.

Then click Next.

2C. Updating item data:
Note for serialized items: if you have ordered an item that is serialized, you will see another pop-up window asking for the serial number of the unit you are receiving.

You can read the SN off the paperwork - be sure and double check that the SN is entered correctly and exactly as it is on the paperwork/part.

Enter the SN and click next.

Your next view is the tracking number view. This is where you have all information related to a tracking number including Location, Price, Condition, Base, Expiration, and Doc.Manager.`
      },
      {
        id: 'sop-purchase-order',
        sopNumber: 3,
        title: 'Create Purchase Order',
        category: 'Purchasing',
        updatedAt: new Date().toISOString(),
        content: `Creating a Purchase Order

Below instructions goes through the steps required to cut a purchase order in AMS.

There are two different approaches, depending if you need to create the PO from an AMS requisition or not.

1. Create a New PO:
On the AMS home page, click P.O. Manager > Purchase Order Creation.

You will then be asked to choose the supplier. Find the supplier on the list and click OK.

2. Input Order Details:
Start by filling out the following information fields in the header:

Reference:
This is our internal reference, so we know what the parts are ordered for upon receiving. You can put in a tail number or specific task reference. If you are buying more parts for multiple purposes, you can write "See notes" in this field, and then write the individual references on the item lines.

PBH No.:
This field is only used if you are ordering contracted units from Aerotron to Airseven. You then select AERO2601-1 (this is the contract number for the Boeings).

Ship via:
- Orders from EU and UK: KN DHL account 303776815 for standard shipments.
- Orders from US: BWS FedEx account 776036331 for standard shipments.

If you have to utilize our freight forwarder or we are collecting an order ourselves, you can use "SELF COLLECT" or "TO BE ADVISED".

Ship to:
In most cases when ordering parts for CAT, the standard value (Copenhagen AirTaxi A/S) is correct and doesn't need to be changed. This will ensure delivery to Hangarvej B 2 in Roskilde.

When ordering parts for Airseven, we might need to drop-ship the parts directly to the aircraft where GMT's mechanic team is located. In these cases, you should look for 'GMT' and then the correct airport code:
- GMT BLL - Billund station
- GMT CPH - Copenhagen station
- GMT AAR - Aarhus station
- GMT AAL - Aalborg station

The rest of the fields are in most cases not required to fill out or change.

3. Input Item Lines:

3A. Adding item lines from the AMS requisition list:
In the bottom left corner of the window, you click Import > Import from requisition list. This opens a window that shows all open items on the requisition list. Click once to highlight the relevant item, and then click Export to P.O. in the bottom left corner. This will add the selected item to the purchase order, and it has to be done for each item.

3B. Adding item lines not from the AMS requisition list:
Start by clicking the Add Part button right below the item window, this opens a search window. Search for the part number you want to add to the item list. The search can be partial or complete.

Note: in case the part number isn't known and needs to be created, please follow the guide called "Creating New Parts".

When the correct part is displayed on the parts list to the right, click on it to highlight it and enter the quantity in the Qty field on the left, then click OK.

3C. Fill out condition and unit price:
When an item is successfully entered on the PO, it shows 13 columns where data can be entered. You should only need to fill out 2 or 3 of these fields:

Cond.: This is the condition of the part you are ordering. Double click the empty field to select from available conditions.

Un. Price: Unit price, this is our purchase price. Enter the price from the quote. Double check that the quoted currency matches the PO header.

Note: This is an internal field for references like tail number or short notes.

Qty: To change ordered quantity, highlight the item line and click the Qty Adjust button.

4. Finalize and send the Purchase Order:
When you have entered all details and the PO is ready to be sent, you click the Preview button in the bottom of the window.

This will prompt a Microsoft Word document with your new PO. The PO number is automatically assigned.

Print out the document, then write your signature and today's date.

4A. Placing the order via a supplier website:
Complete the order on the website, and remember to enter our PO number reference (e.g. CAT-1234) in the corresponding field.

4B. Placing the order via email:
Scan the signed PO, rename the file to the PO number (e.g. CAT-1234), attach to email with PO number in the subject line.

5. Archiving the Purchase Order Document:
Archive the PO document in the corresponding folder in the physical archive. Each folder contains 50 PO numbers. Stamp holes and file the PO document, maintaining chronological order (older on bottom, newer on top).`
      },
      {
        id: 'sop-import-enduse',
        sopNumber: 4,
        title: 'Import and End-Use Certification',
        category: 'Logistics',
        updatedAt: new Date().toISOString(),
        content: `Import and End-Use Certification

CAT holds an End-Use Certification, a legal document confirming we are the final users of our imports. This status allows us to trade and import parts without paying VAT. For non-EU imports, CAT acts as the official Importer of Record, meaning we must provide specific instructions to carriers to remain compliant with customs laws.

Choosing the Best Import Method

We have two ways to import parts VAT-free. We should always prioritize using the Airworthiness Release Certificate over our End-Use license whenever possible.

Priority 1: Airworthiness Release - This uses the part's own certification to qualify for VAT exemption. It reduces our administrative workload and legal audit footprint by using the part's documentation instead of our own license.

Priority 2: End-Use Certification - This is used for parts with lower levels of certification, such as a Certificate of Conformance, that are not automatically VAT-exempt.

Phase 1: Providing Customs Instructions (The Email Phase)

This phase happens before the shipment arrives at our facility. Both DHL and FedEx will send an email when a shipment lands in Denmark.

DHL (Automated):
DHL is set up with pre-provided instructions. They will automatically clear routine DHL Express shipments on our End-Use certification and send the import documents to our inbox. No manual action is required here.

FedEx (Manual Action Required):
FedEx holds shipments at their Danish hub and will not release them until they receive instructions from us.

1. Identify the Supplier: Open the attachment in the FedEx email to see who sent the part. You can usually see supplier and PO info on the paperwork to help you determine the right place to look.

2. Identify the Certificate: Determine if the part has an Airworthiness Release (e.g., FAA 8130-3) or just a CoC.

3. Reply to FedEx: Copy and paste the relevant instruction block below to release the shipment.

Template A: Airworthiness Release (Use if you have an EASA Form 1 or FAA 8130-3):
Importgrundlag/Anvendelse: Til reparation af egne fly (kommerciel luftfart). Venligst fortold med Luftdygtighedsattest.
Procedurecode: 4000 009
HS Code: 8807300099
Cert ref.: [Enter Type and Document ID here]
Præferencekode: 119

Template B: End-Use License (Use for consumables or parts with only a CoC):
Importgrundlag/Anvendelse: Til reparation af egne fly (kommerciel luftfart). Venligst fortold med vores END-USE bevilling.
Bevillingsnummer: DKEUS220561467
Procedurecode: 4000 962 (Momsfritaget import)
HS Code: 8807300010
Præferencekode: 140

Once the instructions have been sent to FedEx, we can expect to receive the "fuldstændig ekspres" documents within 1 to 2 weekdays, which should align with when the shipment arrives at our facility.

Phase 2: Physical Receiving (The System Phase)

This section pertains only to receiving non-EU shipments. Once the instructions are processed and the shipment is delivered to our facility, you can begin the system entry.

1. Check the Label: Confirm the country of origin. Proceed with the steps below if it is from a non-EU country.
2. Note the AWB: Copy the Carrier and Air Waybill (AWB) number from the physical box.
3. Perform Physical Receiving: Perform physical receiving and inspections as per the Goods Receiving SOP.
4. Search the Inbox: Search the shared email inbox for the AWB number to find the "fuldstændig ekspres" document.
5. Link to System: Locate and copy the Case ID and HS Code on the "fuldstændig ekspres" document.

Phase 3: Processing Customs Documentation in AMS

To finalize the receiving process in AMS, you must extract specific data from the "fuldstændig ekspres" document.

Locating the Case ID:
Find the field labeled "Referencenummer" on the document. The ID always starts with the current year (e.g., 2026142273756). This is the number you must input into the system.

Verifying the HS Code and Release Type:
Check the last two digits of the HS code (varekode) on the document to determine the correct release type for the system.

- Ending in 10: This indicates the shipment was released on our End-Use certification.
- Ending in 99: This indicates the shipment was released on the airworthiness release.

Entering Data into AMS:
When you have this information, you are ready to start the receiving process in AMS (referring to the goods receiving SOP). You must enter the Case ID and the correct release type in the fields when prompted.

- CERT: Select this option if the HS Code ends in 99. This means the part was imported and released from customs on the related airworthiness release.
- END-USE: Select this option if the HS Code ends in 10. This means the part was imported and released from customs on our End-Use license.

Handling Missing Customs Documents:

Occasionally, shipments may arrive at our facility before we receive the necessary "fuldstændig ekspres" documents from the carrier. This can stall the goods receiving process.

Requesting Missing Documents:
To resolve this, you must promptly contact the carrier's local customs office to request the documents.

- DHL CPH Customs: cphcus@dhl.com
- FedEx CPH Customs: cphgts@fedex.com

Email Format:
When sending the request, use the following format for the subject line. You do not need to write anything in the body of the email.

Subject: AWB [Insert AWB Number] Mangler Fuldstændig Ekspres, fremsend venligst ASAP

Urgent Receiving Procedure:
If you cannot wait for the documents to arrive, you may proceed with receiving the goods to ensure they are available for use.

Instead of entering the customs Case ID, enter the Carrier Name and AWB number in the ID field (e.g., FEDEX 123456789101).

This method preserves traceability and allows us to search for the AWB number in the system later. Once the actual documents are received from the carrier, you must return to AMS and update the entry with the correct Case ID.`
      },
      {
        id: 'sop-aerotron-cores',
        sopNumber: 5,
        title: 'Processing Aerotron Core Units',
        category: 'Logistics',
        updatedAt: new Date().toISOString(),
        content: `Processing Aerotron Core Units

1. Collect info:
The list of information below is required to process core units. It is therefore an advantage to collect and have this information ready when you sit down at the computer. Save time by seeing how much of the information below you can find on the unit's box. Usually, the exchange PN/SN/PO number, as well as the box's weight/dimensions, are listed on Aerotron's papers.

Find the following information for each unit:
A) Core PN
B) Core SN
C) U/S tag
D) Exchange PN
E) Exchange SN
F) Exchange TN (not required)
G) Exchange PO number
H) Colli weight/dimensions

2. Create a date-folder in the Aerotron core-folder:
The folder can be found on SharePoint: Logistics\\Airseven\\Core Archive\\Aerotron\\

Create a new folder and name it today's date in YYYY-MM-DD format.

Scan the U/S-tag(s) and place them in the folder as the first step. Name the file(s): US tag SN XXX

3. Tracking number on the core unit:
First, we must ensure that the core unit exists in AMS Inventory so we can link it to the exchange unit.

Start by going to Inventory Manager > Inventory Consultation, and perform a Ser/Batch# search for the core unit's SN. If it is known in the system, open it, upload the U/S tag, change the condition to UNSERVICEABLE, press Save, and proceed to step 4.

If the SN is not already created, continue from step 3A.

3A. Search for the core unit's PN:
Go to Inventory Manager > Inventory Consultation. Perform a Part Number search for the core unit's part number. Be aware that you are searching for the PN of the core unit and not the exchange unit.

When you search for the PN:
- If the PN does not already exist, it must be created. Continue from step 3B.
- If the PN already exists when you search, continue from step 3C.

3B. Creating a SN under a non-existent PN:
Press Add in the top window to add a new part number. Fill in: Part Number, Description, Type, Model (B737 NG), U/M (unit of measurement), Serialized/Life Limited, Rotable or Consumable. Press Save.

3C. Creating SN under an existing PN:
Press Add in the bottom window. Fill in: Condition: UNSERVICEABLE, Quantity: 1, Upload U/S tag in Doc. Manager. Press Save.

4. Link exchange and core unit(s) and create a Core Exchange document:
Search for the exchange unit via the PO. Go to P.O. Manager > Purchase Order Consultation. Perform a PO # search for the 4-digit exchange PO number.

4A. If a core/exchange line has not been created:
Find the exchange unit part number, click once to highlight, then press Exchange Creation button.

4B. If a core/exchange line has already been created:
Double-click the line with part number XXX-EXCH. Locate the correct exchange unit via SN or TN.

Look at the Core Value field:
- If 0.00 is displayed: Follow step 4C (manual document needed)
- If field is empty: Continue from step 4D

4C. If 0.00 is already displayed:
Create a manual Core Exchange document with a table containing: PN, SN, Desc., CAT PO, CAT TN for both Exchange and Core units. Save as PDF: Core exchange SN XXX.

4D. If the Core Value field is empty:
Type 0 and press Enter. Click Yes to link a core, then Close the window. Press Save.

4E. Link exchange and core unit(s) in AMS Core Manager:
Go to Exchange List Consultation. Sort by Core # (newest first). Double-click your exchange unit.

Click Select > From Inventory Search Function. Search for the core unit, press OK.

Click Core P.S. Creation button. Select Aerotron as supplier, click Yes to process.

Save the generated Word document as PDF: Core exchange SN XXX.

5. Fill out and save NIS (Non-incident statement):
Open SharePoint: Logistics\\Shipping\\PDF Generator\\
Open PDF Generator.html, login, click NIS Generator. Fill details and save in date-folder.

6. Prepare a shipping invoice:
Open PDF Generator.html, click Invoice Generator. Remember: Aerotron requires DDP incoterms for all core returns. Save in date-folder.

7. Book shipment and apply the cost to the monthly invoice:
Book via shipping portal. Check DDP incoterms and indicate goods are being returned.

In AMS: Invoicing Manager > Invoices Consultation, search for Airseven. Select monthly invoice, press Add new Misc:
- Description: "Shipping, DK > UK, core return, [items]"
- Qty: 1
- Price: [shipping cost]

8. Provide information to Aerotron:
Email to: imports@aerotron.co.uk and contractsemea@aerotron.group

Subject: Core return notification // DHL AWB XXX

Attach: U/S tag(s), Core exchange document(s), NIS document(s), AWB, Shipping invoice.`
      }
    ];

    const DEFAULT_CATEGORIES = ['Systems', 'Logistics', 'Purchasing'];

    // ============================================================
    // DEFAULT DAILY TASKS DATA
    // ============================================================

    const DEFAULT_DAILY_TASKS = [
      {
        id: 'dt-1',
        dtNumber: 1,
        title: 'Monitor Part Requests',
        category: 'Sourcing',
        updatedAt: new Date().toISOString(),
        content: `Part requests come from two sources and should be checked regularly throughout the day.

### Internal Requests

Internal requests are parts requested by our own mechanics directly in AMS.

1. **Open AMS.**
2. **Navigate** to Inventory Manager → Requisition List.
3. **Sort** by clicking the **Req. #** column header to show the newest requests at the top.
4. **Review and action** any new requests.

### External Requests

External requests come from external customers or satellite locations via the SharePoint requisition list.

1. **Open** the requisition list via SharePoint.
2. **Check** for new requests that have not been actioned.
3. **Mark** the **Sourcing** column for any new requests so colleagues know you have initiated sourcing.`
      },
      {
        id: 'dt-2',
        dtNumber: 2,
        title: 'Non-Aircraft Item Requests',
        category: 'Sourcing',
        updatedAt: new Date().toISOString(),
        content: `Non-aircraft items include tools, consumables, materials, and clothing. These use a separate requisition form on SharePoint, and notifications arrive in the shared email inbox when new requests are submitted.

### Approved Suppliers

Always order non-aircraft items from approved suppliers. We have VAT-exempt purchasing accounts with the following:

- DMT Værktøj
- Würth
- Biltema
- Stark
- Lomax

> **Note:** Mechanics often include links to specific products they found online. If our approved suppliers don't carry that exact item, liaise with the requester to find an acceptable alternative from our approved supplier list.

After actioning a request, update the ordered status and add a brief comment with the current status.`
      },
      {
        id: 'dt-3',
        dtNumber: 3,
        title: 'Part Sourcing and Procurement',
        category: 'Sourcing',
        updatedAt: new Date().toISOString(),
        content: `When a part request needs action, the first step is to investigate availability and cost.

### Sourcing Methods

There are several ways to locate parts:

- **ILS/Partsbase** – online parts marketplaces
- **AMS order history** – check previous purchases for the same part number
- **Colleagues** – ask the team which suppliers may carry the part

> **Note:** Some parts are manufacturer-exclusive, meaning only the OEM can quote or sell them. In these cases, lead time and cost are typically fixed, and maintenance must be planned accordingly.

### Procurement Decision Factors

When multiple suppliers are available, consider the following factors to maximize efficiency and minimize transit time and shipping costs:

| Factor | Question |
|--------|----------|
| Item lines | How many item lines do I need? |
| Quantity | What quantity/quantities do I need? |
| Deadline | What is my deadline? |
| Stock | Are the parts fully or partially in stock? |
| Lead time | What is the lead time? |
| Location | Where is the supplier located? |
| Shipping | Does the item require non-standard shipping? |

### Procurement of Contracted Components

This section applies specifically to parts ordered for Airseven aircraft.

Airseven has contractual agreements covering most rotable components:

| Supplier | Coverage |
|----------|----------|
| Aerotron Ltd. | Vast majority of rotable components (with some exceptions) |
| TP Aerospace | All wheels and brakes for the Airseven fleet |

> **Tip:** If you're unsure whether a component is covered by the Aerotron contract, contact our Aerotron representative or check AMS order history for prior purchases.

> **Important:** We have a consignment stock of more than 40 components for Airseven. Always check AMS inventory before procuring via Aerotron. If you forget, Aerotron will notify us if a unit is already in stock.`
      },
      {
        id: 'dt-4',
        dtNumber: 4,
        title: 'Receiving Goods',
        category: 'Warehouse',
        updatedAt: new Date().toISOString(),
        content: `Incoming shipments arrive almost daily. Some are urgent and task-related, while others are stock replenishment.

| Priority | Type | Action |
|----------|------|--------|
| High | Parts required for an active task | Receive as quickly as possible |
| Lower | Stock replenishment items | Receive when time permits, but don't neglect entirely |

> **Important:** The incoming shipment shelf must be cleared by the last day of each month (30th/31st). This is required for proper monthly turnover reporting.

> **Note:** Some shipments are delivered to headquarters landside. The office will notify us when they have received a shipment for us to collect.`
      },
      {
        id: 'dt-5',
        dtNumber: 5,
        title: 'Shipping Goods',
        category: 'Warehouse',
        updatedAt: new Date().toISOString(),
        content: `Outgoing shipments vary in urgency. Always prioritize task-related shipments first.

Common reasons for outgoing shipments include:

- Line station requirements
- Component repair/return
- External sales
- Document shipments

Always ensure appropriate cushioning and packaging. Depending on parcel size, quantity, and destination, either book a standard courier solution or contact our freight agent.`
      },
      {
        id: 'dt-6',
        dtNumber: 6,
        title: 'Checking for Expired and Overdue Parts',
        category: 'Compliance',
        updatedAt: new Date().toISOString(),
        content: `Parts and tools with time limits must be monitored and removed from inventory if the date is exceeded.

### Viewing Time-Limited Items

1. **Open AMS.**
2. **Navigate** to Inventory Manager → Time Expired Part List.
3. **Sort by date** to see the parts closest to expiry at the top.

### Types of Time Limitations

| Limitation Type | Action Required |
|-----------------|-----------------|
| Calibration cycles | Remove from inventory, send for calibration |
| Inspection / test / overhaul | Remove from inventory, arrange appropriate service |
| Shelf life (e.g., o-rings, first aid kits, lubricants) | Destroy/discard and remove from system — cannot be extended |

> **Note:** All tools requiring calibration have 12 months of validity. We typically send tools for calibration in Q1, staggered to avoid depleting the tool pool entirely.`
      },
      {
        id: 'dt-7',
        dtNumber: 7,
        title: 'Emails',
        category: 'Communication',
        updatedAt: new Date().toISOString(),
        content: `We receive many emails requiring different actions. Remember to check both your personal inbox and the shared department inbox regularly, and take action where necessary.`
      },
      {
        id: 'dt-8',
        dtNumber: 8,
        title: 'Processing Core Units and Return Shipments',
        category: 'Maintenance',
        updatedAt: new Date().toISOString(),
        content: `This section applies specifically to Airseven maintenance tasks.

Airseven's mechanic crew often works nights and weekends. They send task reports to our shared email inbox after completing each task.

1. **Review** task reports in the shared inbox when you clock in.
2. **Look for red tags** in the paperwork. A red tag indicates a component has been replaced and logistics action is required.
3. **Process** the core return according to the relevant procedure.

> **Important:** 95% of core-related tasks involve components from Aerotron or TP Aerospace. We have contractual obligations to return unserviceable units promptly — prioritize red tag items in the inbox.`
      },
      {
        id: 'dt-9',
        dtNumber: 9,
        title: 'Processing Green Tag Units',
        category: 'Maintenance',
        updatedAt: new Date().toISOString(),
        content: `We have an in-house shop for batteries, magnetos, and wheels. When mechanics complete a repair, they place the serviceable component in the warehouse.

Our task is to:

1. **Create** the component record in AMS.
2. **Put it on stock** in the correct warehouse location.`
      },
      {
        id: 'dt-10',
        dtNumber: 10,
        title: 'Warehouse and Facility Upkeep',
        category: 'Warehouse',
        updatedAt: new Date().toISOString(),
        content: `After periods of heavy workload, the warehouse or office may become disorganized. When time permits, take the opportunity to clean up and restore order.

Upkeep tasks include:

- Archive or properly store any documents left out in the open
- Sort packing materials and boxes — decide what to keep and what to discard
- General tidiness in the workspace

> **Tip:** Physical clutter can lead to lost paperwork and frustration for colleagues. Maintaining a tidy environment helps everyone work more effectively.`
      },
      {
        id: 'dt-11',
        dtNumber: 11,
        title: 'Return Surplus Parts to Stock',
        category: 'Warehouse',
        updatedAt: new Date().toISOString(),
        content: `Check the **Return To Stock** box from Hangar 5. This box contains surplus parts from completed tasks — mechanics sometimes don't use all allocated parts.

Review the returned parts and take the necessary action to return them to stock in the warehouse.`
      }
    ];

    // ============================================================
    // DEFAULT GLOSSARY DATA
    // ============================================================

    const INITIAL_GLOSSARY = [
      // === ABBREVIATIONS ===
      { id: '1', type: 'abbreviation', name: 'AMS', meaning: 'Aircraft Management System', context: 'Our inventory and ordering system', category: 'Systems' },
      { id: '2', type: 'abbreviation', name: 'AOG', meaning: 'Aircraft On Ground', context: 'Highest priority for flight operations', category: 'Operations' },
      { id: '3', type: 'abbreviation', name: 'AWB', meaning: 'Airway Bill', context: 'Tracking number', category: 'Documents' },
      { id: '4', type: 'abbreviation', name: 'CAMO', meaning: 'Continuing Airworthiness Management Organisation', context: 'The person/team in charge of paperwork and compliance of aircraft', category: 'Organizations' },
      { id: '5', type: 'abbreviation', name: 'CL', meaning: 'Classic', context: 'Used in aircraft model names', category: 'General' },
      { id: '6', type: 'abbreviation', name: 'COA', meaning: 'Certificate of Analysis', context: 'Certification type', category: 'Documents' },
      { id: '7', type: 'abbreviation', name: 'COC', meaning: 'Certificate of Compliance', context: 'Also written as CofC. Certification type', category: 'Documents' },
      { id: '8', type: 'abbreviation', name: 'CRIT', meaning: 'Critical', category: 'Operations' },
      { id: '9', type: 'abbreviation', name: 'CSI', meaning: 'Cycles Since Installation', category: 'Operations' },
      { id: '10', type: 'abbreviation', name: 'EASA', meaning: 'European Union Aviation Safety Agency', context: 'EU aviation agency', category: 'Organizations' },
      { id: '11', type: 'abbreviation', name: 'FAA', meaning: 'Federal Aviation Administration', context: 'US aviation agency', category: 'Organizations' },
      { id: '12', type: 'abbreviation', name: 'F/N', meaning: 'Factory New', context: 'Part condition', category: 'Part Conditions' },
      { id: '13', type: 'abbreviation', name: 'GMT', meaning: 'Ground Maintenance Technics', context: 'Company name of the mechanics servicing Airseven', category: 'Organizations' },
      { id: '14', type: 'abbreviation', name: 'N/S', meaning: 'New Surplus', context: 'Part condition', category: 'Part Conditions' },
      { id: '15', type: 'abbreviation', name: 'NE', meaning: 'New', context: 'Part condition', category: 'Part Conditions' },
      { id: '16', type: 'abbreviation', name: 'NG', meaning: 'Next Generation', context: 'Used in aircraft model names', category: 'General' },
      { id: '17', type: 'abbreviation', name: 'OEM', meaning: 'Original Equipment Manufacturer', context: 'The original manufacturer, or made by the original manufacturer', category: 'Parts' },
      { id: '18', type: 'abbreviation', name: 'O/H', meaning: 'Overhauled', context: 'Part condition', category: 'Part Conditions' },
      { id: '19', type: 'abbreviation', name: 'PBH', meaning: 'Power By the Hour', context: 'Used in contractual agreements for hour rate payment', category: 'Operations' },
      { id: '20', type: 'abbreviation', name: 'PMA', meaning: 'Parts Manufacturer Approval', context: 'Used for aftermarket parts manufactured under OEM approval', category: 'Parts' },
      { id: '21', type: 'abbreviation', name: 'PN', meaning: 'Part Number', category: 'General' },
      { id: '22', type: 'abbreviation', name: 'PO', meaning: 'Purchase Order', category: 'Documents' },
      { id: '23', type: 'abbreviation', name: 'QTY', meaning: 'Quantity', category: 'General' },
      { id: '24', type: 'abbreviation', name: 'RFQ', meaning: 'Request For Quote', context: 'When requesting price and lead time with suppliers', category: 'Operations' },
      { id: '25', type: 'abbreviation', name: 'SL', meaning: 'Shelf Life', context: 'Expiry date', category: 'Part Conditions' },
      { id: '26', type: 'abbreviation', name: 'SN', meaning: 'Serial Number', category: 'General' },
      { id: '27', type: 'abbreviation', name: 'SO', meaning: 'Sales Order', category: 'Documents' },
      { id: '28', type: 'abbreviation', name: 'S/V', meaning: 'Serviceable', context: 'Part condition', category: 'Part Conditions' },
      { id: '29', type: 'abbreviation', name: 'TN', meaning: 'Tracking Number', context: 'The tracking number used in AMS', category: 'General' },
      { id: '30', type: 'abbreviation', name: 'U/M', meaning: 'Unit of Measurement', category: 'General' },
      { id: '31', type: 'abbreviation', name: 'UOM', meaning: 'Unit of Measurement', category: 'General' },
      { id: '32', type: 'abbreviation', name: 'U/S', meaning: 'Unserviceable', context: 'Part condition', category: 'Part Conditions' },
      { id: '33', type: 'abbreviation', name: 'WO', meaning: 'Work Order', category: 'Documents' },
      { id: '34', type: 'abbreviation', name: 'WR', meaning: 'Work Report', category: 'Documents' },
      // === TERMS ===
      { id: '35', type: 'term', name: 'Airworthiness release', meaning: 'Certificate confirming an aircraft or component meets airworthiness standards', category: 'Documents' },
      { id: '36', type: 'term', name: 'Consumable', meaning: 'Parts that can only be used once', category: 'Parts' },
      { id: '37', type: 'term', name: 'Core', meaning: 'The unserviceable unit in an exchange transaction. Exchange and Core units are linked — Core is the unserviceable unit returned to the supplier', category: 'Parts' },
      { id: '38', type: 'term', name: 'Cycle', meaning: 'One takeoff and one landing. Used for historic data on rotable components', category: 'Operations' },
      { id: '39', type: 'term', name: 'Dropshipping', meaning: 'Delivery directly from supplier to end-use location', category: 'Operations' },
      { id: '40', type: 'term', name: 'Dual Release', meaning: 'A statement on the FAA 8130-3 that confirms compliance with EASA regulations', category: 'Documents' },
      { id: '41', type: 'term', name: 'Exchange', meaning: 'Used when buying rotable components. Exchange and Core units are linked. Exchange is the serviceable unit and Core is the unserviceable unit', category: 'Parts' },
      { id: '42', type: 'term', name: 'Form 1', meaning: 'EASA Authorized Release Certificate', category: 'Documents' },
      { id: '43', type: 'term', name: '8130-3', meaning: 'FAA Airworthiness Approval Tag', category: 'Documents' },
      { id: '44', type: 'term', name: 'Hardware', meaning: 'Screws, nuts, bolts, washers, pins etc.', category: 'Parts' },
      { id: '45', type: 'term', name: 'Line Station', meaning: 'The airport where the mechanics are performing maintenance on the aircraft', category: 'Operations' },
      { id: '46', type: 'term', name: 'Lot number', meaning: 'A batch-specific identifier, essentially the same as a tracking number', category: 'General' },
      { id: '47', type: 'term', name: 'Red tag', meaning: 'A small document for unserviceable parts. It contains PN/SN data along with removal date and other relevant information', category: 'Documents' },
      { id: '48', type: 'term', name: 'Rotable', meaning: 'Aircraft components that can be repaired and reused', category: 'Parts' },
      { id: '49', type: 'term', name: 'Traceability', meaning: 'Term used for the life-history of a part, item or aircraft. Traceability is required to establish the timeline of production, distribution, installation and/or repair of any part', category: 'General' },
      { id: '50', type: 'term', name: 'Tracking number', meaning: 'Tracking or Lot numbers is a batch specific ID. AMS uses the term "tracking number", but it\'s essentially the same as a lot or batch number', category: 'General' },
      { id: '51', type: 'term', name: 'U/S tag', meaning: 'A tag placed on unserviceable parts, also known as a Red tag', category: 'Documents' },
    ];

    // ============================================================
    // DEFAULT CONTACTS DATA
    // ============================================================

    const INITIAL_CONTACTS = [
      { id: '1', name: 'Søren Petersen', role: 'Logistics Manager', phone: '+45 12 34 56 78', email: 'sep@catflyservice.dk' },
      { id: '2', name: 'Maria Jensen', role: 'CAMO Manager', phone: '+45 23 45 67 89', email: 'mje@catflyservice.dk' },
      { id: '3', name: 'Lars Andersen', role: 'Technical Director', phone: '+45 34 56 78 90', email: 'lan@catflyservice.dk' },
    ];

    // ============================================================
    // DEFAULT PART LOCATIONS DATA
    // ============================================================

    const INITIAL_PART_LOCATIONS = [
      { id: '1', category: 'Avionics, lamps', subcategory: 'Anticollision/strobe lights', locations: ['C24-C-1'] },
      { id: '2', category: 'Avionics, lamps', subcategory: 'Beam lamps', locations: ['C24-B'] },
      { id: '3', category: 'Avionics, lamps', subcategory: 'Bulbs and Lamps', locations: ['C24-C-1', 'C24-C-2', 'C24-C-3', 'C24-C-5', 'C24-C-6', 'C24-B'] },
      { id: '4', category: 'Avionics, lamps', subcategory: 'Lenses', locations: ['C24-C-4'] },
      { id: '5', category: 'Avionics', subcategory: 'Alternator', locations: ['C21-A', 'C21-B'] },
      { id: '6', category: 'Avionics', subcategory: 'Antennas', locations: ['C3-C-2'] },
      { id: '7', category: 'Avionics', subcategory: 'Batteries', locations: ['C3-F', 'C4-E'] },
      { id: '8', category: 'Avionics', subcategory: 'Brushes', locations: ['C3-A-3'] },
      { id: '9', category: 'Avionics', subcategory: 'Butt Splices', locations: ['C3-B-3'] },
      { id: '10', category: 'Avionics', subcategory: 'Circuit breakers', locations: ['C3-C-4'] },
      { id: '11', category: 'Avionics', subcategory: 'Connectors', locations: ['C4-B-5'] },
      { id: '12', category: 'Avionics', subcategory: 'Diodes', locations: ['C3-A-1'] },
      { id: '13', category: 'Avionics', subcategory: 'Encoders', locations: ['C3-B'] },
      { id: '14', category: 'Avionics', subcategory: 'Fuses', locations: ['C3-A-2'] },
      { id: '15', category: 'Avionics', subcategory: 'Insert/Extract Tools', locations: ['C4-B-6'] },
      { id: '16', category: 'Avionics', subcategory: 'Mixed Avionics', locations: ['C3-C-3', 'C4-C-6', 'C3-B-1', 'C3-B-2'] },
      { id: '17', category: 'Avionics', subcategory: 'Probes', locations: ['C3-A-4'] },
      { id: '18', category: 'Avionics', subcategory: 'Relays', locations: ['C3-C-1'] },
      { id: '19', category: 'Avionics', subcategory: 'Screws', locations: ['C19-C-6'] },
      { id: '20', category: 'Avionics', subcategory: 'Small instruments', locations: ['C3-A-5'] },
      { id: '21', category: 'Avionics', subcategory: 'Solder sleeves', locations: ['C3-B-3'] },
      { id: '22', category: 'Avionics', subcategory: 'Starter', locations: ['C21-C', 'C21-D'] },
      { id: '23', category: 'Avionics', subcategory: 'Statick wicks', locations: ['C3-A-4'] },
      { id: '24', category: 'Avionics', subcategory: 'Switches', locations: ['C3-C-5'] },
      { id: '25', category: 'Avionics', subcategory: 'Terminals', locations: ['C4-B-4'] },
      { id: '26', category: 'Avionics', subcategory: 'Transponders', locations: ['C3-B'] },
      { id: '27', category: 'Avionics', subcategory: 'Wire', locations: ['C3-F'] },
      { id: '28', category: 'Britten-Norman', subcategory: 'NB parts, big', locations: ['C6-A', 'C6-B'] },
      { id: '29', category: 'Britten-Norman', subcategory: 'Pipes', locations: ['C6-E'] },
      { id: '30', category: 'Britten-Norman', subcategory: 'Tubes', locations: ['C6-E'] },
      { id: '31', category: 'Britten-Norman', subcategory: 'NB parts, small', locations: ['C6-C-1', 'C6-C-2', 'C6-C-3', 'C6-C-4', 'C6-C-5', 'C6-C-6'] },
      { id: '32', category: 'Cessna', subcategory: 'Cessna parts', locations: ['C17-D-1', 'C17-D-2'] },
      { id: '33', category: 'Engine Misc.', subcategory: 'Drain valve, flush mount', locations: ['C23-B-1'] },
      { id: '34', category: 'Engine Misc.', subcategory: 'Gasket, spark plugs', locations: ['C22-B'] },
      { id: '35', category: 'Engine Misc.', subcategory: 'Ignition harness', locations: ['C22-B'] },
      { id: '36', category: 'Engine Misc.', subcategory: 'Oilfilters', locations: ['C22-C', 'C22-A'] },
      { id: '37', category: 'Engine Misc.', subcategory: 'Spark plugs', locations: ['C22-B'] },
      { id: '38', category: 'Exhaust', subcategory: 'Clamps', locations: ['C6-D-1'] },
      { id: '39', category: 'Exhaust', subcategory: 'Gaskets', locations: ['C6-D-6'] },
      { id: '40', category: 'Exhaust', subcategory: 'Heat exchangers', locations: ['C6-D', 'C7-D'] },
      { id: '41', category: 'Exhaust', subcategory: 'Mufflers', locations: ['C6-D', 'C7-D'] },
      { id: '42', category: 'Exhaust', subcategory: 'Pipes, big', locations: ['C7-D'] },
      { id: '43', category: 'Exhaust', subcategory: 'Pipes, small', locations: ['C6-D-1'] },
      { id: '44', category: 'Exhaust', subcategory: 'Stack assy', locations: ['C7-D'] },
      { id: '45', category: 'Filters', subcategory: 'Air filter', locations: ['C23-C-4', 'C23-C-6', 'C23-E'] },
      { id: '46', category: 'Filters', subcategory: 'Alternator filters', locations: ['C23-D-1'] },
      { id: '47', category: 'Filters', subcategory: 'Fuel filters', locations: ['C23-D-1'] },
      { id: '48', category: 'Filters', subcategory: 'Induction air filters BA-162E', locations: ['C23-D-5'] },
      { id: '49', category: 'Filters', subcategory: 'Induction air filters BA-3', locations: ['C23-E'] },
      { id: '50', category: 'Filters', subcategory: 'Induction air filters BA6108', locations: ['C23-D-4'] },
      { id: '51', category: 'Filters', subcategory: 'Inlet air filters', locations: ['C23-C-5'] },
      { id: '52', category: 'Filters', subcategory: 'Oilfilters', locations: ['C22-C', 'C22-A'] },
      { id: '53', category: 'Filters', subcategory: 'Pneumatic filters', locations: ['C23-D'] },
      { id: '54', category: 'Filters', subcategory: 'Socata filters N72', locations: ['C13-D-2'] },
      { id: '55', category: 'Fittings', subcategory: 'AN Fittings', locations: ['C18-E-1', 'C18-E-2', 'C18-E-3'] },
      { id: '56', category: 'Fittings', subcategory: 'AS Fittings', locations: ['C18-D-2'] },
      { id: '57', category: 'Fittings', subcategory: 'Mixed Fittings', locations: ['C18-D-1'] },
      { id: '58', category: 'Fittings', subcategory: 'MS Fittings', locations: ['C18-D-2'] },
      { id: '59', category: 'Goodrich, deicing', subcategory: '2E', locations: ['C11-C-1'] },
      { id: '60', category: 'Goodrich, deicing', subcategory: '3E', locations: ['C11-C-2'] },
      { id: '61', category: 'Goodrich, deicing', subcategory: '4E', locations: ['C11-C-2'] },
      { id: '62', category: 'Goodrich, deicing', subcategory: 'Activator chemical', locations: ['C11-C-3'] },
      { id: '63', category: 'Goodrich, deicing', subcategory: 'Big goodrich parts', locations: ['C11-C'] },
      { id: '64', category: 'Goodrich, deicing', subcategory: 'De-ice brushes', locations: ['C11-C-2'] },
      { id: '65', category: 'Hardware', subcategory: 'AN Mixed', locations: ['C19-E-4'] },
      { id: '66', category: 'Hardware', subcategory: 'Mixed', locations: ['C18-D-1', 'C18-D-2', 'C19-D-4'] },
      { id: '67', category: 'Hardware', subcategory: 'MS Mixed', locations: ['C19-B-6'] },
      { id: '68', category: 'Hardware', subcategory: 'NAS Mixed', locations: ['C19-E-1'] },
      { id: '69', category: 'Hardware', subcategory: 'STD Mixed', locations: ['C20-D-1'] },
      { id: '70', category: 'Hardware', subcategory: 'KP Bearings', locations: ['C23-B-2'] },
      { id: '71', category: 'Hardware', subcategory: 'MS Mixed', locations: ['C20-B-1'] },
      { id: '72', category: 'Hardware', subcategory: 'RB Rod ends', locations: ['C23-B-2'] },
      { id: '73', category: 'Hardware', subcategory: 'SP Mixed', locations: ['C20-B-2'] },
      { id: '74', category: 'Hardware, anchor nuts', subcategory: 'MS Anchornuts', locations: ['C19-B-1'] },
      { id: '75', category: 'Hardware, bolts', subcategory: 'A Bolts', locations: ['C18-D-6'] },
      { id: '76', category: 'Hardware, bolts', subcategory: 'A102 Bolts', locations: ['C18-D-5'] },
      { id: '77', category: 'Hardware, bolts', subcategory: 'A111 - A113 Bolts', locations: ['C18-D-4'] },
      { id: '78', category: 'Hardware, bolts', subcategory: 'AN23 Bolts', locations: ['C19-F-6'] },
      { id: '79', category: 'Hardware, bolts', subcategory: 'AN24 Bolts', locations: ['C19-F-6'] },
      { id: '80', category: 'Hardware, bolts', subcategory: 'AN3 Bolts', locations: ['C19-F-1', 'C19-F-2'] },
      { id: '81', category: 'Hardware, bolts', subcategory: 'AN4 Bolts', locations: ['C19-F-3', 'C19-F-4'] },
      { id: '82', category: 'Hardware, bolts', subcategory: 'AN5 Bolts', locations: ['C19-F-5'] },
      { id: '83', category: 'Hardware, bolts', subcategory: 'AN6 Bolts', locations: ['C19-F-6'] },
      { id: '84', category: 'Hardware, bolts', subcategory: 'AN7 Bolts', locations: ['C19-F-6'] },
      { id: '85', category: 'Hardware, bolts', subcategory: 'Mixed Bolts', locations: ['C19-D-3'] },
      { id: '86', category: 'Hardware, bolts', subcategory: 'MS bolts', locations: ['C19-B-3'] },
      { id: '87', category: 'Hardware, bolts', subcategory: 'NAS Bolts', locations: ['C19-E-2'] },
      { id: '88', category: 'Hardware, clamps', subcategory: 'Mixed clamps', locations: ['C18-F-2'] },
      { id: '89', category: 'Hardware, clamps', subcategory: 'Mixed clamps', locations: ['C18-F-3', 'C18-F-4', 'C18-F'] },
      { id: '90', category: 'Hardware, clips', subcategory: 'Mixed clips', locations: ['C18-F-1'] },
      { id: '91', category: 'Hardware, cotter pins', subcategory: 'Mixed cotter pins', locations: ['C20-D-3'] },
      { id: '92', category: 'Hardware, cotter pins', subcategory: 'MS Cotter pins', locations: ['C19-B-2'] },
      { id: '93', category: 'Hardware, dome plugs', subcategory: 'Dome plugs', locations: ['C20-C-2'] },
      { id: '94', category: 'Hardware, fastners', subcategory: 'Fasteners, camloc and receptacle', locations: ['C19-D-5'] },
      { id: '95', category: 'Hardware, grease nipples', subcategory: 'Mixed Grease nipples', locations: ['C19-D-1'] },
      { id: '96', category: 'Hardware, grease nipples', subcategory: 'MS Grease nipples', locations: ['C20-B-1'] },
      { id: '97', category: 'Hardware, grease nipples', subcategory: 'Socata Grease nipples', locations: ['C13-D-2'] },
      { id: '98', category: 'Hardware, grease nipples', subcategory: 'SP Grease nipple', locations: ['C20-B-2'] },
      { id: '99', category: 'Hardware, grommets', subcategory: 'MS Grommets', locations: ['C20-C-1'] },
      { id: '100', category: 'Hardware, grommets', subcategory: 'SP Grommets', locations: ['C20-C-1'] },
      { id: '101', category: 'Hardware, nuts', subcategory: 'A nuts', locations: ['C18-D-3'] },
      { id: '102', category: 'Hardware, nuts', subcategory: 'AN Nuts', locations: ['C19-E-6'] },
      { id: '103', category: 'Hardware, nuts', subcategory: 'Mixed Nuts', locations: ['C19-D-3'] },
      { id: '104', category: 'Hardware, nuts', subcategory: 'MS nuts', locations: ['C19-B-4', 'C19-B-5'] },
      { id: '105', category: 'Hardware, nuts', subcategory: 'STD Nuts', locations: ['C20-D-1'] },
      { id: '106', category: 'Hardware, pins', subcategory: 'Mixed Pins', locations: ['C20-D-3'] },
      { id: '107', category: 'Hardware, pins', subcategory: 'SP pins', locations: ['C20-B-2'] },
      { id: '108', category: 'Hardware, rivets', subcategory: 'Mixed Rivets', locations: ['C20-D-2'] },
      { id: '109', category: 'Hardware, screws', subcategory: 'A Screws', locations: ['C18-D-6'] },
      { id: '110', category: 'Hardware, screws', subcategory: 'AN Screws', locations: ['C19-E-3'] },
      { id: '111', category: 'Hardware, screws', subcategory: 'AN Screws', locations: ['C19-E-4'] },
      { id: '112', category: 'Hardware, screws', subcategory: 'Avionic Screws', locations: ['C19-C-6'] },
      { id: '113', category: 'Hardware, screws', subcategory: 'MS Screws', locations: ['C19-C-1', 'C19-C-2', 'C19-C-3', 'C19-C-5'] },
      { id: '114', category: 'Hardware, screws', subcategory: 'RX Screws', locations: ['C19-D-6'] },
      { id: '115', category: 'Hardware, screws', subcategory: 'STD Screw', locations: ['C20-D-1'] },
      { id: '116', category: 'Hardwarew, washers', subcategory: 'A Washers', locations: ['C18-D-6'] },
      { id: '117', category: 'Hardwarew, washers', subcategory: 'AN Washers', locations: ['C19-E-5'] },
      { id: '118', category: 'Hardwarew, washers', subcategory: 'Mixed Washers', locations: ['C19-D-3'] },
      { id: '119', category: 'Hardwarew, washers', subcategory: 'MS Washers', locations: ['C19-C-4'] },
      { id: '120', category: 'Hardwarew, washers', subcategory: 'Nas Washers', locations: ['C19-E-1'] },
      { id: '121', category: 'Hardwarew, washers', subcategory: 'SP washers', locations: ['C20-B-2'] },
      { id: '122', category: 'Hardwarew, washers', subcategory: 'STD Washer', locations: ['C20-D-1'] },
      { id: '123', category: 'Hoses', subcategory: '303 hoses', locations: ['C7-E-1'] },
      { id: '124', category: 'Hoses', subcategory: '306 hoses', locations: ['C7-E-2'] },
      { id: '125', category: 'Hoses', subcategory: 'Firesleeves - Mixed', locations: ['C9-E'] },
      { id: '126', category: 'Hoses', subcategory: 'Mixed hoses', locations: ['C7-E-3'] },
      { id: '127', category: 'Hoses', subcategory: 'P68 hoses', locations: ['C16-E'] },
      { id: '128', category: 'Hoses', subcategory: 'Robinson hoses', locations: ['C9-B'] },
      { id: '129', category: 'King Air', subcategory: 'Bolts', locations: ['C9-C-2'] },
      { id: '130', category: 'King Air', subcategory: 'Gaskets', locations: ['C9-C-1'] },
      { id: '131', category: 'King Air', subcategory: 'Mixed King Air', locations: ['C9-C-4'] },
      { id: '132', category: 'King Air', subcategory: 'Nuts', locations: ['C9-C-2'] },
      { id: '133', category: 'King Air', subcategory: 'O-Rings', locations: ['C9-C-5'] },
      { id: '134', category: 'King Air', subcategory: 'Screws', locations: ['C9-C-2'] },
      { id: '135', category: 'King Air', subcategory: 'Washers', locations: ['C9-C-2'] },
      { id: '136', category: 'Landing gear', subcategory: '15x6.00-6 tubes', locations: ['C5-C-1'] },
      { id: '137', category: 'Landing gear', subcategory: '5.00-5 tubes', locations: ['C5-C-1'] },
      { id: '138', category: 'Landing gear', subcategory: '6.00-6 tubes', locations: ['C5-C-2'] },
      { id: '139', category: 'Landing gear', subcategory: '7.00-6 tubes', locations: ['C5-C-3'] },
      { id: '140', category: 'Landing gear', subcategory: '7.00/8.00-6 tubes', locations: ['C5-C-3'] },
      { id: '141', category: 'Landing gear', subcategory: '8.00-6 tubes', locations: ['C5-C-3'] },
      { id: '142', category: 'Landing gear', subcategory: 'AIR - Britten-Norman landing gear parts', locations: ['C5-B-6'] },
      { id: '143', category: 'Landing gear', subcategory: 'Brake discs', locations: ['C24-E', 'C24-D'] },
      { id: '144', category: 'Landing gear', subcategory: 'Brake linings', locations: ['C24-D-1', 'C24-D-2', 'C24-D-3'] },
      { id: '145', category: 'Landing gear', subcategory: 'Landing gear parts', locations: ['C5-B-1', 'C5-B-2'] },
      { id: '146', category: 'Landing gear', subcategory: 'Shims', locations: ['C24-D-1'] },
      { id: '147', category: 'Landing gear', subcategory: 'Tires', locations: ['C5-D'] },
      { id: '148', category: 'Landing gear', subcategory: 'Wheel assy', locations: ['C5-A'] },
      { id: '149', category: 'Landing gear', subcategory: 'Wheel bearings', locations: ['C5-B-3'] },
      { id: '150', category: 'Lines', subcategory: 'Mixed lines', locations: ['C7-E-3'] },
      { id: '151', category: 'Lycoming', subcategory: 'Actuators', locations: ['C4-C'] },
      { id: '152', category: 'Lycoming', subcategory: 'Carburetors', locations: ['C4-C'] },
      { id: '153', category: 'Lycoming', subcategory: 'Cylinders', locations: ['C4-A'] },
      { id: '154', category: 'Lycoming', subcategory: 'Engine mounts', locations: ['C4-C-2'] },
      { id: '155', category: 'Lycoming', subcategory: 'Gaskets', locations: ['C4-C-4'] },
      { id: '156', category: 'Lycoming', subcategory: 'Gaskets - cylinder', locations: ['C4-C-3'] },
      { id: '157', category: 'Lycoming', subcategory: 'Governor', locations: ['C4-C'] },
      { id: '158', category: 'Lycoming', subcategory: 'Injector - fuel', locations: ['C4-C'] },
      { id: '159', category: 'Lycoming', subcategory: 'LW Mixed - Lycoming eng. parts', locations: ['C4-C-1'] },
      { id: '160', category: 'Lycoming', subcategory: 'Magnetos', locations: ['C4-D'] },
      { id: '161', category: 'Lycoming', subcategory: 'Magnetos - spare parts', locations: ['C4-E'] },
      { id: '162', category: 'Lycoming', subcategory: 'Mixed lycoming engine parts', locations: ['C4-C-2'] },
      { id: '163', category: 'Lycoming', subcategory: 'Propeller hubs', locations: ['C4-E'] },
      { id: '164', category: 'Lycoming', subcategory: 'Ring gears', locations: ['C4-A'] },
      { id: '165', category: 'Lycoming', subcategory: 'SL Mixed - Lycoming eng. parts', locations: ['C4-C-1'] },
      { id: '166', category: 'Miscellaneous', subcategory: 'Adapters for headset', locations: ['C15-D'] },
      { id: '167', category: 'Miscellaneous', subcategory: 'Baffling material', locations: ['C11-E'] },
      { id: '168', category: 'Miscellaneous', subcategory: 'Carbon monoxide detectors', locations: ['C23-C-1'] },
      { id: '169', category: 'Miscellaneous', subcategory: 'Compas deveation decal', locations: ['C23-C-1'] },
      { id: '170', category: 'Miscellaneous', subcategory: 'Fairing seal', locations: ['C11-D', 'C14-D'] },
      { id: '171', category: 'Miscellaneous', subcategory: 'Fire extinguisher', locations: ['C10-C'] },
      { id: '172', category: 'Miscellaneous', subcategory: 'First aid kit niveau 1', locations: ['C15-C-3'] },
      { id: '173', category: 'Miscellaneous', subcategory: 'First aid kit niveau 2', locations: ['C15-C-1', 'C15-C-2'] },
      { id: '174', category: 'Miscellaneous', subcategory: 'First aid kit niveau 3', locations: ['C15-C-3'] },
      { id: '175', category: 'Miscellaneous', subcategory: 'First aid kit niveau 4', locations: ['C15-C-3'] },
      { id: '176', category: 'Miscellaneous', subcategory: 'Flashlights - Handheld', locations: ['C15-D-1'] },
      { id: '177', category: 'Miscellaneous', subcategory: 'Fuel drain cups', locations: ['C10-C'] },
      { id: '178', category: 'Miscellaneous', subcategory: 'Gust lock', locations: ['C10-C'] },
      { id: '179', category: 'Miscellaneous', subcategory: 'Hyd/Fuel sample kits', locations: ['C22-D-2'] },
      { id: '180', category: 'Miscellaneous', subcategory: 'Life vest', locations: ['C10-B'] },
      { id: '181', category: 'Miscellaneous', subcategory: 'Log books', locations: ['C15-D-2'] },
      { id: '182', category: 'Miscellaneous', subcategory: 'Mikrofonbeskytter - Microphone protector', locations: ['C15-D'] },
      { id: '183', category: 'Miscellaneous', subcategory: 'Oils sample kits', locations: ['C22-D-1'] },
      { id: '184', category: 'Miscellaneous', subcategory: 'Pitot cover', locations: ['C10-D'] },
      { id: '185', category: 'Miscellaneous', subcategory: 'Seat belts', locations: ['C8-B'] },
      { id: '186', category: 'Miscellaneous', subcategory: 'Silicone material', locations: ['C11-E'] },
      { id: '187', category: 'Miscellaneous', subcategory: 'Wheel chocks', locations: ['C10-D'] },
      { id: '188', category: 'O-Rings', subcategory: 'AN O-Rings', locations: ['C18-B-1'] },
      { id: '189', category: 'O-Rings', subcategory: 'AS O-Rings', locations: ['C18-C-4'] },
      { id: '190', category: 'O-Rings', subcategory: 'M O-Rings', locations: ['C18-B-4'] },
      { id: '191', category: 'O-Rings', subcategory: 'Mixed O-Rings', locations: ['C18-B-2', 'C18-B-3'] },
      { id: '192', category: 'O-Rings', subcategory: 'MS O-Rings', locations: ['C18-B-3', 'C18-C-1', 'C18-C-2'] },
      { id: '193', category: 'O-Rings', subcategory: 'NAS O-Rings', locations: ['C18-C-6'] },
      { id: '194', category: 'O-Rings', subcategory: 'SA O-Rings', locations: ['C18-C-5'] },
      { id: '195', category: 'Partenavia P.68', subcategory: 'Big P68 parts', locations: ['C16-A', 'C16-B'] },
      { id: '196', category: 'Partenavia P.68', subcategory: 'Hoses', locations: ['C16-E'] },
      { id: '197', category: 'Partenavia P.68', subcategory: 'Mixed P68 parts', locations: ['C16-D-5'] },
      { id: '198', category: 'Partenavia P.68', subcategory: 'P/N 1.', locations: ['C16-C-1'] },
      { id: '199', category: 'Partenavia P.68', subcategory: 'P/N 2.', locations: ['C16-C-2'] },
      { id: '200', category: 'Partenavia P.68', subcategory: 'P/N 3.', locations: ['C16-C-3'] },
      { id: '201', category: 'Partenavia P.68', subcategory: 'P/N 4.', locations: ['C16-C-4'] },
      { id: '202', category: 'Partenavia P.68', subcategory: 'P/N 5.', locations: ['C16-C-5'] },
      { id: '203', category: 'Partenavia P.68', subcategory: 'P/N 6.', locations: ['C16-D-1'] },
      { id: '204', category: 'Partenavia P.68', subcategory: 'P/N 7.', locations: ['C16-D-2', 'C16-D-3', 'C16-D-4'] },
      { id: '205', category: 'PC-12', subcategory: 'Big PC-12 parts', locations: ['C7-A', 'C7-B'] },
      { id: '206', category: 'PC-12', subcategory: 'Bolt', locations: ['C7-C-4'] },
      { id: '207', category: 'PC-12', subcategory: 'Filters', locations: ['C7-C-2'] },
      { id: '208', category: 'PC-12', subcategory: 'Mixed PC-12', locations: ['C7-C-3'] },
      { id: '209', category: 'PC-12', subcategory: 'Nuts', locations: ['C7-C-4'] },
      { id: '210', category: 'PC-12', subcategory: 'O-Rings', locations: ['C7-C-1'] },
      { id: '211', category: 'PC-12', subcategory: 'Packings', locations: ['C7-C-1'] },
      { id: '212', category: 'PC-12', subcategory: 'Screws', locations: ['C7-C-4'] },
      { id: '213', category: 'PC-12', subcategory: 'Seals', locations: ['C7-C-1'] },
      { id: '214', category: 'PC-12', subcategory: 'Washers', locations: ['C7-C-4'] },
      { id: '215', category: 'Piper', subcategory: 'Piper parts', locations: ['C17-C-1', 'C17-C-3', 'C17-C-4'] },
      { id: '216', category: 'Placards/Decals', subcategory: 'Placards/decals', locations: ['C11-D-1'] },
      { id: '217', category: 'PT-6 engine', subcategory: 'Big PT-6 parts', locations: ['C11-A', 'C-11-B'] },
      { id: '218', category: 'PT-6 engine', subcategory: 'Bolts', locations: ['C11-B-2'] },
      { id: '219', category: 'PT-6 engine', subcategory: 'Filters', locations: ['C11-B-3'] },
      { id: '220', category: 'PT-6 engine', subcategory: 'O-Rings', locations: ['C11-B-1'] },
      { id: '221', category: 'Pumps', subcategory: 'Fuel pumps', locations: ['C17-B'] },
      { id: '222', category: 'Pumps', subcategory: 'Vacuum dry air pumps (RAP)', locations: ['C17-B'] },
      { id: '223', category: 'Robinson', subcategory: 'Avionics', locations: ['C9-D-5'] },
      { id: '224', category: 'Robinson', subcategory: 'Bearing - Jurnals', locations: ['C9-D-2'] },
      { id: '225', category: 'Robinson', subcategory: 'Big Robinson parts', locations: ['C8-D'] },
      { id: '226', category: 'Robinson', subcategory: 'Bolts', locations: ['C9-D-2'] },
      { id: '227', category: 'Robinson', subcategory: 'Collective foam grib', locations: ['C9-D-4'] },
      { id: '228', category: 'Robinson', subcategory: 'Counter weights', locations: ['C9-D-2'] },
      { id: '229', category: 'Robinson', subcategory: 'Gaskets', locations: ['C9-D-4'] },
      { id: '230', category: 'Robinson', subcategory: 'Hinge assy', locations: ['C9-D-1'] },
      { id: '231', category: 'Robinson', subcategory: 'Hoses', locations: ['C9-B'] },
      { id: '232', category: 'Robinson', subcategory: 'O-Rings', locations: ['C9-D-1'] },
      { id: '233', category: 'Robinson', subcategory: 'Palnut', locations: ['C9-D-3'] },
      { id: '234', category: 'Robinson', subcategory: 'Panels', locations: ['C9-D-5'] },
      { id: '235', category: 'Robinson', subcategory: 'Retainers', locations: ['C9-D-1'] },
      { id: '236', category: 'Robinson', subcategory: 'Rod ends', locations: ['C9-D-1'] },
      { id: '237', category: 'Robinson', subcategory: 'Seals', locations: ['C9-D-1'] },
      { id: '238', category: 'Robinson', subcategory: 'Shims', locations: ['C9-D-1'] },
      { id: '239', category: 'Robinson', subcategory: 'Washers', locations: ['C9-D-3'] },
      { id: '240', category: 'Socata', subcategory: 'Big parts', locations: ['C14-A', 'C14-B', 'C14-C', 'C14-D', 'C14-E'] },
      { id: '241', category: 'Socata', subcategory: 'N40 - N49', locations: ['C13-E-6'] },
      { id: '242', category: 'Socata', subcategory: 'N50', locations: ['C13-B-1'] },
      { id: '243', category: 'Socata', subcategory: 'N51', locations: ['C13-B-2', 'C13-B-3', 'C13-B-4'] },
      { id: '244', category: 'Socata', subcategory: 'N52', locations: ['C13-B-5'] },
      { id: '245', category: 'Socata', subcategory: 'N53', locations: ['C13-B-5'] },
      { id: '246', category: 'Socata', subcategory: 'N54', locations: ['C13-B-6', 'C13-C-1'] },
      { id: '247', category: 'Socata', subcategory: 'N55', locations: ['C13-C-1'] },
      { id: '248', category: 'Socata', subcategory: 'N56', locations: ['C13-C-1'] },
      { id: '249', category: 'Socata', subcategory: 'N57', locations: ['C13-C-2', 'C13-C-3'] },
      { id: '250', category: 'Socata', subcategory: 'N58 - N59', locations: ['C13-C-3'] },
      { id: '251', category: 'Socata', subcategory: 'N60 - N61', locations: ['C13-C-4'] },
      { id: '252', category: 'Socata', subcategory: 'N62 - N64', locations: ['C13-C-5'] },
      { id: '253', category: 'Socata', subcategory: 'N65 - N69', locations: ['C13-C-6'] },
      { id: '254', category: 'Socata', subcategory: 'N70', locations: ['C13-D-1'] },
      { id: '255', category: 'Socata', subcategory: 'N71', locations: ['C13-D-1'] },
      { id: '256', category: 'Socata', subcategory: 'N72 - N73', locations: ['C13-D-2'] },
      { id: '257', category: 'Socata', subcategory: 'N74 - N75', locations: ['C13-D-3'] },
      { id: '258', category: 'Socata', subcategory: 'N76 - N77', locations: ['C13-D-4'] },
      { id: '259', category: 'Socata', subcategory: 'N78 - N79', locations: ['C13-D-5'] },
      { id: '260', category: 'Socata', subcategory: 'TB09 Mixed', locations: ['C12-D-1'] },
      { id: '261', category: 'Socata', subcategory: 'TB10 Bolts', locations: ['C12-B-5'] },
      { id: '262', category: 'Socata', subcategory: 'TB10 Hinge', locations: ['C12-B-1'] },
      { id: '263', category: 'Socata', subcategory: 'TB10 Mixed', locations: ['C12-B-2', 'C12-B-4', 'C12-B-6'] },
      { id: '264', category: 'Socata', subcategory: 'TB10 Nuts', locations: ['C12-B-6'] },
      { id: '265', category: 'Socata', subcategory: 'TB10 Pin', locations: ['C12-B-3'] },
      { id: '266', category: 'Socata', subcategory: 'TB10 Reinfort', locations: ['C12-B-3'] },
      { id: '267', category: 'Socata', subcategory: 'TB10 Ring', locations: ['C12-B-1'] },
      { id: '268', category: 'Socata', subcategory: 'TB10 Spacer', locations: ['C12-B-3'] },
      { id: '269', category: 'Socata', subcategory: 'TB10 Spring', locations: ['C12-B-3'] },
      { id: '270', category: 'Socata', subcategory: 'TB20 Mixed', locations: ['C12-B-1', 'C12-B-2', 'C12-B-3'] },
      { id: '271', category: 'Socata', subcategory: 'TB30 Mixed', locations: ['C12-D-2'] },
    ];

    // ============================================================
    // GEMINI AI SERVICE (via serverless function)
    // ============================================================

    const GeminiService = {
      buildSystemPrompt: (sops, glossary, contacts, mode, isStepMode = false, dailyTasks = [], knowledgeBase = []) => {
        const sopSummaries = sops.map(sop =>
          `## ${sop.title} (Category: ${sop.category})\n${sop.content}`
        ).join('\n\n---\n\n');

        const glossaryRef = glossary.map(t =>
          `- **${t.name}** (${t.type}): ${t.meaning}${t.context ? ' — ' + t.context : ''}`
        ).join('\n');

        const contactsRef = contacts.map(c =>
          `- **${c.name}** — ${c.role}${c.phone ? ', Phone: ' + c.phone : ''}${c.email ? ', Email: ' + c.email : ''}`
        ).join('\n');

        const dailyTasksRef = dailyTasks.length > 0 ? dailyTasks.map(dt =>
          `## ${dt.title} (Category: ${dt.category})\n${dt.content}`
        ).join('\n\n---\n\n') : '';

        const kbRef = knowledgeBase.length > 0 ? knowledgeBase.map(kb =>
          `## ${kb.title} (Category: ${kb.category})\n${kb.content}`
        ).join('\n\n---\n\n') : '';

        if (isStepMode) {
          return `You are CAT, the onboarding assistant for Copenhagen AirTaxi A/S. Generate a COMPLETE step-by-step guide based on the SOPs provided.

YOUR RESPONSE MUST BE VALID JSON IN THIS EXACT FORMAT:
{
  "title": "Short procedure title",
  "steps": [
    {
      "title": "Short step title",
      "content": "Detailed instruction for this step. Use markdown formatting.",
      "tip": "Optional helpful tip, or null"
    }
  ]
}

RULES:
1. Return ALL steps in a single response — do NOT return one step at a time
2. Follow the SOP and daily task content EXACTLY — do not rephrase, skip, or invent steps
3. Each step should be ONE clear action
4. Keep instructions clear and simple for newcomers
5. Include helpful tips from the SOP or daily tasks when relevant
6. When multiple SOPs or daily tasks are relevant, combine them into one sequential guide
7. Do NOT ask clarifying questions — give the complete generic procedure
8. Use glossary terms where helpful to explain abbreviations
9. Also reference knowledge base articles when they provide relevant context

AVAILABLE SOPS:
${sopSummaries}

GLOSSARY REFERENCE:
${glossaryRef}

CONTACTS DIRECTORY:
${contactsRef}
${dailyTasksRef ? `\nDAILY TASKS REFERENCE:\n${dailyTasksRef}` : ''}
${kbRef ? `\nKNOWLEDGE BASE REFERENCE:\n${kbRef}` : ''}`;
        }

        return `You are CAT, the onboarding assistant for Copenhagen AirTaxi A/S, a Danish aircraft maintenance company. You help new employees understand and follow company procedures. Keep all responses CONCISE and newcomer-friendly.

RESPONSE RULES:

1. PROCEDURAL QUESTIONS (how do I..., how to..., what's the process for..., steps to...):
   - Give a SHORT summary (2-4 sentences max) explaining what the procedure involves
   - Name which SOP(s) or daily task(s) are relevant, e.g. "This is covered in the **Goods Receiving** SOP" or "See the **Monitor Part Requests** daily task"
   - If multiple SOPs or daily tasks apply, briefly explain why
   - Also check the Knowledge Base for relevant reference articles
   - Do NOT include the full procedure steps or quote large sections
   - ALWAYS end your response with this exact tag on its own line:
   %%GUIDE_OFFER%%

2. SIMPLE QUESTIONS (definitions, abbreviations, contacts, factual lookups):
   - Answer directly and concisely (1-3 sentences)
   - Use the glossary for terms and abbreviations
   - Use the contacts directory for "who handles X" questions
   - Use daily tasks for questions about recurring responsibilities and routines
   - Use the knowledge base for reference information and how-to articles
   - Do NOT include %%GUIDE_OFFER%% for these

3. FOLLOW-UP QUESTIONS (asked while a guide is open):
   - Answer the specific question concisely
   - Reference the relevant step or SOP section
   - Keep it focused — the guide panel handles the walkthrough

CRITICAL RULES:
- ALWAYS check if a question involves non-EU countries (USA, UK, etc.) — the Import and End-Use Certification SOP takes precedence
- Be specific with system paths (e.g., "P.O. Manager > Purchase Order Receiving")
- NEVER dump large blocks of SOP text — keep chat responses brief and helpful
- You are helping newcomers, so use clear language and avoid jargon without explanation

AVAILABLE SOPS:
${sopSummaries}

GLOSSARY REFERENCE:
${glossaryRef}

CONTACTS DIRECTORY:
${contactsRef}
${dailyTasksRef ? `\nDAILY TASKS REFERENCE:\n${dailyTasksRef}` : ''}
${kbRef ? `\nKNOWLEDGE BASE REFERENCE:\n${kbRef}` : ''}`;
      },

      chat: async (messages, sops, glossary, contacts, mode, dailyTasks = [], knowledgeBase = []) => {
        const isStepMode = mode === 'stepbystep';
        const systemPrompt = GeminiService.buildSystemPrompt(sops, glossary, contacts, mode, isStepMode, dailyTasks, knowledgeBase);

        const geminiMessages = messages.map(msg => ({
          role: msg.type === 'user' ? 'user' : 'model',
          parts: [{ text: msg.content }]
        }));

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: geminiMessages,
              systemPrompt: systemPrompt
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'API request failed');
          }

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

          if (isStepMode) {
            try {
              const jsonMatch = text.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
              }
            } catch (e) {
              return { type: 'text', content: text };
            }
          }

          return text;
        } catch (error) {
          console.error('Gemini API error:', error);
          throw error;
        }
      }
    };

    // ============================================================
    // NAV ITEMS CONFIGURATION
    // ============================================================

    const NAV_ITEMS = [
      { id: 'ask-cat', label: 'Ask CAT', icon: 'chat' },
      { id: 'contacts', label: 'Contacts', icon: 'people' },
      { id: 'daily-tasks', label: 'Daily Tasks', icon: 'checklist' },
      { id: 'glossary', label: 'Glossary', icon: 'book' },
      { id: 'knowledge-base', label: 'Knowledge Base', icon: 'lightbulb' },
      { id: 'part-locations', label: 'Part Locations', icon: 'warehouse' },
      { id: 'pricing', label: 'Pricing', icon: 'pricing' },
      { id: 'sop-archive', label: 'SOP Archive', icon: 'document' },
    ];

    // ============================================================
    // SVG ICONS
    // ============================================================

    function NavIcon({ name, className = "w-5 h-5" }) {
      const icons = {
        chat: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
        document: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        book: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
        people: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
        checklist: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
        lightbulb: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
        warehouse: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 21V8l9-5 9 5v13M3 21h18M7 21v-6h4v6M13 21v-6h4v6M3 8h18M7 12h2M15 12h2" /></svg>,
        pricing: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>,
        admin: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        logout: <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
      };
      return icons[name] || null;
    }

    // ============================================================
    // MAIN APP
    // ============================================================

    function App() {
      const [currentUser, setCurrentUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [sops, setSops] = useState([]);
      const [categories, setCategories] = useState([]);
      const [glossary, setGlossary] = useState([]);
      const [contacts, setContacts] = useState([]);
      const [dailyTasks, setDailyTasks] = useState([]);
      const [knowledgeBase, setKnowledgeBase] = useState([]);
      const [pricing, setPricing] = useState([]);
      const [partLocations, setPartLocations] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [dataError, setDataError] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);

      // Firebase Auth listener
      useEffect(() => {
        if (!auth) { setAuthLoading(false); return; }
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          if (user && db) {
            try {
              const userDoc = await FirestoreService.upsertUser(user.uid, user.email);
              setIsAdmin(userDoc.role === 'admin');
            } catch (e) {
              console.warn('Could not load user role:', e);
              setIsAdmin(false);
            }
          } else {
            setIsAdmin(false);
          }
          setCurrentUser(user);
          setAuthLoading(false);
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        const init = async () => {
          if (!db) {
            setDataError('Database not configured. Please contact your administrator.');
            setIsLoading(false);
            return;
          }

          try {
            let [loadedSops, loadedGlossary, loadedContacts, loadedDailyTasks, loadedKnowledgeBase, loadedPricing, loadedPartLocations] = await Promise.all([
              FirestoreService.getSOPs(),
              FirestoreService.getGlossary(),
              FirestoreService.getContacts(),
              FirestoreService.getDailyTasks(),
              FirestoreService.getKnowledgeBase(),
              FirestoreService.getPricing(),
              FirestoreService.getPartLocations(),
            ]);

            // Seed defaults if collections are empty (first-time setup)
            if (loadedSops.length === 0) {
              await FirestoreService.seedCollection('sops', DEFAULT_SOPS);
              loadedSops = DEFAULT_SOPS;
            }
            if (loadedGlossary.length === 0) {
              await FirestoreService.seedCollection('glossary', INITIAL_GLOSSARY);
              loadedGlossary = INITIAL_GLOSSARY;
            }
            if (loadedContacts.length === 0) {
              await FirestoreService.seedCollection('contacts', INITIAL_CONTACTS);
              loadedContacts = INITIAL_CONTACTS;
            }
            if (loadedDailyTasks.length === 0) {
              await FirestoreService.seedCollection('dailyTasks', DEFAULT_DAILY_TASKS);
              loadedDailyTasks = DEFAULT_DAILY_TASKS;
            }
            if (loadedPartLocations.length === 0) {
              await FirestoreService.seedCollection('partLocations', INITIAL_PART_LOCATIONS);
              loadedPartLocations = INITIAL_PART_LOCATIONS;
            }
            // Knowledge Base and Pricing start empty — no seeding needed

            // Migrate SOPs missing sopNumber
            const unnumbered = loadedSops.filter(s => !s.sopNumber);
            if (unnumbered.length > 0) {
              let maxNum = loadedSops.reduce((max, s) => Math.max(max, s.sopNumber || 0), 0);
              unnumbered.sort((a, b) => a.title.localeCompare(b.title));
              for (const s of unnumbered) {
                s.sopNumber = ++maxNum;
                await FirestoreService.updateSOP(s.id, { sopNumber: s.sopNumber });
              }
            }

            // Migrate Daily Tasks missing dtNumber
            const unnumberedDt = loadedDailyTasks.filter(t => !t.dtNumber);
            if (unnumberedDt.length > 0) {
              let maxDt = loadedDailyTasks.reduce((max, t) => Math.max(max, t.dtNumber || 0), 0);
              unnumberedDt.sort((a, b) => a.title.localeCompare(b.title));
              for (const t of unnumberedDt) {
                t.dtNumber = ++maxDt;
                await FirestoreService.updateDailyTask(t.id, { dtNumber: t.dtNumber });
              }
            }

            // Migrate Knowledge Base articles missing kbNumber
            const unnumberedKb = loadedKnowledgeBase.filter(a => !a.kbNumber);
            if (unnumberedKb.length > 0) {
              let maxKb = loadedKnowledgeBase.reduce((max, a) => Math.max(max, a.kbNumber || 0), 0);
              unnumberedKb.sort((a, b) => a.title.localeCompare(b.title));
              for (const a of unnumberedKb) {
                a.kbNumber = ++maxKb;
                await FirestoreService.updateKBArticle(a.id, { kbNumber: a.kbNumber });
              }
            }

            setSops(loadedSops);
            setGlossary(loadedGlossary);
            setContacts(loadedContacts);
            setDailyTasks(loadedDailyTasks);
            setKnowledgeBase(loadedKnowledgeBase);
            setPricing(loadedPricing);
            setPartLocations(loadedPartLocations);
            setCategories(DEFAULT_CATEGORIES);
          } catch (error) {
            console.error('Failed to load data from Firestore:', error);
            setDataError('Could not connect to the database. Please check your connection and refresh.');
          }

          setIsLoading(false);
        };
        init();
      }, []);

      const handleLogout = () => {
        if (auth) auth.signOut();
      };

      // -- SOP handlers (Firestore-only) --
      const handleSopCreate = async (sopData) => {
        const now = new Date().toISOString();
        const maxNumber = sops.reduce((max, s) => Math.max(max, s.sopNumber || 0), 0);
        const sopNumber = maxNumber + 1;
        const firestoreId = await FirestoreService.saveSOP({ ...sopData, sopNumber });
        const newSop = { ...sopData, id: firestoreId, sopNumber, createdAt: now, updatedAt: now };
        const updated = [...sops, newSop].sort((a, b) => (a.sopNumber || 0) - (b.sopNumber || 0));
        setSops(updated);
        return firestoreId;
      };

      const handleSopUpdate = async (id, sopData) => {
        const now = new Date().toISOString();
        await FirestoreService.updateSOP(id, sopData);
        const updated = sops.map(s => s.id === id ? { ...s, ...sopData, updatedAt: now } : s);
        setSops(updated);
      };

      const handleSopDelete = async (id) => {
        await FirestoreService.deleteSOP(id);
        setSops(prev => prev.filter(s => s.id !== id));
      };

      // -- Glossary handlers --
      const handleTermCreate = async (termData) => {
        const firestoreId = await FirestoreService.saveGlossaryEntry(termData);
        const updated = [...glossary, { ...termData, id: firestoreId }].sort((a, b) => a.name.localeCompare(b.name));
        setGlossary(updated);
        return firestoreId;
      };

      const handleTermUpdate = async (id, termData) => {
        await FirestoreService.updateGlossaryEntry(id, termData);
        setGlossary(prev => prev.map(t => t.id === id ? { ...t, ...termData } : t));
      };

      const handleTermDelete = async (id) => {
        await FirestoreService.deleteGlossaryEntry(id);
        setGlossary(prev => prev.filter(t => t.id !== id));
      };

      // -- Contact handlers --
      const handleContactCreate = async (contactData) => {
        const firestoreId = await FirestoreService.saveContact(contactData);
        const updated = [...contacts, { ...contactData, id: firestoreId }].sort((a, b) => a.name.localeCompare(b.name));
        setContacts(updated);
        return firestoreId;
      };

      const handleContactUpdate = async (id, contactData) => {
        await FirestoreService.updateContact(id, contactData);
        setContacts(prev => prev.map(c => c.id === id ? { ...c, ...contactData } : c));
      };

      const handleContactDelete = async (id) => {
        await FirestoreService.deleteContact(id);
        setContacts(prev => prev.filter(c => c.id !== id));
      };

      // -- Daily Tasks handlers --
      const handleDailyTaskCreate = async (taskData) => {
        const now = new Date().toISOString();
        const maxDtNumber = dailyTasks.reduce((max, t) => Math.max(max, t.dtNumber || 0), 0);
        const dtNumber = maxDtNumber + 1;
        const firestoreId = await FirestoreService.saveDailyTask({ ...taskData, dtNumber });
        const newTask = { ...taskData, id: firestoreId, dtNumber, createdAt: now, updatedAt: now };
        const updated = [...dailyTasks, newTask].sort((a, b) => (a.dtNumber || 0) - (b.dtNumber || 0));
        setDailyTasks(updated);
        return firestoreId;
      };

      const handleDailyTaskUpdate = async (id, taskData) => {
        const now = new Date().toISOString();
        await FirestoreService.updateDailyTask(id, taskData);
        setDailyTasks(prev => prev.map(t => t.id === id ? { ...t, ...taskData, updatedAt: now } : t));
      };

      const handleDailyTaskDelete = async (id) => {
        await FirestoreService.deleteDailyTask(id);
        setDailyTasks(prev => prev.filter(t => t.id !== id));
      };

      // -- Knowledge Base handlers --
      const handleKBCreate = async (articleData) => {
        const now = new Date().toISOString();
        const maxKbNumber = knowledgeBase.reduce((max, a) => Math.max(max, a.kbNumber || 0), 0);
        const kbNumber = maxKbNumber + 1;
        const firestoreId = await FirestoreService.saveKBArticle({ ...articleData, kbNumber });
        const newArticle = { ...articleData, id: firestoreId, kbNumber, createdAt: now, updatedAt: now };
        const updated = [...knowledgeBase, newArticle].sort((a, b) => (a.kbNumber || 0) - (b.kbNumber || 0));
        setKnowledgeBase(updated);
        return firestoreId;
      };

      const handleKBArticleUpdate = async (id, articleData) => {
        const now = new Date().toISOString();
        await FirestoreService.updateKBArticle(id, articleData);
        setKnowledgeBase(prev => prev.map(a => a.id === id ? { ...a, ...articleData, updatedAt: now } : a));
      };

      const handleKBDelete = async (id) => {
        await FirestoreService.deleteKBArticle(id);
        setKnowledgeBase(prev => prev.filter(a => a.id !== id));
      };

      // -- Pricing handlers --
      const handlePricingEntityCreate = async (entityData) => {
        const now = new Date().toISOString();
        const firestoreId = await FirestoreService.savePricingEntity(entityData);
        const newEntity = { ...entityData, id: firestoreId, createdAt: now, updatedAt: now };
        const updated = [...pricing, newEntity].sort((a, b) => a.entityName.localeCompare(b.entityName));
        setPricing(updated);
        return firestoreId;
      };

      const handlePricingEntityUpdate = async (id, entityData) => {
        const now = new Date().toISOString();
        await FirestoreService.updatePricingEntity(id, entityData);
        setPricing(prev => prev.map(p => p.id === id ? { ...p, ...entityData, updatedAt: now } : p));
      };

      const handlePricingEntityDelete = async (id) => {
        await FirestoreService.deletePricingEntity(id);
        setPricing(prev => prev.filter(p => p.id !== id));
      };

      // -- Part Locations handlers --
      const handlePartLocationCreate = async (data) => {
        const now = new Date().toISOString();
        const firestoreId = await FirestoreService.savePartLocation(data);
        const newEntry = { ...data, id: firestoreId, createdAt: now, updatedAt: now };
        const updated = [...partLocations, newEntry].sort((a, b) =>
          a.category.localeCompare(b.category) || a.subcategory.localeCompare(b.subcategory)
        );
        setPartLocations(updated);
        return firestoreId;
      };

      const handlePartLocationUpdate = async (id, data) => {
        const now = new Date().toISOString();
        await FirestoreService.updatePartLocation(id, data);
        const updated = partLocations.map(p => p.id === id ? { ...p, ...data, updatedAt: now } : p)
          .sort((a, b) => a.category.localeCompare(b.category) || a.subcategory.localeCompare(b.subcategory));
        setPartLocations(updated);
      };

      const handlePartLocationDelete = async (id) => {
        await FirestoreService.deletePartLocation(id);
        setPartLocations(prev => prev.filter(p => p.id !== id));
      };

      if (authLoading || isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">{authLoading ? 'Checking authentication...' : 'Loading data...'}</p>
              <p className="text-gray-400 text-xs mt-2">{authLoading ? 'Please wait' : 'Connecting to database'}</p>
            </div>
          </div>
        );
      }

      if (!currentUser) return <LoginScreen />;

      return (
        <AppShell
          currentUser={currentUser}
          isAdmin={isAdmin}
          sops={sops}
          categories={categories}
          glossary={glossary}
          contacts={contacts}
          dailyTasks={dailyTasks}
          knowledgeBase={knowledgeBase}
          pricing={pricing}
          partLocations={partLocations}
          dataError={dataError}
          onDismissError={() => setDataError(null)}
          onSopCreate={handleSopCreate}
          onSopUpdate={handleSopUpdate}
          onSopDelete={handleSopDelete}
          onTermCreate={handleTermCreate}
          onTermUpdate={handleTermUpdate}
          onTermDelete={handleTermDelete}
          onContactCreate={handleContactCreate}
          onContactUpdate={handleContactUpdate}
          onContactDelete={handleContactDelete}
          onDailyTaskCreate={handleDailyTaskCreate}
          onDailyTaskUpdate={handleDailyTaskUpdate}
          onDailyTaskDelete={handleDailyTaskDelete}
          onKBCreate={handleKBCreate}
          onKBArticleUpdate={handleKBArticleUpdate}
          onKBDelete={handleKBDelete}
          onPricingEntityCreate={handlePricingEntityCreate}
          onPricingEntityUpdate={handlePricingEntityUpdate}
          onPricingEntityDelete={handlePricingEntityDelete}
          onPartLocationCreate={handlePartLocationCreate}
          onPartLocationUpdate={handlePartLocationUpdate}
          onPartLocationDelete={handlePartLocationDelete}
          onLogout={handleLogout}
        />
      );
    }

    // ============================================================
    // LOGIN SCREEN
    // ============================================================

    function LoginScreen() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!auth) { setError('Authentication service unavailable'); return; }
        setIsLoading(true);
        setError('');
        try {
          await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
          const messages = {
            'auth/invalid-email': 'Invalid email address',
            'auth/user-not-found': 'No account found with this email',
            'auth/wrong-password': 'Incorrect password',
            'auth/invalid-credential': 'Invalid email or password',
            'auth/too-many-requests': 'Too many attempts. Please try again later',
            'auth/user-disabled': 'This account has been disabled',
          };
          setError(messages[err.code] || 'Login failed. Please try again.');
          setIsLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden" style={{background: 'linear-gradient(145deg, #05101f 0%, #091d3e 50%, #07111f 100%)'}}>
          {/* Ambient glow orbs */}
          <div className="login-orb-1 pointer-events-none absolute" style={{width: 560, height: 560, borderRadius: '50%', background: 'radial-gradient(circle, rgba(0,102,204,0.9) 0%, transparent 70%)', top: '-10%', left: '-12%'}} />
          <div className="login-orb-2 pointer-events-none absolute" style={{width: 420, height: 420, borderRadius: '50%', background: 'radial-gradient(circle, rgba(0,148,255,0.85) 0%, transparent 70%)', bottom: '-5%', right: '-8%'}} />

          {/* Card */}
          <div className="login-card-animate relative z-10 bg-white w-full max-w-md" style={{borderRadius: '22px', boxShadow: '0 32px 90px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.05)', padding: '38px 38px 30px'}}>

            {/* Company logo */}
            <div className="flex justify-center mb-5">
              <img src="/company_logo_blu.png" alt="Copenhagen Air Taxi" style={{height: 70, width: 'auto', maxWidth: '85%', objectFit: 'contain'}} />
            </div>

            {/* Fade divider */}
            <div style={{height: 1, background: 'linear-gradient(90deg, transparent, #e2e8f0 25%, #e2e8f0 75%, transparent)', marginBottom: 26}} />

            <h1 className="text-center font-bold text-gray-800 mb-1" style={{fontSize: '1.05rem', letterSpacing: '-0.015em'}}>CAT Onboard</h1>
            <p className="text-center text-gray-400 text-sm mb-7">Sign in to continue</p>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-gray-500 mb-1.5" style={{fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.07em', textTransform: 'uppercase'}}>Email</label>
                <input
                  type="email" value={email} onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-3 border rounded-xl text-gray-800 text-sm placeholder-gray-300 outline-none"
                  style={{borderColor: '#e2e8f0', transition: 'border-color 0.2s ease, box-shadow 0.2s ease'}}
                  onFocus={e => { e.target.style.borderColor = '#0066CC'; e.target.style.boxShadow = '0 0 0 3px rgba(0,102,204,0.12)'; }}
                  onBlur={e => { e.target.style.borderColor = '#e2e8f0'; e.target.style.boxShadow = 'none'; }}
                  placeholder="you@aircat.dk" disabled={isLoading} required />
              </div>
              <div>
                <label className="block text-gray-500 mb-1.5" style={{fontSize: '0.7rem', fontWeight: 700, letterSpacing: '0.07em', textTransform: 'uppercase'}}>Password</label>
                <input
                  type="password" value={password} onChange={(e) => setPassword(e.target.value)}
                  className="w-full px-4 py-3 border rounded-xl text-gray-800 text-sm placeholder-gray-300 outline-none"
                  style={{borderColor: '#e2e8f0', transition: 'border-color 0.2s ease, box-shadow 0.2s ease'}}
                  onFocus={e => { e.target.style.borderColor = '#0066CC'; e.target.style.boxShadow = '0 0 0 3px rgba(0,102,204,0.12)'; }}
                  onBlur={e => { e.target.style.borderColor = '#e2e8f0'; e.target.style.boxShadow = 'none'; }}
                  placeholder="••••••••" disabled={isLoading} required />
              </div>
              {error && (
                <div className="bg-red-50 text-red-600 px-4 py-3 rounded-xl text-sm flex items-center gap-2">
                  <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  {error}
                </div>
              )}
              <button
                type="submit" disabled={isLoading}
                className="w-full text-white py-3 rounded-xl font-semibold text-sm disabled:opacity-60"
                style={{marginTop: 8, background: 'linear-gradient(135deg, #0066CC 0%, #0050a0 100%)', boxShadow: '0 4px 16px rgba(0,102,204,0.4)', transition: 'transform 0.15s ease, box-shadow 0.2s ease'}}
                onMouseEnter={e => { if (!isLoading) { e.currentTarget.style.boxShadow = '0 7px 24px rgba(0,102,204,0.55)'; e.currentTarget.style.transform = 'translateY(-1px)'; }}}
                onMouseLeave={e => { e.currentTarget.style.boxShadow = '0 4px 16px rgba(0,102,204,0.4)'; e.currentTarget.style.transform = 'translateY(0)'; }}
                onMouseDown={e => { e.currentTarget.style.transform = 'translateY(0px)'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,102,204,0.35)'; }}
              >
                {isLoading ? (
                  <span className="flex items-center justify-center gap-2">
                    <svg className="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    Signing in…
                  </span>
                ) : 'Sign In'}
              </button>
            </form>

            <p className="text-center text-xs mt-6" style={{color: 'rgba(0,0,0,0.28)'}}>
              Need access?{' '}
              <a href="mailto:sep@aircat.dk" style={{color: '#0066CC', fontWeight: 500, transition: 'color 0.15s'}}
                onMouseEnter={e => e.currentTarget.style.color = '#0050a0'}
                onMouseLeave={e => e.currentTarget.style.color = '#0066CC'}>
                sep@aircat.dk
              </a>
            </p>
          </div>
        </div>
      );
    }

    // ============================================================
    // APP SHELL (Sidebar + Content Area)
    // ============================================================

    function AppShell(props) {
      const { currentUser, isAdmin, sops, categories, glossary, contacts, dailyTasks, knowledgeBase, pricing, partLocations,
        dataError, onDismissError,
        onSopCreate, onSopUpdate, onSopDelete,
        onTermCreate, onTermUpdate, onTermDelete,
        onContactCreate, onContactUpdate, onContactDelete,
        onDailyTaskCreate, onDailyTaskUpdate, onDailyTaskDelete,
        onKBCreate, onKBArticleUpdate, onKBDelete,
        onPricingEntityCreate, onPricingEntityUpdate, onPricingEntityDelete,
        onPartLocationCreate, onPartLocationUpdate, onPartLocationDelete,
        onLogout } = props;
      const [currentPage, setCurrentPage] = useState('ask-cat');
      const [deepLinkTarget, setDeepLinkTarget] = useState(null);

      const handleNavigate = useCallback((page, target) => {
        setCurrentPage(page);
        setDeepLinkTarget(target || null);
      }, []);

      const handleCrossLinkClick = useCallback((type, number) => {
        const pageMap = { SOP: 'sop-archive', DT: 'daily-tasks', KB: 'knowledge-base' };
        const page = pageMap[type];
        if (page) handleNavigate(page, { type, number });
      }, [handleNavigate]);

      const renderPage = () => {
        switch (currentPage) {
          case 'ask-cat':
            return <AskCATPage sops={sops} glossary={glossary} contacts={contacts} dailyTasks={dailyTasks} knowledgeBase={knowledgeBase} />;
          case 'sop-archive':
            return <SOPArchivePage sops={sops} glossary={glossary} contacts={contacts} dailyTasks={dailyTasks} knowledgeBase={knowledgeBase} onNavigate={handleNavigate} onCrossLink={handleCrossLinkClick} deepLinkTarget={deepLinkTarget} onClearDeepLink={() => setDeepLinkTarget(null)} />;
          case 'daily-tasks':
            return <DailyTasksPage dailyTasks={dailyTasks} glossary={glossary} onNavigate={handleNavigate} onCrossLink={handleCrossLinkClick} deepLinkTarget={deepLinkTarget} onClearDeepLink={() => setDeepLinkTarget(null)} />;
          case 'knowledge-base':
            return <KnowledgeBasePage knowledgeBase={knowledgeBase} glossary={glossary} onNavigate={handleNavigate} onCrossLink={handleCrossLinkClick} deepLinkTarget={deepLinkTarget} onClearDeepLink={() => setDeepLinkTarget(null)} />;
          case 'glossary':
            return <GlossaryPage glossary={glossary} />;
          case 'contacts':
            return <ContactsPage contacts={contacts} />;
          case 'part-locations':
            return <PartLocationsPage partLocations={partLocations} />;
          case 'pricing':
            return <PricingPage pricing={pricing} />;
          case 'admin':
            if (!isAdmin) return <AskCATPage sops={sops} glossary={glossary} contacts={contacts} dailyTasks={dailyTasks} knowledgeBase={knowledgeBase} />;
            return (
              <AdminPage
                sops={sops}
                categories={categories}
                glossary={glossary}
                contacts={contacts}
                dailyTasks={dailyTasks}
                knowledgeBase={knowledgeBase}
                pricing={pricing}
                partLocations={partLocations}
                onSopCreate={onSopCreate}
                onSopUpdate={onSopUpdate}
                onSopDelete={onSopDelete}
                onTermCreate={onTermCreate}
                onTermUpdate={onTermUpdate}
                onTermDelete={onTermDelete}
                onContactCreate={onContactCreate}
                onContactUpdate={onContactUpdate}
                onContactDelete={onContactDelete}
                onDailyTaskCreate={onDailyTaskCreate}
                onDailyTaskUpdate={onDailyTaskUpdate}
                onDailyTaskDelete={onDailyTaskDelete}
                onKBCreate={onKBCreate}
                onKBArticleUpdate={onKBArticleUpdate}
                onKBDelete={onKBDelete}
                onPricingEntityCreate={onPricingEntityCreate}
                onPricingEntityUpdate={onPricingEntityUpdate}
                onPricingEntityDelete={onPricingEntityDelete}
                onPartLocationCreate={onPartLocationCreate}
                onPartLocationUpdate={onPartLocationUpdate}
                onPartLocationDelete={onPartLocationDelete}
              />
            );
          default:
            return <AskCATPage sops={sops} glossary={glossary} contacts={contacts} dailyTasks={dailyTasks} knowledgeBase={knowledgeBase} />;
        }
      };

      return (
        <div className="h-screen flex" style={{background: '#eef2f7'}}>
          {/* Sidebar */}
          <aside className="w-60 flex flex-col flex-shrink-0" style={{background: '#0c1d3d'}}>
            {/* Top brand accent line */}
            <div style={{height: 3, flexShrink: 0, background: 'linear-gradient(90deg, #0066CC 0%, #33aaff 100%)'}} />

            {/* Company Logo */}
            <div className="px-5 pt-5 pb-3" style={{textAlign: 'center'}}>
              <img src="/company_logo.png" alt="Copenhagen Air Taxi" style={{height: 48, display: 'inline-block', maxWidth: '100%', objectFit: 'contain'}} />
              <div style={{marginTop: 12, height: 1, background: 'rgba(255,255,255,0.07)'}} />
              <div style={{marginTop: 7, fontSize: '0.6rem', fontWeight: 700, letterSpacing: '0.1em', textTransform: 'uppercase', color: 'rgba(255,255,255,0.25)'}}>Onboard Portal</div>
            </div>

            {/* Navigation Items */}
            <nav className="flex-1 px-3 py-2 space-y-0.5">
              {NAV_ITEMS.map((item) => {
                const isActive = currentPage === item.id;
                return (
                  <button
                    key={item.id}
                    onClick={() => handleNavigate(item.id)}
                    className={`sidebar-nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium${isActive ? ' sidebar-active' : ''}`}
                  >
                    <NavIcon name={item.icon} className="w-5 h-5 flex-shrink-0" />
                    {item.label}
                  </button>
                );
              })}
            </nav>

            {/* Bottom Section: Admin + User/Logout */}
            <div className="px-3 pb-3 pt-2 space-y-2" style={{borderTop: '1px solid rgba(255,255,255,0.07)'}}>

              {/* Admin — only visible to admins */}
              {isAdmin && (
                <button
                  onClick={() => handleNavigate('admin')}
                  className={`sidebar-nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium${currentPage === 'admin' ? ' sidebar-active' : ''}`}
                  style={currentPage !== 'admin' ? {border: '1px solid rgba(255,255,255,0.13)'} : {}}
                >
                  <NavIcon name="admin" className="w-4 h-4 flex-shrink-0" />
                  Admin Panel
                </button>
              )}

              {/* User identity + logout — unified strip */}
              {currentUser && (
                <div className="flex items-center gap-2.5 px-2 py-2 rounded-lg" style={{background: 'rgba(255,255,255,0.06)'}}>
                  <div className="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold" style={{background: 'rgba(0,102,204,0.85)', color: '#fff'}}>
                    {currentUser.email[0].toUpperCase()}
                  </div>
                  <div className="flex-1 min-w-0 text-xs truncate" style={{color: 'rgba(255,255,255,0.5)'}}>
                    {currentUser.email}
                  </div>
                  <button onClick={onLogout} title="Sign out" className="sidebar-logout-btn flex-shrink-0 p-1.5 rounded-md">
                    <NavIcon name="logout" className="w-4 h-4" />
                  </button>
                </div>
              )}
            </div>
          </aside>

          {/* Main Content Area */}
          <main className="flex-1 overflow-hidden flex flex-col">
            {/* Error banner */}
            {dataError && (
              <div className="flex-shrink-0 bg-amber-50 border-b border-amber-200 px-4 py-2.5 flex items-center justify-between">
                <div className="flex items-center gap-2 text-sm text-amber-700">
                  <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" /></svg>
                  {dataError}
                </div>
                <button onClick={onDismissError} className="text-amber-600 hover:text-amber-800 p-1">
                  <CloseIcon className="w-4 h-4" />
                </button>
              </div>
            )}
            <div className="flex-1 overflow-auto">
              {renderPage()}
            </div>
          </main>
        </div>
      );
    }

    // ============================================================
    // PAGE: ASK CAT (Chat + Inline Wizard)
    // ============================================================

    function AskCATPage({ sops, glossary, contacts, dailyTasks = [], knowledgeBase = [] }) {
      const [messages, setMessages] = useState([
        { id: 'welcome', type: 'bot', content: 'Hello! I\'m CAT, your onboarding assistant. Ask me anything about procedures, daily tasks, terms, or contacts at Copenhagen AirTaxi A/S.' }
      ]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [guide, setGuide] = useState(null); // { title, steps[], currentIndex, completed }
      const [viewMode, setViewMode] = useState('chat'); // 'chat' | 'wizard'
      const [isExpanded, setIsExpanded] = useState(false);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);
      const lastQuestionRef = useRef('');

      const scrollToBottom = useCallback(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, []);

      useEffect(() => {
        scrollToBottom();
      }, [messages, isLoading, scrollToBottom]);

      // -- Chat message sending --
      const sendMessage = useCallback(async (text) => {
        if (!text.trim() || isLoading) return;
        const userMessage = { id: `user-${Date.now()}`, type: 'user', content: text };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setIsLoading(true);
        lastQuestionRef.current = text;

        try {
          const chatHistory = [...messages.filter(m => m.id !== 'welcome'), userMessage].map(m => ({
            type: m.type === 'user' ? 'user' : 'bot',
            content: m.content
          }));
          const response = await GeminiService.chat(chatHistory, sops, glossary, contacts, 'documentation', dailyTasks, knowledgeBase);
          const botContent = typeof response === 'string' ? response : (response?.content || 'I couldn\'t generate a response.');
          setMessages(prev => [...prev, { id: `bot-${Date.now()}`, type: 'bot', content: botContent }]);
        } catch (error) {
          setMessages(prev => [...prev, { id: `err-${Date.now()}`, type: 'bot', content: 'Sorry, I encountered an error. Please try again.' }]);
        } finally {
          setIsLoading(false);
          inputRef.current?.focus();
        }
      }, [messages, isLoading, sops, glossary, contacts, dailyTasks, knowledgeBase]);

      // -- Start step-by-step guide --
      const startGuide = useCallback(async () => {
        if (isLoading) return;
        setIsLoading(true);
        const question = lastQuestionRef.current || 'Please guide me through this step by step.';

        try {
          const chatHistory = messages.filter(m => m.id !== 'welcome').map(m => ({
            type: m.type === 'user' ? 'user' : 'bot',
            content: m.content
          }));
          chatHistory.push({ type: 'user', content: question });
          const response = await GeminiService.chat(chatHistory, sops, glossary, contacts, 'stepbystep', dailyTasks, knowledgeBase);

          if (response && typeof response === 'object' && response.steps && response.steps.length > 0) {
            setGuide({
              title: response.title || question,
              steps: response.steps,
              currentIndex: 0,
              completed: false
            });
            setViewMode('wizard');
          } else {
            setMessages(prev => [...prev, { id: `bot-${Date.now()}`, type: 'bot', content: 'Sorry, I couldn\'t generate a step-by-step guide for this. Try rephrasing your question.' }]);
          }
        } catch (error) {
          setMessages(prev => [...prev, { id: `err-${Date.now()}`, type: 'bot', content: 'Sorry, I encountered an error generating the guide. Please try again.' }]);
        } finally {
          setIsLoading(false);
        }
      }, [messages, isLoading, sops, glossary, contacts, dailyTasks, knowledgeBase]);

      // -- Wizard step navigation (all local, no API) --
      const nextStep = useCallback(() => {
        if (!guide) return;
        const nextIndex = guide.currentIndex + 1;
        if (nextIndex >= guide.steps.length) {
          setGuide(prev => ({ ...prev, completed: true }));
        } else {
          setGuide(prev => ({ ...prev, currentIndex: nextIndex }));
        }
      }, [guide]);

      const prevStep = useCallback(() => {
        if (!guide || guide.currentIndex === 0) return;
        setGuide(prev => ({ ...prev, currentIndex: prev.currentIndex - 1 }));
      }, [guide]);

      const exitGuide = useCallback(() => {
        setGuide(null);
        setViewMode('chat');
      }, []);

      const askAboutStep = useCallback(() => {
        if (!guide) return;
        const step = guide.steps[guide.currentIndex];
        if (step) {
          setInput(`I have a question about "${step.title}": `);
          setViewMode('chat');
          setTimeout(() => inputRef.current?.focus(), 100);
        }
      }, [guide]);

      const handleSubmit = (e) => {
        e.preventDefault();
        sendMessage(input);
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSubmit(e);
        }
      };

      const renderMessageContent = (msg) => {
        let content = msg.content;
        const hasGuideOffer = content.includes('%%GUIDE_OFFER%%');
        if (hasGuideOffer) content = content.replace('%%GUIDE_OFFER%%', '').trim();

        return (
          <React.Fragment>
            <div className="prose text-sm" dangerouslySetInnerHTML={{ __html: renderMarkdown(content) }} />
            {hasGuideOffer && !guide && (
              <button
                onClick={() => startGuide()}
                disabled={isLoading}
                className="mt-3 inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white text-sm font-medium rounded-lg transition-colors"
              >
                Guide me step-by-step
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
              </button>
            )}
          </React.Fragment>
        );
      };

      // ==================== WIZARD VIEW ====================
      if (viewMode === 'wizard' && guide) {
        return (
          <GuidedProcessWizard
            guide={guide}
            onNext={nextStep}
            onBack={prevStep}
            onExit={exitGuide}
            onAskAboutStep={askAboutStep}
          />
        );
      }

      // ==================== CHAT VIEW ====================
      return (
        <div className="h-full flex flex-col bg-gray-50">
          {/* Chat Header */}
          <div className="flex-shrink-0 px-6 py-4 bg-white border-b border-gray-200">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-lg font-semibold text-gray-800">Ask CAT</h1>
                <p className="text-xs text-gray-400 mt-0.5">Your AI assistant for procedures, terms, and questions</p>
              </div>
              <div className="flex gap-2">
                {guide && !guide.completed && (
                  <button
                    onClick={() => setViewMode('wizard')}
                    className="flex items-center gap-2 px-3.5 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 text-sm font-medium rounded-lg transition-colors border border-blue-200"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                    Return to guide (step {guide.currentIndex + 1}/{guide.steps.length})
                  </button>
                )}
                <ExpandToggleButton isExpanded={isExpanded} onToggle={() => setIsExpanded(!isExpanded)} />
              </div>
            </div>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto px-6 py-4 space-y-4">
            {messages.map((msg) => (
              <div key={msg.id} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'} fade-in`}>
                {msg.type === 'bot' && (
                  <div className="w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mr-2.5 mt-0.5">
                    <span className="text-white text-xs font-bold">C</span>
                  </div>
                )}
                <div style={{ maxWidth: isExpanded ? '90%' : '75%', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }} className={`px-4 py-3 rounded-2xl ${
                  msg.type === 'user'
                    ? 'bg-blue-500 text-white rounded-br-md'
                    : 'bg-white border border-gray-200 text-gray-800 rounded-bl-md'
                }`}>
                  {msg.type === 'user' ? (
                    <p className="text-sm">{msg.content}</p>
                  ) : (
                    renderMessageContent(msg)
                  )}
                </div>
              </div>
            ))}

            {/* Typing indicator */}
            {isLoading && (
              <div className="flex justify-start fade-in">
                <div className="w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mr-2.5 mt-0.5">
                  <span className="text-white text-xs font-bold">C</span>
                </div>
                <div className="bg-white border border-gray-200 px-4 py-3 rounded-2xl rounded-bl-md">
                  <div className="flex gap-1.5">
                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style={{ animationDelay: '0s' }}></span>
                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style={{ animationDelay: '0.2s' }}></span>
                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style={{ animationDelay: '0.4s' }}></span>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div className="flex-shrink-0 px-6 py-4 bg-white border-t border-gray-200">
            <form onSubmit={handleSubmit} className="flex gap-3">
              <input
                ref={inputRef}
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Type your question..."
                className="flex-1 px-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                disabled={isLoading}
              />
              <button
                type="submit"
                disabled={!input.trim() || isLoading}
                className="px-4 py-2.5 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-xl transition-colors flex-shrink-0"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
              </button>
            </form>
          </div>
        </div>
      );
    }

    // ============================================================
    // GUIDED PROCESS WIZARD (reusable)
    // ============================================================

    function GuidedProcessWizard({ guide, onNext, onBack, onExit, onAskAboutStep }) {
      const { title, steps, currentIndex, completed } = guide;
      const currentStep = !completed ? steps[currentIndex] : null;
      const isLastStep = currentIndex >= steps.length - 1;

      return (
        <div className="h-full flex flex-col bg-gray-50">
          {/* Wizard Header */}
          <div className="flex-shrink-0 text-white px-6 py-4" style={{background: '#1a3a6b', boxShadow: 'inset 6px 0 12px -4px rgba(0,0,0,0.45), 0 2px 6px rgba(0,0,0,0.18)'}}>
            <div className="max-w-3xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="font-semibold text-base">{title}</h1>
                <p className="text-xs mt-0.5" style={{color: 'rgba(255,255,255,0.55)'}}>
                  {completed ? `All ${steps.length} steps completed` : `Step ${currentIndex + 1} of ${steps.length}`}
                </p>
              </div>
              <button onClick={onExit} className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg transition-colors hover:bg-white/10" style={{color: 'rgba(255,255,255,0.7)'}}>
                <CloseIcon className="w-4 h-4" />
                Exit guide
              </button>
            </div>
          </div>

          {/* Progress Bar */}
          <div className="flex-shrink-0 bg-gray-50 px-6 py-3 border-b border-gray-200">
            <div className="max-w-3xl mx-auto flex gap-1.5">
              {steps.map((_, i) => (
                <div key={i} className={`h-2 flex-1 rounded-full transition-all duration-300 ${
                  completed ? 'bg-blue-600'
                    : i < currentIndex ? 'bg-blue-600'
                    : i === currentIndex ? 'bg-blue-400'
                    : 'bg-gray-200'
                }`} />
              ))}
            </div>
          </div>

          {/* Wizard Content (scrollable) */}
          <div className="flex-1 overflow-y-auto px-6 py-6">
            <div className="max-w-3xl mx-auto">

              {/* Completed Steps (badges) */}
              {currentIndex > 0 && !completed && (
                <div className="mb-5">
                  <div className="flex flex-wrap gap-2">
                    {steps.slice(0, currentIndex).map((step, i) => (
                      <span key={i} className="inline-flex items-center gap-1.5 text-xs text-blue-700 bg-blue-50 px-2.5 py-1 rounded-full">
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                        {step.title}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Current Step */}
              {currentStep && !completed && (
                <div className="bg-white rounded-2xl border border-gray-200 shadow-sm fade-in" key={currentIndex}>
                  <div className="px-8 py-6">
                    <span className="inline-block text-xs font-bold text-blue-600 bg-blue-50 px-2.5 py-1 rounded-full mb-3">Step {currentIndex + 1}</span>
                    <h2 className="text-xl font-bold text-gray-900 mb-4">{currentStep.title}</h2>
                    <div className="prose text-sm text-gray-700" dangerouslySetInnerHTML={{ __html: renderMarkdown(currentStep.content) }} />

                    {currentStep.tip && (
                      <div className="mt-5 bg-amber-50 border border-amber-200 rounded-xl p-4 flex gap-3">
                        <svg className="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <p className="text-sm text-amber-800">{currentStep.tip}</p>
                      </div>
                    )}
                  </div>

                  <div className="px-8 py-5 border-t border-gray-100 flex items-center justify-between">
                    {onAskAboutStep ? (
                      <button onClick={onAskAboutStep} className="text-sm text-gray-500 hover:text-blue-600 transition-colors">
                        I have a question about this step
                      </button>
                    ) : <div />}
                    <div className="flex items-center gap-2">
                      {currentIndex > 0 && (
                        <button
                          onClick={onBack}
                          className="px-4 py-2.5 text-sm font-medium text-gray-600 hover:text-gray-900 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors flex items-center gap-2"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>
                          Back
                        </button>
                      )}
                      <button
                        onClick={onNext}
                        className="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2"
                      >
                        {isLastStep ? 'Complete' : 'Done, next step'}
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Completion State */}
              {completed && (
                <div className="bg-white rounded-2xl border border-gray-200 shadow-sm fade-in">
                  <div className="px-8 py-10 text-center">
                    <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h2 className="text-xl font-bold text-gray-900 mb-1">All done!</h2>
                    <p className="text-sm text-gray-500 mb-6">You've completed all {steps.length} steps.</p>

                    <div className="text-left max-w-md mx-auto space-y-2 mb-8">
                      {steps.map((step, i) => (
                        <div key={i} className="flex items-center gap-2.5 text-sm">
                          <div className="w-5 h-5 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                          </div>
                          <span className="text-gray-600">{step.title}</span>
                        </div>
                      ))}
                    </div>

                    <button onClick={onExit} className="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                      Done
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: SOP ARCHIVE
    // ============================================================

    function SOPArchivePage({ sops, glossary, contacts, dailyTasks, knowledgeBase, onNavigate, onCrossLink, deepLinkTarget, onClearDeepLink }) {
      const [selectedSopId, setSelectedSopId] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState('All');
      const [guide, setGuide] = useState(null);
      const [guideLoading, setGuideLoading] = useState(false);
      const [guideError, setGuideError] = useState(null);
      const [isExpanded, setIsExpanded] = useState(false);
      const contentRef = useRef(null);

      const categories = useMemo(() => {
        const unique = [...new Set(sops.map(s => s.category))];
        return ['All', ...unique.sort()];
      }, [sops]);

      const filteredSops = useMemo(() => {
        return sops.filter(sop => {
          const matchesSearch = !searchQuery || sop.title.toLowerCase().includes(searchQuery.toLowerCase());
          const matchesCategory = activeCategory === 'All' || sop.category === activeCategory;
          return matchesSearch && matchesCategory;
        }).sort((a, b) => (a.sopNumber || 0) - (b.sopNumber || 0));
      }, [sops, searchQuery, activeCategory]);

      const selectedSop = useMemo(() => {
        return sops.find(s => s.id === selectedSopId) || null;
      }, [sops, selectedSopId]);

      useEffect(() => {
        if (contentRef.current) contentRef.current.scrollTop = 0;
      }, [selectedSopId]);

      // Deep-link: auto-select SOP by number
      useEffect(() => {
        if (deepLinkTarget && deepLinkTarget.type === 'SOP') {
          const target = sops.find(s => s.sopNumber === deepLinkTarget.number);
          if (target) {
            setSelectedSopId(target.id);
            setActiveCategory('All');
            setSearchQuery('');
          }
          onClearDeepLink();
        }
      }, [deepLinkTarget, sops, onClearDeepLink]);

      const handleContentClick = createCrossLinkHandler(
        'SOP',
        (number) => sops.find(s => s.sopNumber === number),
        (target) => { setSelectedSopId(target.id); setActiveCategory('All'); setSearchQuery(''); },
        onCrossLink
      );

      // -- Guided Process --
      const startGuidedProcess = useCallback(async () => {
        if (!selectedSop || guideLoading) return;
        setGuideLoading(true);
        setGuideError(null);
        try {
          const chatHistory = [{ type: 'user', content: `Guide me step by step through: ${selectedSop.title}` }];
          const response = await GeminiService.chat(chatHistory, sops, glossary, contacts, 'stepbystep', dailyTasks, knowledgeBase);
          if (response && typeof response === 'object' && response.steps && response.steps.length > 0) {
            setGuide({ title: response.title || selectedSop.title, steps: response.steps, currentIndex: 0, completed: false });
          } else {
            setGuideError('Could not generate a guided process for this SOP. Please try again.');
          }
        } catch (error) {
          setGuideError('Something went wrong. Please try again.');
        } finally {
          setGuideLoading(false);
        }
      }, [selectedSop, guideLoading, sops, glossary, contacts, dailyTasks, knowledgeBase]);

      const nextStep = useCallback(() => {
        if (!guide) return;
        const nextIndex = guide.currentIndex + 1;
        if (nextIndex >= guide.steps.length) {
          setGuide(prev => ({ ...prev, completed: true }));
        } else {
          setGuide(prev => ({ ...prev, currentIndex: nextIndex }));
        }
      }, [guide]);

      const prevStep = useCallback(() => {
        if (!guide || guide.currentIndex === 0) return;
        setGuide(prev => ({ ...prev, currentIndex: prev.currentIndex - 1 }));
      }, [guide]);

      const exitGuide = useCallback(() => {
        setGuide(null);
      }, []);

      // -- Wizard view --
      if (guide) {
        return (
          <GuidedProcessWizard
            guide={guide}
            onNext={nextStep}
            onBack={prevStep}
            onExit={exitGuide}
          />
        );
      }

      return (
        <div className="h-full flex overflow-hidden">
          {/* Left Panel — SOP List */}
          <div className="flex-shrink-0 bg-white border-r border-gray-200 flex flex-col h-full overflow-hidden" style={{ width: isExpanded ? 0 : 320, opacity: isExpanded ? 0 : 1, transition: 'width 350ms cubic-bezier(0.4,0,0.2,1), opacity 200ms ease' }}>
            {/* Header & Search */}
            <div className="p-4 border-b border-gray-100">
              <h2 className="text-lg font-semibold text-gray-800 mb-3">SOP Archive</h2>
              <div className="relative">
                <svg className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search SOPs..."
                  className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                />
              </div>
            </div>

            {/* Category Filters */}
            <div className="px-4 py-3 border-b border-gray-100 flex gap-1.5 flex-wrap">
              {categories.map((cat) => (
                <button
                  key={cat}
                  onClick={() => setActiveCategory(cat)}
                  className={`px-2.5 py-1 rounded-full text-xs font-medium transition-colors ${
                    activeCategory === cat
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {cat}
                </button>
              ))}
            </div>

            {/* SOP List */}
            <div className="flex-1 overflow-y-auto">
              {filteredSops.length === 0 ? (
                <div className="p-6 text-center">
                  <EmptyStateIcon className="w-10 h-10 text-gray-300 mx-auto mb-2" />
                  <p className="text-sm text-gray-400">No SOPs found</p>
                </div>
              ) : (
                filteredSops.map((sop) => {
                  const isSelected = sop.id === selectedSopId;
                  return (
                    <button
                      key={sop.id}
                      onClick={() => setSelectedSopId(sop.id)}
                      className={`w-full text-left px-4 py-3 border-b border-gray-50 transition-colors ${
                        isSelected
                          ? 'bg-blue-50 border-l-[3px] border-l-blue-500'
                          : 'hover:bg-gray-50 border-l-[3px] border-l-transparent'
                      }`}
                    >
                      {sop.sopNumber && <div className="text-sm text-blue-600 font-bold font-mono">{formatSopNumber(sop.sopNumber)}</div>}
                      <div className={`text-sm font-medium ${isSelected ? 'text-blue-700' : 'text-gray-800'}`}>
                        {sop.title}
                      </div>
                      <div className="text-xs text-gray-400 mt-0.5">{sop.category}{sop.updatedAt ? ` · ${timeAgo(sop.updatedAt)}` : ''}</div>
                    </button>
                  );
                })
              )}
            </div>

            {/* Footer count */}
            <div className="px-4 py-2.5 border-t border-gray-100 bg-gray-50">
              <p className="text-xs text-gray-400">{filteredSops.length} of {sops.length} SOPs</p>
            </div>
          </div>

          {/* Right Panel — SOP Content */}
          <div className="flex-1 flex flex-col overflow-hidden bg-gray-50">

            {/* Sticky header: title + action buttons (only when an SOP is selected) */}
            {selectedSop && (
              <div className="flex-shrink-0 bg-white border-b border-gray-200 shadow-sm">
                <div className="mx-auto px-8 py-3 flex items-center justify-between" style={{ maxWidth: isExpanded ? '9999px' : '64rem', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }}>
                  <div className="min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <span className="text-xs font-medium bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full flex-shrink-0">
                        {selectedSop.category}
                      </span>
                      {selectedSop.sopNumber && <span className="text-xs font-mono font-semibold text-blue-400">{formatSopNumber(selectedSop.sopNumber)}</span>}
                    </div>
                    <h1 className="text-base font-semibold text-gray-900 leading-snug">{selectedSop.title}</h1>
                  </div>
                  <div className="flex gap-2 flex-shrink-0 ml-4">
                    <ExpandToggleButton isExpanded={isExpanded} onToggle={() => setIsExpanded(!isExpanded)} />
                    <button
                      onClick={startGuidedProcess}
                      disabled={guideLoading}
                      className="flex items-center gap-2 px-3.5 py-2 bg-emerald-500 hover:bg-emerald-600 disabled:bg-emerald-300 text-white text-sm font-medium rounded-lg transition-colors"
                    >
                      {guideLoading ? (
                        <React.Fragment>
                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                          Generating guide...
                        </React.Fragment>
                      ) : (
                        <React.Fragment>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                          Start guided process
                        </React.Fragment>
                      )}
                    </button>
                    <button
                      onClick={() => onNavigate('ask-cat')}
                      className="flex items-center gap-2 px-3.5 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors"
                    >
                      <NavIcon name="chat" className="w-4 h-4 text-white" />
                      Ask CAT
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Scrollable body */}
            <div ref={contentRef} className="flex-1 overflow-y-auto">
              {!selectedSop ? (
                <div className="h-full flex flex-col items-center justify-center text-center p-8">
                  <div className="w-16 h-16 bg-gray-200 rounded-2xl flex items-center justify-center mb-4">
                    <NavIcon name="document" className="w-8 h-8 text-gray-400" />
                  </div>
                  <h3 className="text-lg font-medium text-gray-500 mb-1">Select an SOP to view</h3>
                  <p className="text-sm text-gray-400">Choose a procedure from the list to read its full content</p>
                </div>
              ) : (
                <div className="mx-auto px-8 py-6" style={{ maxWidth: isExpanded ? '9999px' : '64rem', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }}>

                  {/* Guide error */}
                  {guideError && (
                    <div className="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-sm flex items-center justify-between">
                      <span>{guideError}</span>
                      <button onClick={() => setGuideError(null)} className="text-red-500 hover:text-red-700 p-1">
                        <CloseIcon className="w-4 h-4" />
                      </button>
                    </div>
                  )}

                  {/* SOP Body */}
                  <div className="bg-white rounded-xl border border-gray-200 p-6 md:p-8">
                    {renderRichContent(selectedSop.content, glossary, handleContentClick)}
                  </div>

                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: DAILY TASKS
    // ============================================================

    function DailyTasksPage({ dailyTasks, glossary, onNavigate, onCrossLink, deepLinkTarget, onClearDeepLink }) {
      const [selectedTaskId, setSelectedTaskId] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [isExpanded, setIsExpanded] = useState(false);
      const contentRef = useRef(null);

      const filteredTasks = useMemo(() => {
        return dailyTasks.filter(task => {
          return !searchQuery || task.title.toLowerCase().includes(searchQuery.toLowerCase()) || task.category.toLowerCase().includes(searchQuery.toLowerCase());
        }).sort((a, b) => (a.dtNumber || 0) - (b.dtNumber || 0));
      }, [dailyTasks, searchQuery]);

      const selectedTask = useMemo(() => {
        return dailyTasks.find(t => t.id === selectedTaskId) || null;
      }, [dailyTasks, selectedTaskId]);

      useEffect(() => {
        if (contentRef.current) contentRef.current.scrollTop = 0;
      }, [selectedTaskId]);

      // Deep-link: auto-select task by number
      useEffect(() => {
        if (deepLinkTarget && deepLinkTarget.type === 'DT') {
          const target = dailyTasks.find(t => t.dtNumber === deepLinkTarget.number);
          if (target) {
            setSelectedTaskId(target.id);
            setSearchQuery('');
          }
          onClearDeepLink();
        }
      }, [deepLinkTarget, dailyTasks, onClearDeepLink]);

      const handleContentClick = createCrossLinkHandler(
        'DT',
        (number) => dailyTasks.find(t => t.dtNumber === number),
        (target) => { setSelectedTaskId(target.id); setSearchQuery(''); },
        onCrossLink
      );

      return (
        <div className="h-full flex overflow-hidden">
          {/* Left Panel — Task List */}
          <div className="flex-shrink-0 bg-white border-r border-gray-200 flex flex-col h-full overflow-hidden" style={{ width: isExpanded ? 0 : 320, opacity: isExpanded ? 0 : 1, transition: 'width 350ms cubic-bezier(0.4,0,0.2,1), opacity 200ms ease' }}>
            <div className="p-4 border-b border-gray-100">
              <h2 className="text-lg font-semibold text-gray-800 mb-3">Daily Tasks</h2>
              <div className="relative">
                <svg className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search tasks..."
                  className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                />
              </div>
            </div>

            {/* Task List */}
            <div className="flex-1 overflow-y-auto">
              {filteredTasks.length === 0 ? (
                <div className="p-6 text-center">
                  <EmptyStateIcon className="w-10 h-10 text-gray-300 mx-auto mb-2" />
                  <p className="text-sm text-gray-400">No tasks found</p>
                </div>
              ) : (
                filteredTasks.map((task) => {
                  const isSelected = task.id === selectedTaskId;
                  return (
                    <button
                      key={task.id}
                      onClick={() => setSelectedTaskId(task.id)}
                      className={`w-full text-left px-4 py-3 border-b border-gray-50 transition-colors ${
                        isSelected
                          ? 'bg-blue-50 border-l-[3px] border-l-blue-500'
                          : 'hover:bg-gray-50 border-l-[3px] border-l-transparent'
                      }`}
                    >
                      {task.dtNumber && <div className="text-sm text-blue-600 font-bold font-mono">{formatDtNumber(task.dtNumber)}</div>}
                      <div className={`text-sm font-medium ${isSelected ? 'text-blue-700' : 'text-gray-800'}`}>
                        {task.title}
                      </div>
                      <div className="text-xs text-gray-400 mt-0.5">{task.category}</div>
                    </button>
                  );
                })
              )}
            </div>

            <div className="px-4 py-2.5 border-t border-gray-100 bg-gray-50">
              <p className="text-xs text-gray-400">{filteredTasks.length} of {dailyTasks.length} tasks</p>
            </div>
          </div>

          {/* Right Panel — Task Content */}
          <div className="flex-1 flex flex-col overflow-hidden bg-gray-50">

            {/* Sticky header: title + action buttons (only when a task is selected) */}
            {selectedTask && (
              <div className="flex-shrink-0 bg-white border-b border-gray-200 shadow-sm">
                <div className="mx-auto px-8 py-3 flex items-center justify-between" style={{ maxWidth: isExpanded ? '9999px' : '64rem', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }}>
                  <div className="min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <span className="text-xs font-medium bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full flex-shrink-0">
                        {selectedTask.category}
                      </span>
                      {selectedTask.dtNumber && <span className="text-xs font-mono font-semibold text-blue-400">{formatDtNumber(selectedTask.dtNumber)}</span>}
                    </div>
                    <h1 className="text-base font-semibold text-gray-900 leading-snug">{selectedTask.title}</h1>
                  </div>
                  <div className="flex gap-2 flex-shrink-0 ml-4">
                    <ExpandToggleButton isExpanded={isExpanded} onToggle={() => setIsExpanded(!isExpanded)} />
                    <button
                      onClick={() => onNavigate('ask-cat')}
                      className="flex items-center gap-2 px-3.5 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors"
                    >
                      <NavIcon name="chat" className="w-4 h-4 text-white" />
                      Ask CAT about this
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Scrollable body */}
            <div ref={contentRef} className="flex-1 overflow-y-auto">
              {!selectedTask ? (
                <div className="h-full flex flex-col items-center justify-center text-center p-8">
                  <div className="w-16 h-16 bg-gray-200 rounded-2xl flex items-center justify-center mb-4">
                    <NavIcon name="checklist" className="w-8 h-8 text-gray-400" />
                  </div>
                  <h3 className="text-lg font-medium text-gray-500 mb-1">Select a task to view</h3>
                  <p className="text-sm text-gray-400">Choose a daily task from the list to read its details</p>
                </div>
              ) : (
                <div className="mx-auto px-8 py-6" style={{ maxWidth: isExpanded ? '9999px' : '64rem', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }}>
                  <div className="bg-white rounded-xl border border-gray-200 p-6 md:p-8">
                    {renderRichContent(selectedTask.content, glossary, handleContentClick)}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: KNOWLEDGE BASE
    // ============================================================

    function KnowledgeBasePage({ knowledgeBase, glossary, onNavigate, onCrossLink, deepLinkTarget, onClearDeepLink }) {
      const [selectedArticleId, setSelectedArticleId] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState('All');
      const [isExpanded, setIsExpanded] = useState(false);
      const contentRef = useRef(null);

      const categories = useMemo(() => {
        const unique = [...new Set(knowledgeBase.map(a => a.category))];
        return ['All', ...unique.sort()];
      }, [knowledgeBase]);

      const filteredArticles = useMemo(() => {
        return knowledgeBase.filter(article => {
          const matchesSearch = !searchQuery || article.title.toLowerCase().includes(searchQuery.toLowerCase());
          const matchesCategory = activeCategory === 'All' || article.category === activeCategory;
          return matchesSearch && matchesCategory;
        }).sort((a, b) => (a.kbNumber || 0) - (b.kbNumber || 0));
      }, [knowledgeBase, searchQuery, activeCategory]);

      const selectedArticle = useMemo(() => {
        return knowledgeBase.find(a => a.id === selectedArticleId) || null;
      }, [knowledgeBase, selectedArticleId]);

      useEffect(() => {
        if (contentRef.current) contentRef.current.scrollTop = 0;
      }, [selectedArticleId]);

      // Deep-link: auto-select article by number
      useEffect(() => {
        if (deepLinkTarget && deepLinkTarget.type === 'KB') {
          const target = knowledgeBase.find(a => a.kbNumber === deepLinkTarget.number);
          if (target) {
            setSelectedArticleId(target.id);
            setActiveCategory('All');
            setSearchQuery('');
          }
          onClearDeepLink();
        }
      }, [deepLinkTarget, knowledgeBase, onClearDeepLink]);

      const handleContentClick = createCrossLinkHandler(
        'KB',
        (number) => knowledgeBase.find(a => a.kbNumber === number),
        (target) => { setSelectedArticleId(target.id); setActiveCategory('All'); setSearchQuery(''); },
        onCrossLink
      );

      return (
        <div className="h-full flex overflow-hidden">
          {/* Left Panel — Article List */}
          <div className="flex-shrink-0 bg-white border-r border-gray-200 flex flex-col h-full overflow-hidden" style={{ width: isExpanded ? 0 : 320, opacity: isExpanded ? 0 : 1, transition: 'width 350ms cubic-bezier(0.4,0,0.2,1), opacity 200ms ease' }}>
            <div className="p-4 border-b border-gray-100">
              <h2 className="text-lg font-semibold text-gray-800 mb-3">Knowledge Base</h2>
              <div className="relative">
                <svg className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search articles..."
                  className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                />
              </div>
            </div>

            {/* Category Filters */}
            {categories.length > 1 && (
              <div className="px-4 py-3 border-b border-gray-100 flex gap-1.5 flex-wrap">
                {categories.map((cat) => (
                  <button
                    key={cat}
                    onClick={() => setActiveCategory(cat)}
                    className={`px-2.5 py-1 rounded-full text-xs font-medium transition-colors ${
                      activeCategory === cat
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                  >
                    {cat}
                  </button>
                ))}
              </div>
            )}

            {/* Article List */}
            <div className="flex-1 overflow-y-auto">
              {filteredArticles.length === 0 ? (
                <div className="p-6 text-center">
                  <EmptyStateIcon className="w-10 h-10 text-gray-300 mx-auto mb-2" />
                  <p className="text-sm text-gray-400">{knowledgeBase.length === 0 ? 'No articles yet' : 'No articles found'}</p>
                </div>
              ) : (
                filteredArticles.map((article) => {
                  const isSelected = article.id === selectedArticleId;
                  return (
                    <button
                      key={article.id}
                      onClick={() => setSelectedArticleId(article.id)}
                      className={`w-full text-left px-4 py-3 border-b border-gray-50 transition-colors ${
                        isSelected
                          ? 'bg-blue-50 border-l-[3px] border-l-blue-500'
                          : 'hover:bg-gray-50 border-l-[3px] border-l-transparent'
                      }`}
                    >
                      {article.kbNumber && <div className="text-sm text-blue-600 font-bold font-mono">{formatKbNumber(article.kbNumber)}</div>}
                      <div className={`text-sm font-medium ${isSelected ? 'text-blue-700' : 'text-gray-800'}`}>
                        {article.title}
                      </div>
                      <div className="text-xs text-gray-400 mt-0.5">{article.category}{article.updatedAt ? ` · ${timeAgo(article.updatedAt)}` : ''}</div>
                    </button>
                  );
                })
              )}
            </div>

            <div className="px-4 py-2.5 border-t border-gray-100 bg-gray-50">
              <p className="text-xs text-gray-400">{filteredArticles.length} of {knowledgeBase.length} articles</p>
            </div>
          </div>

          {/* Right Panel — Article Content */}
          <div className="flex-1 flex flex-col overflow-hidden bg-gray-50">

            {/* Sticky header: title + action buttons (only when an article is selected) */}
            {selectedArticle && (
              <div className="flex-shrink-0 bg-white border-b border-gray-200 shadow-sm">
                <div className="mx-auto px-8 py-3 flex items-center justify-between" style={{ maxWidth: isExpanded ? '9999px' : '64rem', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }}>
                  <div className="min-w-0">
                    <div className="flex items-center gap-2 mb-0.5">
                      <span className="text-xs font-medium bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full flex-shrink-0">
                        {selectedArticle.category}
                      </span>
                      {selectedArticle.kbNumber && <span className="text-xs font-mono font-semibold text-blue-400">{formatKbNumber(selectedArticle.kbNumber)}</span>}
                    </div>
                    <h1 className="text-base font-semibold text-gray-900 leading-snug">{selectedArticle.title}</h1>
                  </div>
                  <div className="flex gap-2 flex-shrink-0 ml-4">
                    <ExpandToggleButton isExpanded={isExpanded} onToggle={() => setIsExpanded(!isExpanded)} />
                    <button
                      onClick={() => onNavigate('ask-cat')}
                      className="flex items-center gap-2 px-3.5 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors"
                    >
                      <NavIcon name="chat" className="w-4 h-4 text-white" />
                      Ask CAT about this
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Scrollable body */}
            <div ref={contentRef} className="flex-1 overflow-y-auto">
              {!selectedArticle ? (
                <div className="h-full flex flex-col items-center justify-center text-center p-8">
                  <div className="w-16 h-16 bg-gray-200 rounded-2xl flex items-center justify-center mb-4">
                    <NavIcon name="lightbulb" className="w-8 h-8 text-gray-400" />
                  </div>
                  <h3 className="text-lg font-medium text-gray-500 mb-1">Select an article to view</h3>
                  <p className="text-sm text-gray-400">{knowledgeBase.length === 0 ? 'Create articles from the Admin panel' : 'Choose an article from the list to read its content'}</p>
                </div>
              ) : (
                <div className="mx-auto px-8 py-6" style={{ maxWidth: isExpanded ? '9999px' : '64rem', transition: 'max-width 350ms cubic-bezier(0.4,0,0.2,1)' }}>
                  <div className="bg-white rounded-xl border border-gray-200 p-6 md:p-8">
                    {renderRichContent(selectedArticle.content, glossary, handleContentClick)}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: GLOSSARY
    // ============================================================

    function GlossaryPage({ glossary }) {
      const [searchQuery, setSearchQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState('All');

      const categories = useMemo(() => {
        const unique = [...new Set(glossary.map(g => g.category))];
        return ['All', ...unique.sort()];
      }, [glossary]);

      const filteredTerms = useMemo(() => {
        return glossary.filter(term => {
          const q = searchQuery.toLowerCase();
          const matchesSearch = !searchQuery
            || term.name.toLowerCase().includes(q)
            || term.meaning.toLowerCase().includes(q);
          const matchesCategory = activeCategory === 'All' || term.category === activeCategory;
          return matchesSearch && matchesCategory;
        }).sort((a, b) => a.name.localeCompare(b.name));
      }, [glossary, searchQuery, activeCategory]);

      return (
        <div className="h-full overflow-y-auto bg-gray-50">
          <div className="max-w-4xl mx-auto px-8 py-8">
            {/* Header */}
            <div className="mb-6">
              <h1 className="text-2xl font-bold text-gray-800">Glossary</h1>
              <p className="text-gray-500 text-sm mt-1">Aviation abbreviations, terms, and company-specific definitions</p>
            </div>

            {/* Search */}
            <div className="relative max-w-md mb-5">
              <svg className="w-4 h-4 text-gray-400 absolute left-3.5 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search terms or meanings..."
                className="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
              />
            </div>

            {/* Category Tabs */}
            <div className="flex gap-2 flex-wrap mb-6">
              {categories.map((cat) => (
                <button
                  key={cat}
                  onClick={() => setActiveCategory(cat)}
                  className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                    activeCategory === cat
                      ? 'bg-blue-500 text-white'
                      : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'
                  }`}
                >
                  {cat}
                </button>
              ))}
            </div>

            {/* Results Count */}
            <p className="text-xs text-gray-400 mb-4">{filteredTerms.length} term{filteredTerms.length !== 1 ? 's' : ''}</p>

            {/* Term Cards Grid */}
            {filteredTerms.length === 0 ? (
              <div className="text-center py-16">
                <EmptyStateIcon className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                <p className="text-gray-400 text-sm">No terms found</p>
              </div>
            ) : (
              <div className="grid grid-cols-2 gap-4">
                {filteredTerms.map((term) => (
                  <div
                    key={term.id}
                    className="bg-white rounded-xl border border-gray-200 p-5 hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start justify-between mb-2">
                      <h3 className="text-lg font-bold text-gray-900">{term.name}</h3>
                      <span className={`text-xs font-medium px-2 py-0.5 rounded-full flex-shrink-0 ml-2 ${
                        term.type === 'abbreviation'
                          ? 'bg-blue-50 text-blue-600'
                          : 'bg-emerald-50 text-emerald-600'
                      }`}>
                        {term.type === 'abbreviation' ? 'Abbreviation' : 'Term'}
                      </span>
                    </div>
                    <p className="text-sm text-gray-700 mb-2">{term.meaning}</p>
                    {term.context && (
                      <p className="text-xs text-gray-400 mb-3">{term.context}</p>
                    )}
                    <div className="text-xs text-gray-400 pt-2 border-t border-gray-100">{term.category}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: CONTACTS
    // ============================================================

    function ContactsPage({ contacts }) {
      return (
        <div className="h-full overflow-y-auto bg-gray-50">
          <div className="max-w-4xl mx-auto px-8 py-8">
            {/* Header */}
            <div className="mb-6">
              <h1 className="text-2xl font-bold text-gray-800">Contacts</h1>
              <p className="text-gray-500 text-sm mt-1">Internal directory</p>
            </div>

            {/* Table */}
            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-gray-50 border-b border-gray-200">
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Name</th>
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Role</th>
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Phone</th>
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Email</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {contacts.slice().sort((a, b) => a.name.localeCompare(b.name)).map((contact) => (
                    <tr key={contact.id} className="hover:bg-gray-50 transition-colors">
                      <td className="px-6 py-4 text-sm font-medium text-gray-900">{contact.name}</td>
                      <td className="px-6 py-4 text-sm text-gray-600">{contact.role}</td>
                      <td className="px-6 py-4 text-sm text-gray-600">{contact.phone}</td>
                      <td className="px-6 py-4 text-sm">
                        <a href={`mailto:${contact.email}`} className="text-blue-600 hover:text-blue-700 hover:underline">{contact.email}</a>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <p className="text-xs text-gray-400 mt-4">{contacts.length} contact{contacts.length !== 1 ? 's' : ''}</p>
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: PRICING
    // ============================================================

    function PricingPage({ pricing }) {
      const [selectedEntityId, setSelectedEntityId] = useState(pricing.length > 0 ? pricing[0].id : null);
      const [searchQuery, setSearchQuery] = useState('');

      const filteredEntities = useMemo(() => {
        const list = !searchQuery.trim() ? pricing : pricing.filter(e => e.entityName.toLowerCase().includes(searchQuery.toLowerCase()));
        return list.slice().sort((a, b) => a.entityName.localeCompare(b.entityName));
      }, [pricing, searchQuery]);

      const selectedEntity = useMemo(() => pricing.find(e => e.id === selectedEntityId) || null, [pricing, selectedEntityId]);

      // Auto-select first entity if current selection is gone
      useEffect(() => {
        if (!selectedEntity && pricing.length > 0) {
          setSelectedEntityId(pricing[0].id);
        }
      }, [pricing, selectedEntity]);

      if (pricing.length === 0) {
        return (
          <div className="h-full overflow-y-auto bg-gray-50">
            <div className="max-w-4xl mx-auto px-8 py-8">
              <div className="mb-6">
                <h1 className="text-2xl font-bold text-gray-800">Pricing</h1>
                <p className="text-gray-500 text-sm mt-1">Markup tables for customers and entities</p>
              </div>
              <div className="bg-white rounded-xl border border-gray-200 px-8 py-16 text-center">
                <NavIcon name="pricing" className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                <p className="text-gray-400 text-sm">No pricing entities yet. Add them via the Admin panel.</p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="h-full flex bg-gray-50">
          {/* Left sidebar: entity list */}
          <div className="w-80 border-r border-gray-200 bg-white flex flex-col flex-shrink-0">
            <div className="px-4 py-4 border-b border-gray-100">
              <h2 className="text-lg font-semibold text-gray-800 mb-3">Pricing</h2>
              <div className="relative">
                <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search entities..."
                  className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                />
              </div>
            </div>
            <div className="flex-1 overflow-y-auto">
              {filteredEntities.map((entity) => {
                const isActive = entity.id === selectedEntityId;
                return (
                  <button
                    key={entity.id}
                    onClick={() => setSelectedEntityId(entity.id)}
                    className={`w-full text-left px-4 py-3 border-b border-gray-50 transition-colors ${
                      isActive ? 'bg-blue-50 border-l-2 border-l-blue-500' : 'hover:bg-gray-50'
                    }`}
                  >
                    <div className={`text-sm font-medium ${isActive ? 'text-blue-700' : 'text-gray-800'}`}>{entity.entityName}</div>
                    <div className="text-xs text-gray-400 mt-0.5">{(entity.ranges || []).length} markup range{(entity.ranges || []).length !== 1 ? 's' : ''}</div>
                  </button>
                );
              })}
              {filteredEntities.length === 0 && (
                <div className="px-4 py-8 text-center text-gray-400 text-sm">No entities match your search.</div>
              )}
            </div>
            <div className="px-4 py-2 border-t border-gray-100">
              <p className="text-xs text-gray-400">{pricing.length} entit{pricing.length !== 1 ? 'ies' : 'y'}</p>
            </div>
          </div>

          {/* Right side: markup table */}
          <div className="flex-1 overflow-y-auto">
            {selectedEntity ? (
              <div className="max-w-3xl mx-auto px-8 py-8">
                <div className="mb-6">
                  <h1 className="text-2xl font-bold text-gray-800">{selectedEntity.entityName}</h1>
                  <p className="text-gray-500 text-sm mt-1">Markup ranges for this entity</p>
                </div>

                {(selectedEntity.ranges || []).length === 0 ? (
                  <div className="bg-white rounded-xl border border-gray-200 px-8 py-12 text-center">
                    <p className="text-gray-400 text-sm">No markup ranges defined yet.</p>
                  </div>
                ) : (
                  <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <table className="w-full">
                      <thead>
                        <tr className="bg-gray-50 border-b border-gray-200">
                          <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Price Range (DKK)</th>
                          <th className="text-right text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Markup</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-100">
                        {(selectedEntity.ranges || [])
                          .slice()
                          .sort((a, b) => (a.from || 0) - (b.from || 0))
                          .map((range, idx) => (
                          <tr key={idx} className="hover:bg-gray-50 transition-colors">
                            <td className="px-6 py-4 text-sm text-gray-800">
                              {range.from != null ? range.from.toLocaleString('da-DK') : '0'}
                              {' — '}
                              {range.to != null ? range.to.toLocaleString('da-DK') : '∞'}
                              {' DKK'}
                            </td>
                            <td className="px-6 py-4 text-sm font-semibold text-right">
                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                {range.markup}%
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            ) : (
              <div className="h-full flex items-center justify-center">
                <p className="text-gray-400 text-sm">Select an entity to view its markup ranges.</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: PART LOCATIONS
    // ============================================================

    function PartLocationsPage({ partLocations }) {
      const [searchQuery, setSearchQuery] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('');
      const [sortField, setSortField] = useState('category');
      const [sortDir, setSortDir] = useState('asc');

      const categories = useMemo(() => {
        const cats = [...new Set(partLocations.map(p => p.category))];
        return cats.sort((a, b) => a.localeCompare(b));
      }, [partLocations]);

      const filteredData = useMemo(() => {
        let data = partLocations;
        if (categoryFilter) {
          data = data.filter(p => p.category === categoryFilter);
        }
        if (searchQuery.trim()) {
          const q = searchQuery.toLowerCase();
          data = data.filter(p =>
            p.category.toLowerCase().includes(q) ||
            p.subcategory.toLowerCase().includes(q) ||
            (p.locations || []).some(loc => loc.toLowerCase().includes(q))
          );
        }
        data = [...data].sort((a, b) => {
          let cmp = 0;
          if (sortField === 'category') {
            cmp = a.category.localeCompare(b.category) || a.subcategory.localeCompare(b.subcategory);
          } else {
            cmp = a.subcategory.localeCompare(b.subcategory) || a.category.localeCompare(b.category);
          }
          return sortDir === 'asc' ? cmp : -cmp;
        });
        return data;
      }, [partLocations, searchQuery, categoryFilter, sortField, sortDir]);

      const toggleSort = (field) => {
        if (sortField === field) {
          setSortDir(d => d === 'asc' ? 'desc' : 'asc');
        } else {
          setSortField(field);
          setSortDir('asc');
        }
      };

      const SortIcon = ({ field }) => {
        if (sortField !== field) return <svg className="w-3.5 h-3.5 text-gray-300 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>;
        return sortDir === 'asc'
          ? <svg className="w-3.5 h-3.5 text-blue-500 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>
          : <svg className="w-3.5 h-3.5 text-blue-500 ml-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>;
      };

      return (
        <div className="h-full overflow-auto bg-gray-50">
          <div className="max-w-6xl mx-auto px-8 py-8">
            <div className="mb-6">
              <h1 className="text-2xl font-bold text-gray-800">Part Locations</h1>
              <p className="text-gray-500 text-sm mt-1">Warehouse zone and shelf locations for parts and components</p>
            </div>

            {/* Filters */}
            <div className="flex gap-3 mb-4">
              <div className="relative flex-1 max-w-md">
                <SearchIcon className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search category, part type, or location code..."
                  className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                />
              </div>
              <select
                value={categoryFilter}
                onChange={(e) => setCategoryFilter(e.target.value)}
                className="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white"
              >
                <option value="">All Categories</option>
                {categories.map(cat => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </select>
              <div className="flex items-center text-xs text-gray-400 ml-auto">
                {filteredData.length === partLocations.length
                  ? `${partLocations.length} entries`
                  : `${filteredData.length} of ${partLocations.length} entries`}
              </div>
            </div>

            {/* Table */}
            {filteredData.length === 0 ? (
              <div className="bg-white rounded-xl border border-gray-200 px-8 py-16 text-center">
                <NavIcon name="warehouse" className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                <p className="text-gray-400 text-sm">
                  {partLocations.length === 0
                    ? 'No part locations yet. Add them via the Admin panel.'
                    : 'No entries match your search.'}
                </p>
              </div>
            ) : (
              <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <table className="w-full">
                  <thead>
                    <tr className="bg-gray-50 border-b border-gray-200">
                      <th
                        className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3 cursor-pointer select-none hover:text-gray-700"
                        onClick={() => toggleSort('category')}
                      >
                        Category <SortIcon field="category" />
                      </th>
                      <th
                        className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3 cursor-pointer select-none hover:text-gray-700"
                        onClick={() => toggleSort('subcategory')}
                      >
                        Sub-category <SortIcon field="subcategory" />
                      </th>
                      <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">
                        Locations
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {filteredData.map((entry) => (
                      <tr key={entry.id} className="hover:bg-gray-50 transition-colors">
                        <td className="px-6 py-3 text-sm text-gray-600">{entry.category}</td>
                        <td className="px-6 py-3 text-sm font-medium text-gray-800">{entry.subcategory}</td>
                        <td className="px-6 py-3">
                          <div className="flex flex-wrap gap-1.5">
                            {(entry.locations || []).map((loc, i) => (
                              <span key={i} className="inline-flex px-2 py-0.5 bg-slate-100 text-slate-700 text-xs font-mono font-medium rounded">{loc}</span>
                            ))}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============================================================
    // PAGE: ADMIN (Tabbed Interface)
    // ============================================================

    const ADMIN_TABS = [
      { id: 'sops', label: 'SOPs' },
      { id: 'dailyTasks', label: 'Daily Tasks' },
      { id: 'knowledgeBase', label: 'Knowledge Base' },
      { id: 'glossary', label: 'Glossary' },
      { id: 'contacts', label: 'Contacts' },
      { id: 'pricing', label: 'Pricing' },
      { id: 'partLocations', label: 'Part Locations' },
      { id: 'users', label: 'Users' },
    ];

    function AdminPage(props) {
      const { sops, categories, glossary, contacts, dailyTasks, knowledgeBase, pricing, partLocations,
        onSopCreate, onSopUpdate, onSopDelete,
        onTermCreate, onTermUpdate, onTermDelete,
        onContactCreate, onContactUpdate, onContactDelete,
        onDailyTaskCreate, onDailyTaskUpdate, onDailyTaskDelete,
        onKBCreate, onKBArticleUpdate, onKBDelete,
        onPricingEntityCreate, onPricingEntityUpdate, onPricingEntityDelete,
        onPartLocationCreate, onPartLocationUpdate, onPartLocationDelete } = props;
      const [activeTab, setActiveTab] = useState('sops');

      return (
        <div className="h-full overflow-auto bg-gray-50">
          <div className="max-w-5xl mx-auto p-6">
            {/* Header */}
            <div className="mb-6">
              <h1 className="text-2xl font-bold text-gray-800">Admin Panel</h1>
              <p className="text-gray-500 text-sm mt-1">Manage SOPs, daily tasks, knowledge base, glossary, contacts, pricing, and part locations</p>
            </div>

            {/* Tab Bar */}
            <div className="flex gap-1 bg-gray-200 rounded-lg p-1 mb-6 w-fit">
              {ADMIN_TABS.map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`px-5 py-2 rounded-md text-sm font-medium transition-colors ${
                    activeTab === tab.id
                      ? 'bg-white text-gray-900 shadow-sm'
                      : 'text-gray-600 hover:text-gray-800'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            {/* Tab Content */}
            {activeTab === 'sops' && (
              <AdminSOPsTab
                sops={sops}
                categories={categories}
                onSopCreate={onSopCreate}
                onSopUpdate={onSopUpdate}
                onSopDelete={onSopDelete}
              />
            )}
            {activeTab === 'dailyTasks' && (
              <AdminDailyTasksTab
                dailyTasks={dailyTasks}
                onTaskCreate={onDailyTaskCreate}
                onTaskUpdate={onDailyTaskUpdate}
                onTaskDelete={onDailyTaskDelete}
              />
            )}
            {activeTab === 'knowledgeBase' && (
              <AdminKnowledgeBaseTab
                knowledgeBase={knowledgeBase}
                onArticleCreate={onKBCreate}
                onArticleUpdate={onKBArticleUpdate}
                onArticleDelete={onKBDelete}
              />
            )}
            {activeTab === 'glossary' && (
              <AdminGlossaryTab
                glossary={glossary}
                onTermCreate={onTermCreate}
                onTermUpdate={onTermUpdate}
                onTermDelete={onTermDelete}
              />
            )}
            {activeTab === 'contacts' && (
              <AdminContactsTab
                contacts={contacts}
                onContactCreate={onContactCreate}
                onContactUpdate={onContactUpdate}
                onContactDelete={onContactDelete}
              />
            )}
            {activeTab === 'pricing' && (
              <AdminPricingTab
                pricing={pricing}
                onEntityCreate={onPricingEntityCreate}
                onEntityUpdate={onPricingEntityUpdate}
                onEntityDelete={onPricingEntityDelete}
              />
            )}
            {activeTab === 'partLocations' && (
              <AdminPartLocationsTab
                partLocations={partLocations}
                onEntryCreate={onPartLocationCreate}
                onEntryUpdate={onPartLocationUpdate}
                onEntryDelete={onPartLocationDelete}
              />
            )}
            {activeTab === 'users' && <AdminUsersTab />}
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: SOPs
    // ============================================================

    function AdminSOPsTab({ sops, categories, onSopCreate, onSopUpdate, onSopDelete }) {
      const [editingSop, setEditingSop] = useState(null);
      const [showEditor, setShowEditor] = useState(false);
      const [saving, setSaving] = useState(false);

      const handleDelete = async (sopId) => {
        if (confirm('Delete this SOP? This cannot be undone.')) {
          try { await onSopDelete(sopId); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (sopData) => {
        setSaving(true);
        try {
          if (editingSop) {
            await onSopUpdate(editingSop.id, sopData);
          } else {
            await onSopCreate(sopData);
          }
          setShowEditor(false);
          setEditingSop(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        } finally {
          setSaving(false);
        }
      };

      if (showEditor || editingSop) {
        return (
          <SOPEditor
            sop={editingSop}
            categories={categories}
            onSave={handleSave}
            onCancel={() => { setShowEditor(false); setEditingSop(null); }}
            saving={saving}
          />
        );
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{sops.length} procedures</p>
            <button onClick={() => setShowEditor(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add New SOP</button>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {sops.slice().sort((a, b) => (a.sopNumber || 0) - (b.sopNumber || 0)).map((sop) => (
                <div key={sop.id} className="px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div>
                    {sop.sopNumber && <div className="text-xs text-gray-400 font-mono">{formatSopNumber(sop.sopNumber)}</div>}
                    <h3 className="font-medium text-gray-800">{sop.title}</h3>
                    <div className="flex gap-3 mt-1">
                      <span className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-medium">{sop.category}</span>
                      {sop.updatedAt && <span className="text-xs text-gray-400">Updated {timeAgo(sop.updatedAt)}</span>}
                    </div>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingSop(sop)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(sop.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {sops.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">No SOPs yet. Add your first one.</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: DAILY TASKS
    // ============================================================

    function AdminDailyTasksTab({ dailyTasks, onTaskCreate, onTaskUpdate, onTaskDelete }) {
      const [editingTask, setEditingTask] = useState(null);
      const [showEditor, setShowEditor] = useState(false);
      const [saving, setSaving] = useState(false);

      const taskCategories = useMemo(() => {
        return [...new Set(dailyTasks.map(t => t.category))].sort();
      }, [dailyTasks]);

      const handleDelete = async (taskId) => {
        if (confirm('Delete this task? This cannot be undone.')) {
          try { await onTaskDelete(taskId); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (taskData) => {
        setSaving(true);
        try {
          if (editingTask) {
            await onTaskUpdate(editingTask.id, taskData);
          } else {
            await onTaskCreate(taskData);
          }
          setShowEditor(false);
          setEditingTask(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        } finally {
          setSaving(false);
        }
      };

      if (showEditor || editingTask) {
        return (
          <SOPEditor
            sop={editingTask}
            categories={taskCategories.length > 0 ? taskCategories : ['Sourcing', 'Warehouse', 'Compliance', 'Communication', 'Maintenance']}
            onSave={handleSave}
            onCancel={() => { setShowEditor(false); setEditingTask(null); }}
            saving={saving}
            labelType="Task"
          />
        );
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{dailyTasks.length} tasks</p>
            <button onClick={() => setShowEditor(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add New Task</button>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {dailyTasks.slice().sort((a, b) => (a.dtNumber || 0) - (b.dtNumber || 0)).map((task) => (
                <div key={task.id} className="px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div>
                    {task.dtNumber && <div className="text-xs text-gray-400 font-mono">{formatDtNumber(task.dtNumber)}</div>}
                    <h3 className="font-medium text-gray-800">{task.title}</h3>
                    <div className="flex gap-3 mt-1">
                      <span className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-medium">{task.category}</span>
                      {task.updatedAt && <span className="text-xs text-gray-400">Updated {timeAgo(task.updatedAt)}</span>}
                    </div>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingTask(task)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(task.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {dailyTasks.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">No daily tasks yet. Add your first one.</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: KNOWLEDGE BASE
    // ============================================================

    function AdminKnowledgeBaseTab({ knowledgeBase, onArticleCreate, onArticleUpdate, onArticleDelete }) {
      const [editingArticle, setEditingArticle] = useState(null);
      const [showEditor, setShowEditor] = useState(false);
      const [saving, setSaving] = useState(false);

      const articleCategories = useMemo(() => {
        return [...new Set(knowledgeBase.map(a => a.category))].sort();
      }, [knowledgeBase]);

      const handleDelete = async (articleId) => {
        if (confirm('Delete this article? This cannot be undone.')) {
          try { await onArticleDelete(articleId); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (articleData) => {
        setSaving(true);
        try {
          if (editingArticle) {
            await onArticleUpdate(editingArticle.id, articleData);
          } else {
            await onArticleCreate(articleData);
          }
          setShowEditor(false);
          setEditingArticle(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        } finally {
          setSaving(false);
        }
      };

      if (showEditor || editingArticle) {
        return (
          <SOPEditor
            sop={editingArticle}
            categories={articleCategories.length > 0 ? articleCategories : ['General', 'Reference', 'How-To']}
            onSave={handleSave}
            onCancel={() => { setShowEditor(false); setEditingArticle(null); }}
            saving={saving}
            labelType="Article"
          />
        );
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{knowledgeBase.length} articles</p>
            <button onClick={() => setShowEditor(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add New Article</button>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {knowledgeBase.slice().sort((a, b) => (a.kbNumber || 0) - (b.kbNumber || 0)).map((article) => (
                <div key={article.id} className="px-5 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div>
                    {article.kbNumber && <div className="text-xs text-gray-400 font-mono">{formatKbNumber(article.kbNumber)}</div>}
                    <h3 className="font-medium text-gray-800">{article.title}</h3>
                    <div className="flex gap-3 mt-1">
                      <span className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-medium">{article.category}</span>
                      {article.updatedAt && <span className="text-xs text-gray-400">Updated {timeAgo(article.updatedAt)}</span>}
                    </div>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingArticle(article)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(article.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {knowledgeBase.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">No articles yet. Add your first one.</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // SOP EDITOR (Split-pane with toolbar)
    // ============================================================

    function SOPEditor({ sop, categories, onSave, onCancel, saving, labelType = 'SOP' }) {
      const [title, setTitle] = useState(sop?.title || '');
      const [category, setCategory] = useState(sop?.category || categories[0] || '');
      const [content, setContent] = useState(sop?.content || '');
      const editorRef = useRef(null);

      const previewHtml = useMemo(() => {
        try { return processContentLinks(marked.parse(content)); }
        catch { return ''; }
      }, [content]);

      const insertAtCursor = (before, after = '') => {
        const el = editorRef.current;
        if (!el) return;
        const start = el.selectionStart;
        const end = el.selectionEnd;
        const selected = content.substring(start, end);
        const replacement = before + (selected || '') + after;
        const newContent = content.substring(0, start) + replacement + content.substring(end);
        setContent(newContent);
        setTimeout(() => {
          el.focus();
          const cursorPos = selected ? start + replacement.length : start + before.length;
          el.selectionStart = cursorPos;
          el.selectionEnd = cursorPos;
        }, 0);
      };

      const toolbarActions = [
        { label: 'Bold', icon: 'B', action: () => insertAtCursor('**', '**') },
        { label: 'Heading', icon: 'H', action: () => {
          const el = editorRef.current;
          if (!el) return;
          const start = el.selectionStart;
          const lineStart = content.lastIndexOf('\n', start - 1) + 1;
          const newContent = content.substring(0, lineStart) + '## ' + content.substring(lineStart);
          setContent(newContent);
          setTimeout(() => { el.focus(); el.selectionStart = el.selectionEnd = start + 3; }, 0);
        }},
        { label: 'List', icon: 'Li', action: () => {
          const el = editorRef.current;
          if (!el) return;
          const start = el.selectionStart;
          const lineStart = content.lastIndexOf('\n', start - 1) + 1;
          const newContent = content.substring(0, lineStart) + '- ' + content.substring(lineStart);
          setContent(newContent);
          setTimeout(() => { el.focus(); el.selectionStart = el.selectionEnd = start + 2; }, 0);
        }},
        { label: 'Table', icon: 'T', action: () => insertAtCursor('\n| Column 1 | Column 2 | Column 3 |\n| --- | --- | --- |\n| Cell | Cell | Cell |\n') },
        { label: 'Code', icon: '<>', action: () => {
          const el = editorRef.current;
          if (!el) return;
          const start = el.selectionStart;
          const end = el.selectionEnd;
          const selected = content.substring(start, end);
          if (selected.includes('\n') || !selected) {
            insertAtCursor('\n```\n', '\n```\n');
          } else {
            insertAtCursor('`', '`');
          }
        }},
        { label: 'Cross-link', icon: '[[]]', action: () => insertAtCursor('[[', ']]') },
      ];

      const canSave = title.trim() && content.trim();

      return (
        <div>
          {/* Top bar */}
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold text-gray-800">{sop ? `Edit ${labelType}` : `New ${labelType}`}</h2>
            <div className="flex gap-2">
              <button onClick={onCancel} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
              <button onClick={() => onSave({ title, category, content })} disabled={!canSave || saving} className="px-4 py-2 text-sm font-medium bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors">{saving ? 'Saving...' : `Save ${labelType}`}</button>
            </div>
          </div>

          {/* Item Number (read-only) */}
          {(labelType === 'SOP' || labelType === 'Task' || labelType === 'Article') && (
            <div className="mb-4">
              <label className="block text-xs font-medium text-gray-500 mb-1">{labelType} Number</label>
              <div className="text-sm font-mono text-gray-600 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 w-fit">
                {labelType === 'SOP' && (sop?.sopNumber ? formatSopNumber(sop.sopNumber) : 'Auto-assigned on save')}
                {labelType === 'Task' && (sop?.dtNumber ? formatDtNumber(sop.dtNumber) : 'Auto-assigned on save')}
                {labelType === 'Article' && (sop?.kbNumber ? formatKbNumber(sop.kbNumber) : 'Auto-assigned on save')}
              </div>
            </div>
          )}

          {/* Title & Category */}
          <div className="grid grid-cols-3 gap-4 mb-4">
            <div className="col-span-2">
              <label className="block text-xs font-medium text-gray-500 mb-1">Title</label>
              <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder={`Enter ${labelType.toLowerCase()} title`} />
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-500 mb-1">Category</label>
              <select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                {categories.map((cat) => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
          </div>

          {/* Toolbar */}
          <div className="flex gap-1 bg-gray-100 rounded-t-lg px-2 py-1.5 border border-gray-200 border-b-0">
            {toolbarActions.map((btn) => (
              <button
                key={btn.label}
                onClick={btn.action}
                title={btn.label}
                className="px-2.5 py-1 text-xs font-medium text-gray-600 hover:bg-white hover:text-gray-900 rounded transition-colors"
              >
                {btn.icon}
              </button>
            ))}
          </div>

          {/* Split-pane Editor + Preview */}
          <div className="flex border border-gray-200 rounded-b-lg overflow-hidden" style={{ height: '480px' }}>
            {/* Editor */}
            <textarea
              ref={editorRef}
              value={content}
              onChange={(e) => setContent(e.target.value)}
              className="w-1/2 p-4 font-mono text-sm text-gray-800 resize-none outline-none border-r border-gray-200 bg-white"
              placeholder={`Write your ${labelType.toLowerCase()} content in Markdown...`}
            />
            {/* Preview */}
            <div className="w-1/2 p-4 overflow-y-auto bg-white">
              {content ? (
                <div className="prose text-sm" dangerouslySetInnerHTML={{ __html: previewHtml }} />
              ) : (
                <p className="text-sm text-gray-400 italic">Preview will appear here...</p>
              )}
            </div>
          </div>

        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: GLOSSARY
    // ============================================================

    function AdminGlossaryTab({ glossary, onTermCreate, onTermUpdate, onTermDelete }) {
      const [editingTerm, setEditingTerm] = useState(null);
      const [showForm, setShowForm] = useState(false);
      const [filterText, setFilterText] = useState('');

      const glossaryCategories = useMemo(() => {
        return [...new Set(glossary.map(g => g.category))].sort();
      }, [glossary]);

      const filtered = useMemo(() => {
        const list = !filterText ? glossary : glossary.filter(t => {
          const q = filterText.toLowerCase();
          return t.name.toLowerCase().includes(q) || t.meaning.toLowerCase().includes(q);
        });
        return list.slice().sort((a, b) => a.name.localeCompare(b.name));
      }, [glossary, filterText]);

      const handleDelete = async (id) => {
        if (confirm('Delete this term?')) {
          try { await onTermDelete(id); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (termData) => {
        try {
          if (editingTerm) {
            await onTermUpdate(editingTerm.id, termData);
          } else {
            await onTermCreate(termData);
          }
          setShowForm(false);
          setEditingTerm(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        }
      };

      if (showForm || editingTerm) {
        return (
          <GlossaryFormModal
            term={editingTerm}
            categories={glossaryCategories}
            onSave={handleSave}
            onClose={() => { setShowForm(false); setEditingTerm(null); }}
          />
        );
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <div className="relative w-64">
              <svg className="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
              <input type="text" value={filterText} onChange={(e) => setFilterText(e.target.value)} placeholder="Filter terms..." className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" />
            </div>
            <button onClick={() => setShowForm(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add Term</button>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {filtered.map((term) => (
                <div key={term.id} className="px-5 py-3.5 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div className="flex items-center gap-3">
                    <span className="font-medium text-gray-800 text-sm">{term.name}</span>
                    <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${term.type === 'abbreviation' ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'}`}>
                      {term.type === 'abbreviation' ? 'Abbr' : 'Term'}
                    </span>
                    <span className="text-xs text-gray-400">{term.meaning}</span>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingTerm(term)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(term.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {filtered.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">No terms found.</div>
              )}
            </div>
          </div>
          <p className="text-xs text-gray-400 mt-3">{filtered.length} of {glossary.length} terms</p>
        </div>
      );
    }

    // ============================================================
    // MODAL: GLOSSARY FORM
    // ============================================================

    function GlossaryFormModal({ term, categories, onSave, onClose }) {
      useEscapeKey(onClose);
      const [name, setName] = useState(term?.name || '');
      const [type, setType] = useState(term?.type || 'abbreviation');
      const [meaning, setMeaning] = useState(term?.meaning || '');
      const [context, setContext] = useState(term?.context || '');
      const [category, setCategory] = useState(term?.category || categories[0] || '');
      const [customCategory, setCustomCategory] = useState('');

      const canSave = name.trim() && meaning.trim() && (category || customCategory.trim());

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="px-6 py-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-semibold">{term ? 'Edit Term' : 'Add Term'}</h2>
              <button onClick={onClose} className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                <CloseIcon />
              </button>
            </div>
            <div className="p-6 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">Name</label>
                  <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g., AOG" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">Type</label>
                  <select value={type} onChange={(e) => setType(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    <option value="abbreviation">Abbreviation</option>
                    <option value="term">Term</option>
                  </select>
                </div>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">Meaning</label>
                <input type="text" value={meaning} onChange={(e) => setMeaning(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g., Aircraft On Ground" />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">Context <span className="text-gray-400">(optional)</span></label>
                <input type="text" value={context} onChange={(e) => setContext(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g., Highest priority for flight operations" />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">Category</label>
                <div className="flex gap-2">
                  <select value={category} onChange={(e) => { setCategory(e.target.value); setCustomCategory(''); }} className="flex-1 px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    {categories.map((cat) => <option key={cat} value={cat}>{cat}</option>)}
                    <option value="">-- New category --</option>
                  </select>
                  {!category && (
                    <input type="text" value={customCategory} onChange={(e) => setCustomCategory(e.target.value)} className="flex-1 px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="New category name" />
                  )}
                </div>
              </div>
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-3">
              <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
              <button
                onClick={() => onSave({ name, type, meaning, context: context || undefined, category: category || customCategory.trim() })}
                disabled={!canSave}
                className="px-4 py-2 text-sm font-medium bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                {term ? 'Save Changes' : 'Add Term'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: CONTACTS
    // ============================================================

    function AdminContactsTab({ contacts, onContactCreate, onContactUpdate, onContactDelete }) {
      const [editingContact, setEditingContact] = useState(null);
      const [showForm, setShowForm] = useState(false);

      const handleDelete = async (id) => {
        if (confirm('Delete this contact?')) {
          try { await onContactDelete(id); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (contactData) => {
        try {
          if (editingContact) {
            await onContactUpdate(editingContact.id, contactData);
          } else {
            await onContactCreate(contactData);
          }
          setShowForm(false);
          setEditingContact(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        }
      };

      if (showForm || editingContact) {
        return (
          <ContactFormModal
            contact={editingContact}
            onSave={handleSave}
            onClose={() => { setShowForm(false); setEditingContact(null); }}
          />
        );
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{contacts.length} contacts</p>
            <button onClick={() => setShowForm(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add Contact</button>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {contacts.slice().sort((a, b) => a.name.localeCompare(b.name)).map((contact) => (
                <div key={contact.id} className="px-5 py-3.5 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div>
                    <span className="font-medium text-gray-800 text-sm">{contact.name}</span>
                    <span className="text-xs text-gray-400 ml-3">{contact.role}</span>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingContact(contact)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(contact.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {contacts.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">No contacts yet. Add your first one.</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: PRICING
    // ============================================================

    function AdminPricingTab({ pricing, onEntityCreate, onEntityUpdate, onEntityDelete }) {
      const [editingEntity, setEditingEntity] = useState(null);
      const [showForm, setShowForm] = useState(false);

      const handleDelete = async (id) => {
        if (confirm('Delete this pricing entity and all its markup ranges?')) {
          try { await onEntityDelete(id); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (entityData) => {
        try {
          if (editingEntity) {
            await onEntityUpdate(editingEntity.id, entityData);
          } else {
            await onEntityCreate(entityData);
          }
          setShowForm(false);
          setEditingEntity(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        }
      };

      if (showForm || editingEntity) {
        return (
          <PricingEntityFormModal
            entity={editingEntity}
            onSave={handleSave}
            onClose={() => { setShowForm(false); setEditingEntity(null); }}
          />
        );
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{pricing.length} pricing entit{pricing.length !== 1 ? 'ies' : 'y'}</p>
            <button onClick={() => setShowForm(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add Entity</button>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {pricing.slice().sort((a, b) => a.entityName.localeCompare(b.entityName)).map((entity) => (
                <div key={entity.id} className="px-5 py-3.5 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div>
                    <span className="font-medium text-gray-800 text-sm">{entity.entityName}</span>
                    <span className="text-xs text-gray-400 ml-3">{(entity.ranges || []).length} range{(entity.ranges || []).length !== 1 ? 's' : ''}</span>
                  </div>
                  <div className="flex gap-1">
                    <button onClick={() => setEditingEntity(entity)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(entity.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {pricing.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">No pricing entities yet. Add your first one.</div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: PART LOCATIONS
    // ============================================================

    function AdminPartLocationsTab({ partLocations, onEntryCreate, onEntryUpdate, onEntryDelete }) {
      const [editingEntry, setEditingEntry] = useState(null);
      const [showForm, setShowForm] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');

      const handleDelete = async (id) => {
        if (confirm('Delete this part location entry?')) {
          try { await onEntryDelete(id); }
          catch (e) { alert('Failed to delete: ' + e.message); }
        }
      };

      const handleSave = async (data) => {
        try {
          if (editingEntry) {
            await onEntryUpdate(editingEntry.id, data);
          } else {
            await onEntryCreate(data);
          }
          setShowForm(false);
          setEditingEntry(null);
        } catch (e) {
          alert('Failed to save: ' + e.message);
        }
      };

      if (showForm || editingEntry) {
        return (
          <PartLocationFormModal
            entry={editingEntry}
            existingCategories={[...new Set(partLocations.map(p => p.category))].sort()}
            onSave={handleSave}
            onClose={() => { setShowForm(false); setEditingEntry(null); }}
          />
        );
      }

      const filtered = searchQuery.trim()
        ? partLocations.filter(p => {
            const q = searchQuery.toLowerCase();
            return p.category.toLowerCase().includes(q) ||
              p.subcategory.toLowerCase().includes(q) ||
              (p.locations || []).some(loc => loc.toLowerCase().includes(q));
          })
        : partLocations;

      const sorted = [...filtered].sort((a, b) => a.category.localeCompare(b.category) || a.subcategory.localeCompare(b.subcategory));

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{partLocations.length} part location{partLocations.length !== 1 ? 's' : ''}</p>
            <button onClick={() => setShowForm(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add Entry</button>
          </div>
          <div className="mb-3">
            <div className="relative max-w-sm">
              <SearchIcon className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search entries..."
                className="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
              />
            </div>
          </div>
          <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div className="divide-y divide-gray-100">
              {sorted.map((entry) => (
                <div key={entry.id} className="px-5 py-3.5 flex items-center justify-between hover:bg-gray-50 transition-colors">
                  <div className="min-w-0 flex-1 mr-4">
                    <span className="font-medium text-gray-800 text-sm">{entry.category}</span>
                    <span className="text-gray-400 mx-2">—</span>
                    <span className="text-gray-600 text-sm">{entry.subcategory}</span>
                    <div className="flex flex-wrap gap-1 mt-1">
                      {(entry.locations || []).map((loc, i) => (
                        <span key={i} className="inline-flex px-1.5 py-0.5 bg-slate-100 text-slate-600 text-xs font-mono rounded">{loc}</span>
                      ))}
                    </div>
                  </div>
                  <div className="flex gap-1 flex-shrink-0">
                    <button onClick={() => setEditingEntry(entry)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                      <EditIcon />
                    </button>
                    <button onClick={() => handleDelete(entry.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                      <DeleteIcon />
                    </button>
                  </div>
                </div>
              ))}
              {sorted.length === 0 && (
                <div className="px-5 py-12 text-center text-gray-400 text-sm">
                  {partLocations.length === 0 ? 'No part locations yet. Add your first one.' : 'No entries match your search.'}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // MODAL: PART LOCATION FORM
    // ============================================================

    function PartLocationFormModal({ entry, existingCategories, onSave, onClose }) {
      useEscapeKey(onClose);
      const [category, setCategory] = useState(entry?.category || '');
      const [subcategory, setSubcategory] = useState(entry?.subcategory || '');
      const [locations, setLocations] = useState(entry?.locations?.length > 0 ? [...entry.locations] : ['']);

      const addLocation = () => setLocations([...locations, '']);

      const updateLocation = (index, value) => {
        const updated = locations.map((loc, i) => i === index ? value : loc);
        setLocations(updated);
      };

      const removeLocation = (index) => {
        if (locations.length <= 1) return;
        setLocations(locations.filter((_, i) => i !== index));
      };

      const handleSave = () => {
        const cleanLocations = locations.map(l => l.trim()).filter(l => l.length > 0);
        onSave({ category: category.trim(), subcategory: subcategory.trim(), locations: cleanLocations });
      };

      const canSave = category.trim().length > 0 && subcategory.trim().length > 0 && locations.some(l => l.trim().length > 0);

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="px-6 py-4 border-b flex items-center justify-between flex-shrink-0">
              <h2 className="text-lg font-semibold">{entry ? 'Edit Part Location' : 'Add Part Location'}</h2>
              <button onClick={onClose} className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                <CloseIcon />
              </button>
            </div>
            <div className="p-6 space-y-5 overflow-y-auto">
              {/* Category with datalist autocomplete */}
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">Category</label>
                <input
                  type="text"
                  list="part-loc-categories"
                  value={category}
                  onChange={(e) => setCategory(e.target.value)}
                  className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                  placeholder="e.g., Hardware, bolts"
                />
                <datalist id="part-loc-categories">
                  {existingCategories.map(cat => (
                    <option key={cat} value={cat} />
                  ))}
                </datalist>
              </div>

              {/* Subcategory */}
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">Sub-category</label>
                <input
                  type="text"
                  value={subcategory}
                  onChange={(e) => setSubcategory(e.target.value)}
                  className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                  placeholder="e.g., AN3 Bolts"
                />
              </div>

              {/* Dynamic Locations */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <label className="block text-xs font-medium text-gray-500">Locations</label>
                  <button onClick={addLocation} className="text-xs text-blue-600 hover:text-blue-700 font-medium">+ Add Location</button>
                </div>
                <div className="space-y-2">
                  {locations.map((loc, idx) => (
                    <div key={idx} className="flex gap-2 items-center">
                      <input
                        type="text"
                        value={loc}
                        onChange={(e) => updateLocation(idx, e.target.value)}
                        placeholder="e.g., C19-F-1"
                        className="flex-1 px-3 py-2 text-sm font-mono border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                      />
                      {locations.length > 1 && (
                        <button
                          onClick={() => removeLocation(idx)}
                          className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                          title="Remove location"
                        >
                          <CloseIcon className="w-4 h-4" />
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-3 flex-shrink-0">
              <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
              <button
                onClick={handleSave}
                disabled={!canSave}
                className="px-4 py-2 text-sm font-medium bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                {entry ? 'Save Changes' : 'Add Entry'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // MODAL: PRICING ENTITY FORM
    // ============================================================

    function PricingEntityFormModal({ entity, onSave, onClose }) {
      useEscapeKey(onClose);
      const [entityName, setEntityName] = useState(entity?.entityName || '');
      const [ranges, setRanges] = useState(entity?.ranges || []);

      const addRange = () => {
        setRanges([...ranges, { from: '', to: '', markup: '' }]);
      };

      const updateRange = (index, field, value) => {
        const updated = ranges.map((r, i) => {
          if (i !== index) return r;
          return { ...r, [field]: value };
        });
        setRanges(updated);
      };

      const removeRange = (index) => {
        setRanges(ranges.filter((_, i) => i !== index));
      };

      const handleSave = () => {
        const cleanRanges = ranges.map(r => ({
          from: r.from === '' || r.from === null ? 0 : Number(r.from),
          to: r.to === '' || r.to === null ? null : Number(r.to),
          markup: r.markup === '' ? 0 : Number(r.markup)
        })).sort((a, b) => (a.from || 0) - (b.from || 0));
        onSave({ entityName: entityName.trim(), ranges: cleanRanges });
      };

      const canSave = entityName.trim().length > 0;

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="bg-white rounded-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="px-6 py-4 border-b flex items-center justify-between flex-shrink-0">
              <h2 className="text-lg font-semibold">{entity ? 'Edit Pricing Entity' : 'Add Pricing Entity'}</h2>
              <button onClick={onClose} className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                <CloseIcon />
              </button>
            </div>
            <div className="p-6 space-y-5 overflow-y-auto">
              {/* Entity Name */}
              <div>
                <label className="block text-xs font-medium text-gray-500 mb-1">Customer / Entity Name</label>
                <input
                  type="text"
                  value={entityName}
                  onChange={(e) => setEntityName(e.target.value)}
                  className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                  placeholder="e.g., DAT, SAS, Private"
                />
              </div>

              {/* Markup Ranges */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <label className="block text-xs font-medium text-gray-500">Markup Ranges</label>
                  <button onClick={addRange} className="text-xs text-blue-600 hover:text-blue-700 font-medium">+ Add Range</button>
                </div>

                {ranges.length === 0 ? (
                  <div className="bg-gray-50 rounded-lg px-4 py-6 text-center">
                    <p className="text-gray-400 text-sm">No ranges yet. Click "+ Add Range" to add your first markup range.</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {/* Header */}
                    <div className="grid grid-cols-[1fr_1fr_100px_40px] gap-2 px-1">
                      <span className="text-xs text-gray-400 font-medium">From (DKK)</span>
                      <span className="text-xs text-gray-400 font-medium">To (DKK)</span>
                      <span className="text-xs text-gray-400 font-medium">Markup %</span>
                      <span></span>
                    </div>
                    {ranges.map((range, idx) => (
                      <div key={idx} className="grid grid-cols-[1fr_1fr_100px_40px] gap-2 items-center">
                        <input
                          type="number"
                          value={range.from}
                          onChange={(e) => updateRange(idx, 'from', e.target.value)}
                          placeholder="0"
                          min="0"
                          className="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        />
                        <input
                          type="number"
                          value={range.to === null ? '' : range.to}
                          onChange={(e) => updateRange(idx, 'to', e.target.value)}
                          placeholder="No limit"
                          min="0"
                          className="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        />
                        <input
                          type="number"
                          value={range.markup}
                          onChange={(e) => updateRange(idx, 'markup', e.target.value)}
                          placeholder="0"
                          min="0"
                          className="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                        />
                        <button
                          onClick={() => removeRange(idx)}
                          className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                          title="Remove range"
                        >
                          <CloseIcon className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-3 flex-shrink-0">
              <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
              <button
                onClick={handleSave}
                disabled={!canSave}
                className="px-4 py-2 text-sm font-medium bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                {entity ? 'Save Changes' : 'Add Entity'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // MODAL: CONTACT FORM
    // ============================================================

    function ContactFormModal({ contact, onSave, onClose }) {
      useEscapeKey(onClose);
      const [name, setName] = useState(contact?.name || '');
      const [role, setRole] = useState(contact?.role || '');
      const [phone, setPhone] = useState(contact?.phone || '');
      const [email, setEmail] = useState(contact?.email || '');

      const canSave = name.trim() && role.trim();

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={onClose}>
          <div className="bg-white rounded-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="px-6 py-4 border-b flex items-center justify-between">
              <h2 className="text-lg font-semibold">{contact ? 'Edit Contact' : 'Add Contact'}</h2>
              <button onClick={onClose} className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
                <CloseIcon />
              </button>
            </div>
            <div className="p-6 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">Name</label>
                  <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Full name" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">Role</label>
                  <input type="text" value={role} onChange={(e) => setRole(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g., Logistics Manager" />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">Phone</label>
                  <input type="text" value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="+45 12 34 56 78" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">Email</label>
                  <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="name@catflyservice.dk" />
                </div>
              </div>
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-3">
              <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
              <button
                onClick={() => onSave({ name, role, phone, email })}
                disabled={!canSave}
                className="px-4 py-2 text-sm font-medium bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                {contact ? 'Save Changes' : 'Add Contact'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // ADMIN TAB: USERS
    // ============================================================

    function AdminUsersTab() {
      const [users, setUsers] = useState([]);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        FirestoreService.getUsers()
          .then(setUsers)
          .catch(e => console.error('Failed to load users:', e))
          .finally(() => setIsLoading(false));
      }, []);

      const formatDate = (iso) => {
        if (!iso) return '—';
        try {
          return new Date(iso).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch { return '—'; }
      };

      if (isLoading) {
        return <div className="flex items-center justify-center py-16 text-gray-400 text-sm">Loading users…</div>;
      }

      return (
        <div>
          <div className="flex items-center justify-between mb-4">
            <p className="text-sm text-gray-500">{users.length} registered user{users.length !== 1 ? 's' : ''} — accounts are managed in Firebase Console</p>
          </div>
          {users.length === 0 ? (
            <div className="bg-white rounded-xl border border-gray-200 px-8 py-16 text-center">
              <p className="text-gray-400 text-sm">No users have logged in yet.</p>
            </div>
          ) : (
            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="bg-gray-50 border-b border-gray-200">
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Email</th>
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Role</th>
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">Last Login</th>
                    <th className="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-6 py-3">First Seen</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {users.map((user) => (
                    <tr key={user.id} className="hover:bg-gray-50 transition-colors">
                      <td className="px-6 py-3 text-sm font-medium text-gray-800">{user.email}</td>
                      <td className="px-6 py-3">
                        <span className={`inline-flex px-2 py-0.5 rounded-full text-xs font-medium ${
                          user.role === 'admin'
                            ? 'bg-blue-100 text-blue-700'
                            : 'bg-gray-100 text-gray-600'
                        }`}>
                          {user.role === 'admin' ? 'Admin' : 'User'}
                        </span>
                      </td>
                      <td className="px-6 py-3 text-sm text-gray-500">{formatDate(user.lastLogin)}</td>
                      <td className="px-6 py-3 text-sm text-gray-500">{formatDate(user.createdAt)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    }

    // ============================================================
    // RENDER APP
    // ============================================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <!-- Glossary tooltip portal (singleton, positioned via JS) -->
  <div id="glossary-tooltip-portal">
    <div class="gt-content"></div>
    <div class="gt-arrow"></div>
  </div>
  <script>
  (function() {
    const portal = document.getElementById('glossary-tooltip-portal');
    const content = portal.querySelector('.gt-content');
    const arrow = portal.querySelector('.gt-arrow');
    const MARGIN = 8;

    function showTooltip(term) {
      const name = term.getAttribute('data-g-name');
      const meaning = term.getAttribute('data-g-meaning');
      const context = term.getAttribute('data-g-context');

      let html = '<strong>' + name + '</strong> — ' + meaning;
      if (context) {
        html += '<br><span style="opacity:0.7;font-style:italic">' + context + '</span>';
      }
      content.innerHTML = html;

      // Show offscreen first to measure
      portal.style.display = 'block';
      portal.style.left = '-9999px';
      portal.style.top = '-9999px';

      const rect = term.getBoundingClientRect();
      const pw = portal.offsetWidth;
      const ph = portal.offsetHeight;
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      // Vertical: prefer above, flip below if no room
      const spaceAbove = rect.top;
      const spaceBelow = vh - rect.bottom;
      let top, arrowClass;

      if (spaceAbove >= ph + MARGIN + 5) {
        top = rect.top - ph - 6;
        arrowClass = 'gt-arrow arrow-down';
      } else {
        top = rect.bottom + 6;
        arrowClass = 'gt-arrow arrow-up';
      }

      // Horizontal: center on term, clamp to viewport
      const termCenter = rect.left + rect.width / 2;
      let left = termCenter - pw / 2;

      if (left < MARGIN) left = MARGIN;
      if (left + pw > vw - MARGIN) left = vw - MARGIN - pw;

      // Arrow points at term center
      const arrowLeft = Math.max(10, Math.min(pw - 10, termCenter - left));

      portal.style.left = left + 'px';
      portal.style.top = top + 'px';

      arrow.className = arrowClass;
      arrow.style.left = arrowLeft + 'px';
      arrow.style.transform = 'translateX(-50%)';
    }

    function hideTooltip() {
      portal.style.display = 'none';
    }

    // Event delegation on document body
    document.body.addEventListener('mouseenter', function(e) {
      const term = e.target.closest('.glossary-term');
      if (term && term.hasAttribute('data-g-name')) {
        showTooltip(term);
      }
    }, true);

    document.body.addEventListener('mouseleave', function(e) {
      const term = e.target.closest('.glossary-term');
      if (term && term.hasAttribute('data-g-name')) {
        hideTooltip();
      }
    }, true);
  })();
  </script>
</body>
</html>
