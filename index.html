<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOP Assistant - CAT Internal Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    .animate-bounce-dot { animation: bounce 1.4s ease-in-out infinite; }
    .prose strong { font-weight: 600; }
    .prose blockquote { border-left: 3px solid #3b82f6; padding-left: 1rem; margin: 0.5rem 0; background: #eff6ff; padding: 0.75rem 1rem; border-radius: 0.5rem; }
    .prose ul { list-style-type: disc; padding-left: 1.5rem; margin: 0.5rem 0; }
    .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin: 0.5rem 0; }
    .prose li { margin: 0.25rem 0; }
    .prose p { margin: 0.5rem 0; }
    .prose code { background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // ============================================================
    // CONFIGURATION
    // ============================================================
    
    const CONFIG = {
      // Firebase Configuration (optional - for future use)
      firebase: {
        apiKey: "",
        authDomain: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: ""
      },
      // Login Credentials
      credentials: { username: 'cat', password: 'cat1234' }
    };

    // ============================================================
    // LOCAL STORAGE
    // ============================================================
    
    const LocalStorage = {
      getSOPs: () => {
        const stored = localStorage.getItem('sop_bot_sops');
        return stored ? JSON.parse(stored) : null;
      },
      saveSOPs: (sops) => {
        localStorage.setItem('sop_bot_sops', JSON.stringify(sops));
      },
      getCategories: () => {
        const stored = localStorage.getItem('sop_bot_categories');
        return stored ? JSON.parse(stored) : null;
      },
      saveCategories: (categories) => {
        localStorage.setItem('sop_bot_categories', JSON.stringify(categories));
      }
    };

    // ============================================================
    // DEFAULT SOP DATA
    // ============================================================
    
    const DEFAULT_SOPS = [
      {
        id: 'sop-sharepoint',
        title: 'Using SharePoint',
        category: 'Systems',
        updatedAt: new Date().toISOString(),
        content: `Using SharePoint

SharePoint is our hub for shared data and information. SharePoint can be accessed via this link: https://aircat1.sharepoint.com/sites/TekniskAfdeling

1. Navigation:
On the top of the SharePoint site are all the menu points you need to know. On the front page you will see the CAT Bulletin, which is where we post internal news.

Tip: If you need to extend a sub-menu (indicated by an arrow symbol), hover the mouse over the arrow symbol to reveal the sub-menus. Don't click on the arrow symbol, as this will lead you to the parent directory instead.

2. Departments Menu:
This is the file browser which allows you to look through our internal files. The view is access based, so in case you can't see specific folders or directories, it is because you don't have the sufficient permissions on the platform.

It is not preferred to use this function for browsing files, as we have access to the same directory directly from our PC's file browser.

3. Tool/Material Request Menu:
This is where anyone can request to order non-aircraft related things. This can be tools, work wear, facility materials or something else entirely.

We ask that all purchasing requests go through this channel to avoid Post-it notes and verbal agreements, which is impossible to follow up on for anyone not involved.

To submit a request: click the Send New Request menu point. A new window with a simple formula will open. Enter all the data for the purchase you want to request, and then click submit.

When you submit the request, a notification is sent to the logistics team who will then pick it up from there.

To see the status of your request: click the See Request Status menu point. This will show you a list of all Active Requests. To see completed requests, you can click the Completed Requests tab on the right.

A request is only completed once the ordered item has been physically received.

When logistics has acknowledged and ordered your requested item, the leftmost Status column will be updated from Not Ordered to Ordered. Any additional comments will be displayed in the Comment column.

Purchasing and updating: We must strive to only order these items from our list of approved suppliers. Often the mechanics will find specific products online and insert a link. If our approved suppliers don't have the specifically requested product, you will have to liaise with the person who made the request and find a product or other solution from our approved suppliers.

We mainly use DMT Værktøj, Würth, Biltema, Stark and Lomax for procuring non-aircraft items, as we have VAT-exempt purchasing accounts with these suppliers.

Once you have actioned a request, you have to update the ordered-status of the request, and write a small comment with the current status. This is done by double clicking on a request in the list, and you can then scroll down to the Comment field and add your initials and a comment. Example: "SEP: Ordered from Würth on 01/01/2026".

Remember to update the requests Received status from No to Yes once received.

4. Links:
This is where we have a collection of links that can be useful for the entire department.

5. Information Hub:
The Information Hub has 4 sub menus:

Aeroshell Product List: This is a simple look-up table where we have listed all our internal part numbers for all Aeroshell products. This is useful if you are having trouble identifying a part number for a specific Aeroshell product in a specific quantity or packaging.

Passwords: This is our master list of passwords for all websites where we have a login. This list is strictly used by CAT employees and should never be shared. If you update login credentials to a specific website, remember to update this sheet.

Safety Data Sheets: This shows the login credentials and access link to our Material Safety Data Sheets database.

Service Supplier List: This list is used as an index of all external service suppliers. This pertains to everything not directly aircraft related, e.g. facility maintenance, tool rent and maintenance or service vehicle maintenance. Remember to update this list if you start work with a new supplier.`,
        sections: [
          { heading: '1. Navigation', content: 'On the top of the SharePoint site are all the menu points you need to know.' },
          { heading: '2. Departments Menu', content: 'This is the file browser which allows you to look through our internal files.' },
          { heading: '3. Tool/Material Request Menu', content: 'This is where anyone can request to order non-aircraft related things.' },
          { heading: '4. Links', content: 'This is where we have a collection of links that can be useful for the entire department.' },
          { heading: '5. Information Hub', content: 'The Information Hub has 4 sub menus.' }
        ]
      },
      {
        id: 'sop-goods-receiving',
        title: 'Goods Receiving',
        category: 'Logistics',
        updatedAt: new Date().toISOString(),
        content: `Goods Receiving

The below SOP pertains to importing goods into the AMS system if they are ordered and received from within the EU. If you are receiving a shipment from a non-EU country, please read the SOP for "Import and End-Use Certification".

1. Physical inspection:
Do a quick visual check for damages to the shipping box. If no major or noteworthy exterior damage to the shipping box is noted, you can proceed with opening the box.

Remove the part(s) and paperwork. If you have purchased multiple items, it's a good idea to do a little sorting by bundling the items and paperwork together. This makes it easier for you in the system receiving phase.

If you have ordered a serialized item, you need to do a visual check on the physical part to confirm that the PN and SN are the same as stated on the included paperwork.

Check the included paperwork (for each item), and ensure that the part was delivered with the required paperwork (Certificate of Compliance, or EASA Form 1 / FAA 8130-3) and that the specific item is listed on the paperwork.

If all the above things are good, you can proceed to step 2.

2. Receiving in the system:
Start by picking an item you want to receive. Then scan the paperwork related to the item. The scanned document in the scan folder then needs to be renamed to the cert type and ID (e.g. EASA 123-ABC.pdf).

Open AMS, click on P.O. Manager > Purchase Order Receiving. You will now see a window listing all purchase orders with at least 1 item not received in the system. So if an order was placed for 100 items but only 99 has been received, they will appear in this window. As soon as all open items has successfully been received, they will disappear from this view.

Use the search function to find the relevant order, and then double-click on the order on the top window. This will open a view of the specific order which allows you to receive individual items with outstanding balances.

Locate the item line for the item you want to receive, then double click on the line.

You will be prompted with 2 pop-up windows for each item line:

2A. The first pop-up:
This pop-up asks that you enter how many units you are receiving, and if the part number is the same as what you ordered.

First you must enter the quantity you are receiving. The "Ordered quantity" line shows you how many total of that item line was ordered, and you then have to enter the quantity you are currently receiving in. In case of partial deliveries, you just enter the lower quantity than what was actually ordered, and the balance quantity will be pending until received.

It is sometimes necessary to receive an ordered part under an alternative part number, so in these cases it's important that you check off "Equivalent" and enter the alternative part number in the "Part number:" field. Always double check that the received part number is 100% correct, whether it's the original ordered PN or an alternative PN.

If you received the same PN as you ordered, you just enter the quantity that you are receiving and click "Save".

2B. The second pop-up:
This pop-up asks for import/customs related information. As mentioned in the beginning of this SOP, this pertains only to shipments from within the EU.

If you are receiving a part from a non-EU country, please read the SOP for "Import and End-Use Certification" before proceeding.

You are initially asked to enter a Release Note Number:

For EU shipments: Enter the certificate reference, which will be the same as you named the scanned PDF document (e.g. EASA 123-ABC or COC ABC-123).

Click OK to close this window and then click next.

For non-EU shipments: Ensure that you followed the import SOP, and then enter the customs case ID number (e.g. 2026142273756).

Click OK to close this window, and then navigate to the lower of the two windows (the one saying Waybill number).

We use this field to state whether the item was imported and released on either our End-Use license or the Airworthiness Release certificate. Click on "Add Waybill No" and you are prompted with another pop-up.

Here you must enter one of the two values with the exact same formatting as below:
- Parts released on End-Use certificate: END-USE
- Parts released on the airworthiness release: CERT

Click OK to close this pop-up, and the previous view should now show the values you entered; the release reference on the top and the waybill reference on the bottom.

Then click Next.

2C. Updating item data:
Note for serialized items: if you have ordered an item that is serialized, you will see another pop-up window asking for the serial number of the unit you are receiving.

You can read the SN off the paperwork - be sure and double check that the SN is entered correctly and exactly as it is on the paperwork/part.

Enter the SN and click next.

Your next view is the tracking number view. This is where you have all information related to a tracking number including Location, Price, Condition, Base, Expiration, and Doc.Manager.`,
        sections: [
          { heading: '1. Physical inspection', content: 'Do a quick visual check for damages to the shipping box.' },
          { heading: '2. Receiving in the system', content: 'Scan the paperwork and rename to cert type and ID.' },
          { heading: '2A. First pop-up', content: 'Enter quantity being received.' },
          { heading: '2B. Second pop-up', content: 'Enter certificate reference or customs case ID.' },
          { heading: '2C. Updating item data', content: 'For serialized items, enter the serial number.' }
        ]
      },
      {
        id: 'sop-purchase-order',
        title: 'Create Purchase Order',
        category: 'Purchasing',
        updatedAt: new Date().toISOString(),
        content: `Creating a Purchase Order

Below instructions goes through the steps required to cut a purchase order in AMS.

There are two different approaches, depending if you need to create the PO from an AMS requisition or not.

1. Create a New PO:
On the AMS home page, click P.O. Manager > Purchase Order Creation.

You will then be asked to choose the supplier. Find the supplier on the list and click OK.

2. Input Order Details:
Start by filling out the following information fields in the header:

Reference:
This is our internal reference, so we know what the parts are ordered for upon receiving. You can put in a tail number or specific task reference. If you are buying more parts for multiple purposes, you can write "See notes" in this field, and then write the individual references on the item lines.

PBH No.:
This field is only used if you are ordering contracted units from Aerotron to Airseven. You then select AERO2601-1 (this is the contract number for the Boeings).

Ship via:
- Orders from EU and UK: KN DHL account 303776815 for standard shipments.
- Orders from US: BWS FedEx account 776036331 for standard shipments.

If you have to utilize our freight forwarder or we are collecting an order ourselves, you can use "SELF COLLECT" or "TO BE ADVISED".

Ship to:
In most cases when ordering parts for CAT, the standard value (CAT Flyservice) is correct and doesn't need to be changed. This will ensure delivery to Hangarvej B 2 in Roskilde.

When ordering parts for Airseven, we might need to drop-ship the parts directly to the aircraft where GMT's mechanic team is located. In these cases, you should look for 'GMT' and then the correct airport code:
- GMT BLL - Billund station
- GMT CPH - Copenhagen station
- GMT AAR - Aarhus station
- GMT AAL - Aalborg station

The rest of the fields are in most cases not required to fill out or change.

3. Input Item Lines:

3A. Adding item lines from the AMS requisition list:
In the bottom left corner of the window, you click Import > Import from requisition list. This opens a window that shows all open items on the requisition list. Click once to highlight the relevant item, and then click Export to P.O. in the bottom left corner. This will add the selected item to the purchase order, and it has to be done for each item.

3B. Adding item lines not from the AMS requisition list:
Start by clicking the Add Part button right below the item window, this opens a search window. Search for the part number you want to add to the item list. The search can be partial or complete.

Note: in case the part number isn't known and needs to be created, please follow the guide called "Creating New Parts".

When the correct part is displayed on the parts list to the right, click on it to highlight it and enter the quantity in the Qty field on the left, then click OK.

3C. Fill out condition and unit price:
When an item is successfully entered on the PO, it shows 13 columns where data can be entered. You should only need to fill out 2 or 3 of these fields:

Cond.: This is the condition of the part you are ordering. Double click the empty field to select from available conditions.

Un. Price: Unit price, this is our purchase price. Enter the price from the quote. Double check that the quoted currency matches the PO header.

Note: This is an internal field for references like tail number or short notes.

Qty: To change ordered quantity, highlight the item line and click the Qty Adjust button.

4. Finalize and send the Purchase Order:
When you have entered all details and the PO is ready to be sent, you click the Preview button in the bottom of the window.

This will prompt a Microsoft Word document with your new PO. The PO number is automatically assigned.

Print out the document, then write your signature and today's date.

4A. Placing the order via a supplier website:
Complete the order on the website, and remember to enter our PO number reference (e.g. CAT-1234) in the corresponding field.

4B. Placing the order via email:
Scan the signed PO, rename the file to the PO number (e.g. CAT-1234), attach to email with PO number in the subject line.

5. Archiving the Purchase Order Document:
Archive the PO document in the corresponding folder in the physical archive. Each folder contains 50 PO numbers. Stamp holes and file the PO document, maintaining chronological order (older on bottom, newer on top).`,
        sections: [
          { heading: '1. Create a New PO', content: 'On AMS home page, click P.O. Manager > Purchase Order Creation.' },
          { heading: '2. Input Order Details', content: 'Fill out Reference, PBH No., Ship via, Ship to fields.' },
          { heading: '3. Input Item Lines', content: 'Add items from requisition list or manually.' },
          { heading: '4. Finalize and send', content: 'Click Preview, print, sign, and send.' },
          { heading: '5. Archiving', content: 'File the PO document in the physical archive.' }
        ]
      },
      {
        id: 'sop-import-enduse',
        title: 'Import and End-Use Certification',
        category: 'Logistics',
        updatedAt: new Date().toISOString(),
        content: `Import and End-Use Certification

CAT holds an End-Use Certification, a legal document confirming we are the final users of our imports. This status allows us to trade and import parts without paying VAT. For non-EU imports, CAT acts as the official Importer of Record, meaning we must provide specific instructions to carriers to remain compliant with customs laws.

Choosing the Best Import Method

We have two ways to import parts VAT-free. We should always prioritize using the Airworthiness Release Certificate over our End-Use license whenever possible.

Priority 1: Airworthiness Release - This uses the part's own certification to qualify for VAT exemption. It reduces our administrative workload and legal audit footprint by using the part's documentation instead of our own license.

Priority 2: End-Use Certification - This is used for parts with lower levels of certification, such as a Certificate of Conformance, that are not automatically VAT-exempt.

Phase 1: Providing Customs Instructions (The Email Phase)

This phase happens before the shipment arrives at our facility. Both DHL and FedEx will send an email when a shipment lands in Denmark.

DHL (Automated):
DHL is set up with pre-provided instructions. They will automatically clear routine DHL Express shipments on our End-Use certification and send the import documents to our inbox. No manual action is required here.

FedEx (Manual Action Required):
FedEx holds shipments at their Danish hub and will not release them until they receive instructions from us.

1. Identify the Supplier: Open the attachment in the FedEx email to see who sent the part. You can usually see supplier and PO info on the paperwork to help you determine the right place to look.

2. Identify the Certificate: Determine if the part has an Airworthiness Release (e.g., FAA 8130-3) or just a CoC.

3. Reply to FedEx: Copy and paste the relevant instruction block below to release the shipment.

Template A: Airworthiness Release (Use if you have an EASA Form 1 or FAA 8130-3):
Importgrundlag/Anvendelse: Til reparation af egne fly (kommerciel luftfart). Venligst fortold med Luftdygtighedsattest.
Procedurecode: 4000 009
HS Code: 8807300099
Cert ref.: [Enter Type and Document ID here]
Præferencekode: 119

Template B: End-Use License (Use for consumables or parts with only a CoC):
Importgrundlag/Anvendelse: Til reparation af egne fly (kommerciel luftfart). Venligst fortold med vores END-USE bevilling.
Bevillingsnummer: DKEUS220561467
Procedurecode: 4000 962 (Momsfritaget import)
HS Code: 8807300010
Præferencekode: 140

Once the instructions have been sent to FedEx, we can expect to receive the "fuldstændig ekspres" documents within 1 to 2 weekdays, which should align with when the shipment arrives at our facility.

Phase 2: Physical Receiving (The System Phase)

This section pertains only to receiving non-EU shipments. Once the instructions are processed and the shipment is delivered to our facility, you can begin the system entry.

1. Check the Label: Confirm the country of origin. Proceed with the steps below if it is from a non-EU country.
2. Note the AWB: Copy the Carrier and Air Waybill (AWB) number from the physical box.
3. Perform Physical Receiving: Perform physical receiving and inspections as per the Goods Receiving SOP.
4. Search the Inbox: Search the shared email inbox for the AWB number to find the "fuldstændig ekspres" document.
5. Link to System: Locate and copy the Case ID and HS Code on the "fuldstændig ekspres" document.

Phase 3: Processing Customs Documentation in AMS

To finalize the receiving process in AMS, you must extract specific data from the "fuldstændig ekspres" document.

Locating the Case ID:
Find the field labeled "Referencenummer" on the document. The ID always starts with the current year (e.g., 2026142273756). This is the number you must input into the system.

Verifying the HS Code and Release Type:
Check the last two digits of the HS code (varekode) on the document to determine the correct release type for the system.

- Ending in 10: This indicates the shipment was released on our End-Use certification.
- Ending in 99: This indicates the shipment was released on the airworthiness release.

Entering Data into AMS:
When you have this information, you are ready to start the receiving process in AMS (referring to the goods receiving SOP). You must enter the Case ID and the correct release type in the fields when prompted.

- CERT: Select this option if the HS Code ends in 99. This means the part was imported and released from customs on the related airworthiness release.
- END-USE: Select this option if the HS Code ends in 10. This means the part was imported and released from customs on our End-Use license.

Handling Missing Customs Documents:

Occasionally, shipments may arrive at our facility before we receive the necessary "fuldstændig ekspres" documents from the carrier. This can stall the goods receiving process.

Requesting Missing Documents:
To resolve this, you must promptly contact the carrier's local customs office to request the documents.

- DHL CPH Customs: cphcus@dhl.com
- FedEx CPH Customs: cphgts@fedex.com

Email Format:
When sending the request, use the following format for the subject line. You do not need to write anything in the body of the email.

Subject: AWB [Insert AWB Number] Mangler Fuldstændig Ekspres, fremsend venligst ASAP

Urgent Receiving Procedure:
If you cannot wait for the documents to arrive, you may proceed with receiving the goods to ensure they are available for use.

Instead of entering the customs Case ID, enter the Carrier Name and AWB number in the ID field (e.g., FEDEX 123456789101).

This method preserves traceability and allows us to search for the AWB number in the system later. Once the actual documents are received from the carrier, you must return to AMS and update the entry with the correct Case ID.`,
        sections: [
          { heading: 'Choosing the Best Import Method', content: 'Priority 1: Airworthiness Release. Priority 2: End-Use Certification.' },
          { heading: 'Phase 1: Customs Instructions', content: 'DHL: Automated. FedEx: Manual action required.' },
          { heading: 'Phase 2: Physical Receiving', content: 'Check label, note AWB, perform inspection, search inbox.' },
          { heading: 'Phase 3: Processing in AMS', content: 'Extract Case ID and HS Code, enter in AMS.' },
          { heading: 'Handling Missing Documents', content: 'Contact carrier customs to request documents.' }
        ]
      },
      {
        id: 'sop-aerotron-cores',
        title: 'Processing Aerotron Core Units',
        category: 'Logistics',
        updatedAt: new Date().toISOString(),
        content: `Processing Aerotron Core Units

1. Collect info:
The list of information below is required to process core units. It is therefore an advantage to collect and have this information ready when you sit down at the computer. Save time by seeing how much of the information below you can find on the unit's box. Usually, the exchange PN/SN/PO number, as well as the box's weight/dimensions, are listed on Aerotron's papers.

Find the following information for each unit:
A) Core PN
B) Core SN
C) U/S tag
D) Exchange PN
E) Exchange SN
F) Exchange TN (not required)
G) Exchange PO number
H) Colli weight/dimensions

2. Create a date-folder in the Aerotron core-folder:
The folder can be found on SharePoint: Logistics\\Airseven\\Core Archive\\Aerotron\\

Create a new folder and name it today's date in YYYY-MM-DD format.

Scan the U/S-tag(s) and place them in the folder as the first step. Name the file(s): US tag SN XXX

3. Tracking number on the core unit:
First, we must ensure that the core unit exists in AMS Inventory so we can link it to the exchange unit.

Start by going to Inventory Manager > Inventory Consultation, and perform a Ser/Batch# search for the core unit's SN. If it is known in the system, open it, upload the U/S tag, change the condition to UNSERVICEABLE, press Save, and proceed to step 4.

If the SN is not already created, continue from step 3A.

3A. Search for the core unit's PN:
Go to Inventory Manager > Inventory Consultation. Perform a Part Number search for the core unit's part number. Be aware that you are searching for the PN of the core unit and not the exchange unit.

When you search for the PN:
- If the PN does not already exist, it must be created. Continue from step 3B.
- If the PN already exists when you search, continue from step 3C.

3B. Creating a SN under a non-existent PN:
Press Add in the top window to add a new part number. Fill in: Part Number, Description, Type, Model (B737 NG), U/M (unit of measurement), Serialized/Life Limited, Rotable or Consumable. Press Save.

3C. Creating SN under an existing PN:
Press Add in the bottom window. Fill in: Condition: UNSERVICEABLE, Quantity: 1, Upload U/S tag in Doc. Manager. Press Save.

4. Link exchange and core unit(s) and create a Core Exchange document:
Search for the exchange unit via the PO. Go to P.O. Manager > Purchase Order Consultation. Perform a PO # search for the 4-digit exchange PO number.

4A. If a core/exchange line has not been created:
Find the exchange unit part number, click once to highlight, then press Exchange Creation button.

4B. If a core/exchange line has already been created:
Double-click the line with part number XXX-EXCH. Locate the correct exchange unit via SN or TN.

Look at the Core Value field:
- If 0.00 is displayed: Follow step 4C (manual document needed)
- If field is empty: Continue from step 4D

4C. If 0.00 is already displayed:
Create a manual Core Exchange document with a table containing: PN, SN, Desc., CAT PO, CAT TN for both Exchange and Core units. Save as PDF: Core exchange SN XXX.

4D. If the Core Value field is empty:
Type 0 and press Enter. Click Yes to link a core, then Close the window. Press Save.

4E. Link exchange and core unit(s) in AMS Core Manager:
Go to Exchange List Consultation. Sort by Core # (newest first). Double-click your exchange unit.

Click Select > From Inventory Search Function. Search for the core unit, press OK.

Click Core P.S. Creation button. Select Aerotron as supplier, click Yes to process.

Save the generated Word document as PDF: Core exchange SN XXX.

5. Fill out and save NIS (Non-incident statement):
Open SharePoint: Logistics\\Shipping\\PDF Generator\\
Open PDF Generator.html, login, click NIS Generator. Fill details and save in date-folder.

6. Prepare a shipping invoice:
Open PDF Generator.html, click Invoice Generator. Remember: Aerotron requires DDP incoterms for all core returns. Save in date-folder.

7. Book shipment and apply the cost to the monthly invoice:
Book via shipping portal. Check DDP incoterms and indicate goods are being returned.

In AMS: Invoicing Manager > Invoices Consultation, search for Airseven. Select monthly invoice, press Add new Misc:
- Description: "Shipping, DK > UK, core return, [items]"
- Qty: 1
- Price: [shipping cost]

8. Provide information to Aerotron:
Email to: imports@aerotron.co.uk and contractsemea@aerotron.group

Subject: Core return notification // DHL AWB XXX

Attach: U/S tag(s), Core exchange document(s), NIS document(s), AWB, Shipping invoice.`,
        sections: [
          { heading: '1. Collect info', content: 'Required for each unit: Core PN, Core SN, U/S tag, Exchange PN, Exchange SN, Exchange TN, Exchange PO number, Colli weight/dimensions.' },
          { heading: '2. Create date-folder', content: 'Location: SharePoint > Logistics > Airseven > Core Archive > Aerotron' },
          { heading: '3. Tracking number setup', content: 'In AMS Inventory Manager > Inventory Consultation.' },
          { heading: '4. Link exchange and core', content: 'In P.O. Manager > Purchase Order Consultation.' },
          { heading: '5-8. Finalize', content: 'NIS, Invoice, Book shipment, Notify Aerotron.' }
        ]
      }
    ];

    const DEFAULT_CATEGORIES = ['Systems', 'Logistics', 'Purchasing'];

    // ============================================================
    // GEMINI AI SERVICE (via serverless function)
    // ============================================================
    
    const GeminiService = {
      buildSystemPrompt: (sops, mode, isStepMode = false) => {
        const sopSummaries = sops.map(sop => 
          `## ${sop.title} (Category: ${sop.category})\n${sop.content}`
        ).join('\n\n---\n\n');

        if (isStepMode) {
          return `You are the SOP Assistant for CAT Flyservice. You are currently guiding a user through a procedure STEP BY STEP.

YOUR RESPONSE FORMAT IS CRITICAL. You must respond in this EXACT JSON format:
{
  "type": "step" | "question" | "complete",
  "stepNumber": number or null,
  "totalSteps": number or null,
  "title": "Short step title",
  "content": "The detailed instruction for this step. Use markdown for formatting.",
  "tip": "Optional helpful tip" or null,
  "question": "If type is question, the clarifying question to ask" or null,
  "options": ["Option 1", "Option 2"] or null
}

RULES:
1. If you need more information before you can guide them, use type "question"
2. When giving a step, use type "step" with stepNumber, totalSteps, title, and content
3. When the process is complete, use type "complete"
4. Each step should be ONE clear action - not multiple actions
5. Keep instructions clear and simple for newcomers
6. Include helpful tips when relevant
7. For non-EU shipments, remember to include BOTH Import SOP and Goods Receiving SOP steps

AVAILABLE SOPS:
${sopSummaries}`;
        }

        return `You are the SOP Assistant for CAT Flyservice, a Danish aircraft maintenance company. You help employees understand and follow company procedures.

You are in DOCUMENTATION MODE. Your job is to:
1. Find and quote the most relevant sections from the SOPs
2. Provide context and explanations
3. Always cite which SOP and section the information comes from
4. If multiple SOPs are relevant, mention all of them
5. Use markdown formatting for clarity (bold, lists, blockquotes)

CRITICAL RULES:
1. ALWAYS check if a question involves non-EU shipments/imports. If so, the Import and End-Use Certification SOP takes precedence.
2. When someone mentions USA, UK, or any non-EU country, immediately recognize this as requiring the Import SOP.
3. Be specific with system paths (e.g., "P.O. Manager > Purchase Order Receiving")
4. When quoting templates or exact values, format them clearly.

AVAILABLE SOPS:
${sopSummaries}`;
      },

      chat: async (messages, sops, mode) => {
        const isStepMode = mode === 'stepbystep';
        const systemPrompt = GeminiService.buildSystemPrompt(sops, mode, isStepMode);
        
        const geminiMessages = messages.map(msg => ({
          role: msg.type === 'user' ? 'user' : 'model',
          parts: [{ text: msg.content }]
        }));

        try {
          // Call our serverless function instead of Gemini directly
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: geminiMessages,
              systemPrompt: systemPrompt
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'API request failed');
          }

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          
          if (isStepMode) {
            try {
              const jsonMatch = text.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
              }
            } catch (e) {
              return { type: 'text', content: text };
            }
          }
          
          return text;
        } catch (error) {
          console.error('Gemini API error:', error);
          throw error;
        }
      }
    };

    // ============================================================
    // MAIN APP
    // ============================================================
    
    function App() {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [showAdmin, setShowAdmin] = useState(false);
      const [sops, setSops] = useState([]);
      const [categories, setCategories] = useState([]);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        const init = async () => {
          let loadedSops = LocalStorage.getSOPs();
          if (!loadedSops) {
            loadedSops = DEFAULT_SOPS;
            LocalStorage.saveSOPs(loadedSops);
          }
          setSops(loadedSops);

          let loadedCategories = LocalStorage.getCategories();
          if (!loadedCategories) {
            loadedCategories = DEFAULT_CATEGORIES;
            LocalStorage.saveCategories(loadedCategories);
          }
          setCategories(loadedCategories);

          const session = sessionStorage.getItem('sop_bot_session');
          if (session === 'authenticated') {
            setIsLoggedIn(true);
          }

          setIsLoading(false);
        };
        init();
      }, []);

      const handleLogin = () => {
        sessionStorage.setItem('sop_bot_session', 'authenticated');
        setIsLoggedIn(true);
      };

      const handleLogout = () => {
        sessionStorage.removeItem('sop_bot_session');
        setIsLoggedIn(false);
        setShowAdmin(false);
      };

      const handleSopsUpdate = (newSops) => {
        setSops(newSops);
        LocalStorage.saveSOPs(newSops);
      };

      const handleCategoriesUpdate = (newCategories) => {
        setCategories(newCategories);
        LocalStorage.saveCategories(newCategories);
      };

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      if (!isLoggedIn) return <LoginScreen onLogin={handleLogin} />;
      if (showAdmin) {
        return (
          <AdminPanel 
            sops={sops}
            categories={categories}
            onSopsUpdate={handleSopsUpdate}
            onCategoriesUpdate={handleCategoriesUpdate}
            onBack={() => setShowAdmin(false)} 
            onLogout={handleLogout} 
          />
        );
      }

      return (
        <MainInterface 
          sops={sops}
          onAdminClick={() => setShowAdmin(true)} 
          onLogout={handleLogout} 
        />
      );
    }

    // ============================================================
    // LOGIN SCREEN
    // ============================================================
    
    function LoginScreen({ onLogin }) {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [isLoading, setIsLoading] = useState(false);

      const handleSubmit = (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');
        setTimeout(() => {
          if (username === CONFIG.credentials.username && password === CONFIG.credentials.password) {
            onLogin();
          } else {
            setError('Invalid username or password');
            setIsLoading(false);
          }
        }, 500);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div className="text-center mb-8">
              <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <h1 className="text-2xl font-bold text-gray-800">SOP Assistant</h1>
              <p className="text-gray-500 mt-2">Sign in to access procedures</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-5">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Enter username" disabled={isLoading} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Enter password" disabled={isLoading} />
              </div>
              {error && (
                <div className="bg-red-50 text-red-600 px-4 py-3 rounded-xl text-sm flex items-center gap-2">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  {error}
                </div>
              )}
              <button type="submit" disabled={isLoading} className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg disabled:opacity-50">
                {isLoading ? 'Signing in...' : 'Sign In'}
              </button>
            </form>
            <p className="text-center text-gray-400 text-sm mt-6">CAT Internal Tool</p>
          </div>
        </div>
      );
    }

    // ============================================================
    // MAIN INTERFACE
    // ============================================================
    
    function MainInterface({ sops, onAdminClick, onLogout }) {
      const [mode, setMode] = useState(null);

      if (mode === 'docs') return <DocumentationMode sops={sops} onBack={() => setMode(null)} onAdminClick={onAdminClick} onLogout={onLogout} />;
      if (mode === 'guide') return <StepByStepMode sops={sops} onBack={() => setMode(null)} onAdminClick={onAdminClick} onLogout={onLogout} />;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
          <Header onAdminClick={onAdminClick} onLogout={onLogout} sopCount={sops.length} />
          
          <div className="max-w-4xl mx-auto px-4 py-12">
            <div className="text-center mb-12">
              <h1 className="text-3xl font-bold text-gray-800 mb-3">Welcome to SOP Assistant</h1>
              <p className="text-lg text-gray-600">How would you like to learn today?</p>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              <button onClick={() => setMode('docs')} className="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-blue-500 hover:shadow-xl transition-all text-left group">
                <div className="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-blue-500 transition-colors">
                  <svg className="w-8 h-8 text-blue-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                  </svg>
                </div>
                <h2 className="text-xl font-bold text-gray-800 mb-2">View Documentation</h2>
                <p className="text-gray-600 mb-4">Search and browse our SOPs. Ask questions and get relevant sections from our procedures.</p>
                <span className="text-blue-600 font-medium flex items-center gap-2">Start searching <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg></span>
              </button>

              <button onClick={() => setMode('guide')} className="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-green-500 hover:shadow-xl transition-all text-left group">
                <div className="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center mb-6 group-hover:bg-green-500 transition-colors">
                  <svg className="w-8 h-8 text-green-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                  </svg>
                </div>
                <h2 className="text-xl font-bold text-gray-800 mb-2">Guide Me Step-by-Step</h2>
                <p className="text-gray-600 mb-4">Get walked through a procedure one step at a time. Perfect for learning new processes.</p>
                <span className="text-green-600 font-medium flex items-center gap-2">Start a guide <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg></span>
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================
    // HEADER
    // ============================================================
    
    function Header({ onAdminClick, onLogout, sopCount, onBack, title }) {
      return (
        <header className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm">
          <div className="flex items-center gap-3">
            {onBack && <button onClick={onBack} className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg></button>}
            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow">
              <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <div>
              <h1 className="font-semibold text-gray-800">{title || 'SOP Assistant'}</h1>
              <p className="text-xs text-gray-500">CAT Internal Tool{sopCount ? ` • ${sopCount} SOPs` : ''}</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {onAdminClick && <button onClick={onAdminClick} className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="Admin Panel"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>}
            <button onClick={onLogout} className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Logout"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
          </div>
        </header>
      );
    }

    // ============================================================
    // DOCUMENTATION MODE
    // ============================================================
    
    function DocumentationMode({ sops, onBack, onAdminClick, onLogout }) {
      const [messages, setMessages] = useState([{ id: 1, type: 'bot', content: "Hi! I'm here to help you find information in our SOPs. Ask me anything about our procedures.\n\n**Example questions:**\n- How do I receive goods from EU?\n- What's the process for ordering tools?\n- Where can I find the password list?", timestamp: new Date() }]);
      const [inputValue, setInputValue] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const messagesEndRef = useRef(null);

      useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!inputValue.trim() || isTyping) return;
        const userMessage = { id: Date.now(), type: 'user', content: inputValue, timestamp: new Date() };
        setMessages((prev) => [...prev, userMessage]);
        setInputValue('');
        setIsTyping(true);
        try {
          const conversationHistory = [...messages, userMessage].map(m => ({ type: m.type, content: m.content }));
          const response = await GeminiService.chat(conversationHistory, sops, 'documentation');
          setMessages((prev) => [...prev, { id: Date.now() + 1, type: 'bot', content: response, timestamp: new Date() }]);
        } catch (err) {
          setMessages((prev) => [...prev, { id: Date.now() + 1, type: 'bot', content: "Sorry, I encountered an error. Please try again.", timestamp: new Date() }]);
        } finally {
          setIsTyping(false);
        }
      };

      const renderMarkdown = (content) => {
        try { return <div className="prose text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(content) }} />; }
        catch { return <div className="text-sm whitespace-pre-wrap">{content}</div>; }
      };

      return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
          <Header onBack={onBack} onAdminClick={onAdminClick} onLogout={onLogout} title="View Documentation" sopCount={sops.length} />
          <div className="flex-1 overflow-y-auto px-4 py-6">
            <div className="max-w-2xl mx-auto space-y-4">
              {messages.map((message) => (
                <div key={message.id} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] rounded-2xl px-4 py-3 ${message.type === 'user' ? 'bg-blue-500 text-white rounded-br-md' : 'bg-white border border-gray-200 text-gray-800 rounded-bl-md shadow-sm'}`}>
                    {message.type === 'user' ? <div className="text-sm">{message.content}</div> : renderMarkdown(message.content)}
                  </div>
                </div>
              ))}
              {isTyping && <div className="flex justify-start"><div className="bg-white border border-gray-200 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm"><div className="flex gap-1.5"><div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot"></div><div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style={{ animationDelay: '150ms' }}></div><div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style={{ animationDelay: '300ms' }}></div></div></div></div>}
              <div ref={messagesEndRef} />
            </div>
          </div>
          <div className="bg-white border-t border-gray-200 px-4 py-4">
            <form onSubmit={handleSendMessage} className="max-w-2xl mx-auto flex gap-3">
              <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Ask about any procedure..." className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" disabled={isTyping} />
              <button type="submit" disabled={isTyping || !inputValue.trim()} className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-5 py-3 rounded-xl transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button>
            </form>
          </div>
        </div>
      );
    }

    // ============================================================
    // STEP-BY-STEP MODE
    // ============================================================
    
    function StepByStepMode({ sops, onBack, onAdminClick, onLogout }) {
      const [conversationHistory, setConversationHistory] = useState([]);
      const [currentCard, setCurrentCard] = useState(null);
      const [completedSteps, setCompletedSteps] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [inputValue, setInputValue] = useState('');
      const [isStarted, setIsStarted] = useState(false);

      const sendMessage = async (message) => {
        const userMsg = { type: 'user', content: message };
        const newHistory = [...conversationHistory, userMsg];
        setConversationHistory(newHistory);
        setIsLoading(true);
        try {
          const response = await GeminiService.chat(newHistory, sops, 'stepbystep');
          const botMsg = { type: 'bot', content: typeof response === 'string' ? response : JSON.stringify(response) };
          setConversationHistory([...newHistory, botMsg]);
          if (typeof response === 'object') setCurrentCard(response);
          else setCurrentCard({ type: 'text', content: response });
        } catch (err) {
          setCurrentCard({ type: 'error', content: 'Sorry, something went wrong. Please try again.' });
        } finally {
          setIsLoading(false);
        }
      };

      const handleStart = (e) => { e.preventDefault(); if (!inputValue.trim()) return; setIsStarted(true); sendMessage(inputValue); setInputValue(''); };
      const handleNextStep = () => { if (currentCard && currentCard.type === 'step') setCompletedSteps([...completedSteps, currentCard]); sendMessage("Done. What's the next step?"); };
      const handleQuestion = (e) => { e.preventDefault(); if (!inputValue.trim()) return; sendMessage(inputValue); setInputValue(''); };
      const handleOptionSelect = (option) => { sendMessage(option); };
      const handleStartOver = () => { setConversationHistory([]); setCurrentCard(null); setCompletedSteps([]); setIsStarted(false); setInputValue(''); };

      const renderMarkdown = (content) => {
        try { return <div className="prose prose-lg" dangerouslySetInnerHTML={{ __html: marked.parse(content) }} />; }
        catch { return <div className="whitespace-pre-wrap">{content}</div>; }
      };

      if (!isStarted) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50">
            <Header onBack={onBack} onAdminClick={onAdminClick} onLogout={onLogout} title="Step-by-Step Guide" />
            <div className="max-w-2xl mx-auto px-4 py-12">
              <div className="bg-white rounded-3xl shadow-xl p-8 md:p-12">
                <div className="text-center mb-8">
                  <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg className="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                  </div>
                  <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-3">What do you need help with?</h1>
                  <p className="text-gray-600 text-lg">Describe the task you want to complete, and I'll guide you through it step by step.</p>
                </div>
                <form onSubmit={handleStart}>
                  <textarea value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Example: I need to receive a shipment from USA..." className="w-full px-4 py-4 border-2 border-gray-200 rounded-2xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-lg resize-none" rows={3} />
                  <button type="submit" disabled={!inputValue.trim()} className="w-full mt-4 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white py-4 rounded-2xl font-semibold text-lg transition-colors shadow-lg hover:shadow-xl">Start Guide</button>
                </form>
                <div className="mt-8 pt-6 border-t border-gray-100">
                  <p className="text-sm text-gray-500 text-center mb-3">Popular procedures:</p>
                  <div className="flex flex-wrap gap-2 justify-center">
                    {['Receive EU shipment', 'Receive non-EU shipment', 'Create purchase order', 'Request tools'].map((suggestion) => (
                      <button key={suggestion} onClick={() => setInputValue(suggestion)} className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full text-sm transition-colors">{suggestion}</button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 flex flex-col">
          <Header onBack={onBack} onAdminClick={onAdminClick} onLogout={onLogout} title="Step-by-Step Guide" />
          <div className="flex-1 overflow-y-auto px-4 py-6">
            <div className="max-w-2xl mx-auto">
              {currentCard?.type === 'step' && currentCard.totalSteps && (
                <div className="mb-6">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-gray-600">Progress</span>
                    <span className="text-sm font-medium text-green-600">Step {currentCard.stepNumber} of {currentCard.totalSteps}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div className="bg-green-500 h-2 rounded-full transition-all duration-500" style={{ width: `${(currentCard.stepNumber / currentCard.totalSteps) * 100}%` }} />
                  </div>
                </div>
              )}

              {completedSteps.length > 0 && (
                <button onClick={() => setShowHistory(!showHistory)} className="mb-4 flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors">
                  <svg className={`w-4 h-4 transition-transform ${showHistory ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                  View previous steps ({completedSteps.length})
                </button>
              )}

              {showHistory && completedSteps.length > 0 && (
                <div className="mb-6 space-y-3">
                  {completedSteps.map((step, index) => (
                    <div key={index} className="bg-white/50 border border-green-200 rounded-xl p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center"><svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg></div>
                        <span className="font-medium text-gray-700">Step {step.stepNumber}: {step.title}</span>
                      </div>
                      <p className="text-sm text-gray-600 pl-8">{step.content?.substring(0, 100)}...</p>
                    </div>
                  ))}
                </div>
              )}

              {isLoading && (
                <div className="bg-white rounded-3xl shadow-xl p-8 md:p-12 text-center fade-in">
                  <div className="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-gray-600 text-lg">Preparing your next step...</p>
                </div>
              )}

              {!isLoading && currentCard && (
                <div className="bg-white rounded-3xl shadow-xl overflow-hidden fade-in">
                  {currentCard.type === 'step' && (
                    <>
                      <div className="bg-green-500 px-6 py-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white font-bold text-lg">{currentCard.stepNumber}</div>
                          <h2 className="text-xl font-bold text-white">{currentCard.title}</h2>
                        </div>
                      </div>
                      <div className="p-6 md:p-8">
                        <div className="text-gray-700 text-lg leading-relaxed mb-6">{renderMarkdown(currentCard.content)}</div>
                        {currentCard.tip && (
                          <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                            <div className="flex items-start gap-3">
                              <span className="text-2xl">💡</span>
                              <div><p className="font-medium text-amber-800 mb-1">Tip</p><p className="text-amber-700">{currentCard.tip}</p></div>
                            </div>
                          </div>
                        )}
                        <button onClick={handleNextStep} className="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-semibold text-lg transition-colors shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                          Done, next step <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                        </button>
                      </div>
                    </>
                  )}

                  {currentCard.type === 'question' && (
                    <div className="p-6 md:p-8">
                      <div className="text-center mb-6">
                        <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                          <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <h2 className="text-xl font-bold text-gray-800 mb-2">Quick question</h2>
                        <p className="text-gray-600 text-lg">{currentCard.question || currentCard.content}</p>
                      </div>
                      {currentCard.options && currentCard.options.length > 0 ? (
                        <div className="space-y-3">
                          {currentCard.options.map((option, index) => (
                            <button key={index} onClick={() => handleOptionSelect(option)} className="w-full bg-gray-100 hover:bg-blue-50 hover:border-blue-300 border-2 border-gray-200 text-gray-700 py-4 px-6 rounded-xl font-medium text-lg transition-all text-left">{option}</button>
                          ))}
                        </div>
                      ) : (
                        <form onSubmit={handleQuestion}>
                          <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Type your answer..." className="w-full px-4 py-4 border-2 border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-lg" />
                          <button type="submit" disabled={!inputValue.trim()} className="w-full mt-4 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white py-4 rounded-2xl font-semibold text-lg transition-colors">Continue</button>
                        </form>
                      )}
                    </div>
                  )}

                  {currentCard.type === 'complete' && (
                    <div className="p-6 md:p-8 text-center">
                      <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg className="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                      </div>
                      <h2 className="text-2xl font-bold text-gray-800 mb-3">Process Complete! 🎉</h2>
                      <div className="text-gray-600 text-lg mb-6">{renderMarkdown(currentCard.content || "You've successfully completed all the steps.")}</div>
                      <button onClick={handleStartOver} className="bg-green-500 hover:bg-green-600 text-white py-3 px-8 rounded-xl font-semibold transition-colors">Start Another Guide</button>
                    </div>
                  )}

                  {(currentCard.type === 'text' || currentCard.type === 'error') && (
                    <div className="p-6 md:p-8">
                      <div className="text-gray-700 text-lg leading-relaxed mb-6">{renderMarkdown(currentCard.content)}</div>
                      <button onClick={handleNextStep} className="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-semibold text-lg transition-colors">Continue</button>
                    </div>
                  )}
                </div>
              )}

              {!isLoading && currentCard?.type === 'step' && (
                <div className="mt-6">
                  <form onSubmit={handleQuestion} className="bg-white rounded-2xl shadow-lg p-4">
                    <p className="text-sm text-gray-500 mb-2">Have a question about this step?</p>
                    <div className="flex gap-2">
                      <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Ask a question..." className="flex-1 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none" />
                      <button type="submit" disabled={!inputValue.trim()} className="bg-gray-100 hover:bg-gray-200 disabled:bg-gray-50 text-gray-700 px-4 py-3 rounded-xl transition-colors"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button>
                    </div>
                  </form>
                </div>
              )}
            </div>
          </div>

          {isStarted && !isLoading && (
            <div className="bg-white border-t border-gray-200 px-4 py-3">
              <div className="max-w-2xl mx-auto">
                <button onClick={handleStartOver} className="text-gray-500 hover:text-gray-700 text-sm flex items-center gap-1">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                  Start over with a new task
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================================
    // ADMIN PANEL (simplified for brevity)
    // ============================================================
    
    function AdminPanel({ sops, categories, onSopsUpdate, onCategoriesUpdate, onBack, onLogout }) {
      const [showAddForm, setShowAddForm] = useState(false);
      const [editingSop, setEditingSop] = useState(null);
      const [showCategoryManager, setShowCategoryManager] = useState(false);

      const handleDeleteSop = (sopId) => { if (confirm('Delete this SOP?')) onSopsUpdate(sops.filter(s => s.id !== sopId)); };
      const handleSaveSop = (sopData) => {
        if (editingSop) onSopsUpdate(sops.map(s => s.id === editingSop.id ? { ...s, ...sopData, updatedAt: new Date().toISOString() } : s));
        else onSopsUpdate([...sops, { ...sopData, id: `sop-${Date.now()}`, updatedAt: new Date().toISOString() }]);
        setShowAddForm(false); setEditingSop(null);
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <Header onBack={onBack} onLogout={onLogout} title="Admin Panel" />
          <div className="max-w-4xl mx-auto p-6">
            <div className="grid grid-cols-3 gap-4 mb-6">
              <div className="bg-white rounded-xl p-4 border"><div className="text-2xl font-bold">{sops.length}</div><div className="text-sm text-gray-500">Total SOPs</div></div>
              <div className="bg-white rounded-xl p-4 border"><div className="text-2xl font-bold">{categories.length}</div><div className="text-sm text-gray-500">Categories</div></div>
              <div className="bg-white rounded-xl p-4 border"><div className="text-2xl font-bold">{sops.reduce((acc, sop) => acc + (sop.sections?.length || 0), 0)}</div><div className="text-sm text-gray-500">Total Sections</div></div>
            </div>
            <div className="flex gap-3 mb-6">
              <button onClick={() => setShowAddForm(true)} className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2.5 rounded-xl font-medium text-sm">+ Add New SOP</button>
              <button onClick={() => setShowCategoryManager(true)} className="bg-white hover:bg-gray-50 text-gray-700 px-4 py-2.5 rounded-xl font-medium text-sm border">Manage Categories</button>
            </div>
            <div className="bg-white rounded-xl border overflow-hidden">
              <div className="px-4 py-3 bg-gray-50 border-b"><h2 className="font-semibold">Standard Operating Procedures</h2></div>
              <div className="divide-y">
                {sops.map((sop) => (
                  <div key={sop.id} className="px-4 py-4 flex items-center justify-between hover:bg-gray-50">
                    <div><h3 className="font-medium">{sop.title}</h3><div className="flex gap-3 mt-1"><span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">{sop.category}</span><span className="text-xs text-gray-500">{sop.sections?.length || 0} sections</span></div></div>
                    <div className="flex gap-2">
                      <button onClick={() => setEditingSop(sop)} className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg">✏️</button>
                      <button onClick={() => handleDeleteSop(sop.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg">🗑️</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
          {(showAddForm || editingSop) && <SOPFormModal sop={editingSop} categories={categories} onClose={() => { setShowAddForm(false); setEditingSop(null); }} onSave={handleSaveSop} />}
          {showCategoryManager && <CategoryManagerModal categories={categories} onClose={() => setShowCategoryManager(false)} onSave={onCategoriesUpdate} />}
        </div>
      );
    }

    function SOPFormModal({ sop, categories, onClose, onSave }) {
      const [title, setTitle] = useState(sop?.title || '');
      const [category, setCategory] = useState(sop?.category || categories[0]);
      const [content, setContent] = useState(sop?.content || '');
      const [parsedSections, setParsedSections] = useState(sop?.sections || []);
      useEffect(() => { if (content && !sop) { const matches = [...content.matchAll(/^(\d+[A-Za-z]?\.)\s*(.+)/gm)]; setParsedSections(matches.map(m => ({ heading: `${m[1]} ${m[2]}`, content: '' }))); } }, [content]);
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="px-6 py-4 border-b flex items-center justify-between"><h2 className="text-lg font-semibold">{sop ? 'Edit SOP' : 'Add New SOP'}</h2><button onClick={onClose} className="p-2 text-gray-400 hover:text-gray-600">✕</button></div>
            <div className="flex-1 overflow-y-auto p-6 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium mb-2">Title</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full px-4 py-3 border rounded-xl" placeholder="e.g., Goods Receiving" /></div>
                <div><label className="block text-sm font-medium mb-2">Category</label><select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full px-4 py-3 border rounded-xl bg-white">{categories.map((cat) => <option key={cat} value={cat}>{cat}</option>)}</select></div>
              </div>
              <div><label className="block text-sm font-medium mb-2">Content</label><textarea value={content} onChange={(e) => setContent(e.target.value)} className="w-full px-4 py-3 border rounded-xl font-mono text-sm resize-none" rows={15} placeholder="Paste your SOP content here..." /></div>
              {parsedSections.length > 0 && <div><label className="block text-sm font-medium mb-2">Detected Sections ({parsedSections.length})</label><div className="bg-gray-50 rounded-xl p-4 space-y-2 max-h-48 overflow-y-auto">{parsedSections.map((section, i) => <div key={i} className="flex items-center gap-2 text-sm"><span className="w-6 h-6 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center text-xs">{i + 1}</span><span>{section.heading}</span></div>)}</div></div>}
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2.5 text-gray-700 hover:bg-gray-100 rounded-xl">Cancel</button><button onClick={() => onSave({ title, category, content, sections: parsedSections })} disabled={!title.trim() || !content.trim()} className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white px-4 py-2.5 rounded-xl">{sop ? 'Save Changes' : 'Add SOP'}</button></div>
          </div>
        </div>
      );
    }

    function CategoryManagerModal({ categories, onClose, onSave }) {
      const [localCategories, setLocalCategories] = useState([...categories]);
      const [newCategory, setNewCategory] = useState('');
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden">
            <div className="px-6 py-4 border-b flex items-center justify-between"><h2 className="text-lg font-semibold">Manage Categories</h2><button onClick={onClose} className="p-2 text-gray-400">✕</button></div>
            <div className="p-6 space-y-4">
              <div className="flex gap-2"><input type="text" value={newCategory} onChange={(e) => setNewCategory(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && newCategory.trim()) { setLocalCategories([...localCategories, newCategory.trim()]); setNewCategory(''); } }} className="flex-1 px-4 py-2 border rounded-xl" placeholder="New category" /><button onClick={() => { if (newCategory.trim()) { setLocalCategories([...localCategories, newCategory.trim()]); setNewCategory(''); } }} className="bg-blue-500 text-white px-4 py-2 rounded-xl">Add</button></div>
              <div className="space-y-2">{localCategories.map((cat) => <div key={cat} className="flex items-center justify-between bg-gray-50 px-4 py-2 rounded-xl"><span>{cat}</span><button onClick={() => setLocalCategories(localCategories.filter(c => c !== cat))} className="text-gray-400 hover:text-red-600">✕</button></div>)}</div>
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2.5 text-gray-700 hover:bg-gray-100 rounded-xl">Cancel</button><button onClick={() => { onSave(localCategories); onClose(); }} className="bg-blue-500 text-white px-4 py-2.5 rounded-xl">Save</button></div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
